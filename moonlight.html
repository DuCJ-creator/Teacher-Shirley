<!DOCTYPE html>
<html lang="zh-Hant" id="htmlRoot">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ğŸŒ™ æœˆå…‰å¯¶ç›’ | Teacher Shirley</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Exo+2:wght@300;400;500;700&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg: radial-gradient(circle at 50% 15%, #0b1333, #05060d); --surface: rgba(255,255,255,0.06); --surface-2: rgba(255,255,255,0.10); --border: rgba(255,255,255,0.15); --text: #ecf0f1; --text-dim: #b2bec3; --accent: #f1c40f; --accent-2: #7ed6ff; --danger: #ff7675; --good: #55efc4; --glow-soft: 0 0 18px rgba(126,214,255,0.25); --glow-strong: 0 0 28px rgba(241,196,15,0.35); }
    *{box-sizing:border-box;}
    body{ margin:0; min-height:100vh; background:var(--bg); color:var(--text); font-family:'Exo 2','Noto Sans TC',sans-serif; display:flex; flex-direction:column; align-items:center; padding:24px 14px; position:relative; overflow-x:hidden; }
    header{ text-align:center; margin-top:10px; margin-bottom:16px; position:relative; }
    h1{ font-family:'Cinzel Decorative',cursive; font-weight:900; letter-spacing:1px; margin:0 0 6px 0; font-size:clamp(1.6rem,4vw,2.4rem); text-shadow: 0 0 18px rgba(241,196,15,0.45), 0 0 40px rgba(126,214,255,0.25); animation: titleGlow 3.8s ease-in-out infinite alternate; }
    .subtitle{ color:var(--text-dim); font-size:0.95rem; }
    .panel{ width:100%; max-width:860px; background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03)); border:1px solid var(--border); border-radius:18px; padding:18px; box-shadow: 0 15px 40px rgba(0,0,0,0.55), inset 0 0 0 1px rgba(255,255,255,0.03); backdrop-filter: blur(10px) saturate(120%); margin-bottom:14px; position:relative; overflow:hidden; }
    .card{ background:rgba(255,255,255,0.07); border:1px dashed rgba(255,255,255,0.22); border-radius:14px; padding:14px; box-shadow: var(--glow-soft); position:relative; overflow:hidden; }
    .glass-box{ position: relative; border-radius: 20px; padding: 16px; background: linear-gradient(180deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04)); border: 1px solid rgba(255,255,255,0.25); box-shadow: 0 12px 38px rgba(0,0,0,0.62), inset 0 0 0 1px rgba(255,255,255,0.10), inset 0 0 0 8px rgba(255,255,255,0.02), inset 0 0 22px rgba(126,214,255,0.12); backdrop-filter: blur(12px) saturate(155%); overflow: hidden; transition: 0.6s ease; }
    .moon-ui-wrap{ display:flex; justify-content:flex-end; width:100%; position:relative; z-index:1; }
    .moon-ui{ max-width: clamp(280px, 80%, 400px); display:flex; align-items:center; gap:14px; }
    .moon-phase{ font-size:2.9rem; width:52px; text-align:center; filter: drop-shadow(0 0 8px rgba(255,255,255,0.25)) drop-shadow(0 0 18px rgba(126,214,255,0.35)); }
    .progress-wrap{ background:rgba(255,255,255,0.08); border-radius:999px; overflow:hidden; height:12px; border:1px solid var(--border); }
    .progress-bar{ height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2)); transition:width 0.6s ease; }
    .task-list a{ display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-radius:10px; background:rgba(0,0,0,0.25); border:1px solid var(--border); text-decoration:none; color:var(--text); margin-bottom:8px; cursor:pointer; }
    .task-list a.locked{ opacity: .45; filter: grayscale(0.4); pointer-events: none; }
    .start-mission-panel{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; margin:6px auto 14px; position:relative; z-index:2; }
    .start-mission-btn{ padding:10px 18px; font-size:18px; border-radius:999px; border:none; cursor:pointer; background: linear-gradient(135deg,#ffe08a,#ffd36a); box-shadow:0 6px 14px rgba(0,0,0,.18); }
    .redeem-btn{ padding:10px 16px; border-radius:10px; border:none; cursor:pointer; font-weight:800; background:linear-gradient(135deg,#7ed6ff,#ffe08a); color:#071021; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸŒ™ æœˆå…‰å¯¶ç›’</h1>
    <div class="subtitle">Lunar Glow Cache â€” å°ˆæ³¨ç·´ç¿’ â†’ æ”¶é›†æœˆå…‰ â†’ é»äº®æ»¿æœˆå¾ªç’°</div>
  </header>
  <section class="panel">
    <div class="glass-box" id="glass-box">
      <div class="moon-ui-wrap">
        <div class="card moon-ui">
          <div class="moon-phase" id="moon-emoji">ğŸŒ‘</div>
          <div class="moon-stats">
            <div class="stat">ç›®å‰æœˆå…‰é»æ•¸ï¼š<b id="moon-total">0</b> pts</div>
            <div class="stat" id="cycle-progress-stat">æœ¬è¼ªæ»¿æœˆé€²åº¦ï¼š<b id="moon-cycle">0</b> / 300</div>
            <div class="progress-wrap"><div class="progress-bar" id="moon-progress"></div></div>
            <div class="stat">æœˆç›¸éšæ®µï¼š<b id="moon-phase-text">New Moon</b></div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <section class="panel">
    <div class="card">
      <h3>ğŸš€ Lunar Missionsï¼ˆæœˆå…‰ä»»å‹™ï¼‰</h3>
      <div id="startMissionPanel" class="start-mission-panel">
        <button id="startMissionBtn" class="start-mission-btn">ğŸš€ Start Mission</button>
      </div>
      <div class="task-list" id="mission-list"></div>
    </div>
  </section>
  <section class="panel card">
    <h3>ğŸ æœˆå…‰å…Œæ›</h3>
    <div style="display:flex; gap:8px;">
      <select id="redeemAmount" style="flex:1; padding:10px; border-radius:10px;">
        <option value="100">100 pts</option>
        <option value="300">300 pts</option>
      </select>
      <button id="redeemBtn" class="redeem-btn">å…Œæ›æ‰£é™¤</button>
    </div>
  </section>
  <div id="login-hint" style="display:none; color:var(--danger); text-align:center;">è«‹å…ˆå›ä¸»ç«™ç™»å…¥</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyCta1_RddjhYBA437cl8Wg1kGW_bsVimK8", authDomain: "teacher-shirley.firebaseapp.com", projectId: "teacher-shirley" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    setPersistence(auth, browserLocalPersistence);

    const MOON_CYCLE = 300;
    const MISSIONS = [
      { title: "Mission 1: GSATå­¸æ¸¬å­—å½™è€ƒå¤é¡Œ", url: "https://ducj-creator.github.io/Teacher-Shirley/study-tools/GSAT%20Vocab.html" },
      { title: "Mission 2: iVocab å­—å½™é¸æ“‡é¡Œ", url: "https://ivocab-quiz.vercel.app/" },
      { title: "Mission 3: Topic Reading ç´ é¤Šé–±è®€", url: "https://shirley-ai-reading.vercel.app/" },
      { title: "Mission 4: CAPæœƒè€ƒè€ƒå¤é¡Œ", url: "https://ducj-creator.github.io/Teacher-Shirley/tests/CAP%20pastpapers.html" }
    ];

    let currentUser = null;
    let moonData = { totalGlow: 0, cycleGlow: 0, logs: [] };
    let missionStarted = sessionStorage.getItem("missionStarted") === "1";

    function setMissionStarted(v) {
      missionStarted = v;
      sessionStorage.setItem("missionStarted", v ? "1" : "0");
      document.getElementById("startMissionPanel").style.display = v ? "none" : "flex";
      document.querySelectorAll("#mission-list a").forEach(a => a.classList.toggle("locked", !v));
    }

    function renderMissions() {
      const listEl = document.getElementById("mission-list");
      listEl.innerHTML = "";
      MISSIONS.forEach(m => {
        const a = document.createElement("a");
        a.href = m.url;
        a.target = "_blank";
        a.className = "locked";
        a.innerHTML = `<div>${m.title}</div><div class="task-tag">é–‹å•Ÿä»»å‹™</div>`;
        listEl.appendChild(a);
      });
    }

    async function loadMoonData(uid) {
      const snap = await getDoc(doc(db, "users", uid));
      if (snap.exists()) {
        const d = snap.data();
        moonData.totalGlow = d.moonGlowTotal || 0;
        moonData.cycleGlow = moonData.totalGlow % MOON_CYCLE;
        document.getElementById("moon-total").innerText = moonData.totalGlow;
        document.getElementById("moon-progress").style.width = `${(moonData.cycleGlow / MOON_CYCLE) * 100}%`;
      }
    }

    document.getElementById("startMissionBtn").onclick = () => setMissionStarted(true);

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        await loadMoonData(user.uid);
        setMissionStarted(missionStarted);
      } else {
        document.getElementById("login-hint").style.display = "block";
      }
    });

    renderMissions();
  </script>
</body>
</html>
