<!DOCTYPE html>
<html lang="en" id="htmlRoot">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Teacher Shirley's ET Platform</title>

    <!-- libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- fonts -->
   <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
  href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Exo+2:wght@300;400;500;700&family=Noto+Sans+TC:wght@400;600&family=Noto+Serif+TC:wght@400;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Dancing+Script:wght@700&display=swap"
  rel="stylesheet"
/>
    <link
      rel="icon"
      href='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ™</text></svg>'
    />

    <style id="themeStyles">
      .btn-card-action:hover {
  transform: translateY(-3px);
  filter: brightness(1.1);
}
      :root {
  /* existing vars ... */

  /* âœ… Phase 2 add-ons */
  --accent-hover: #a6760a;
  --radius-lg: 16px;
  --radius-md: 12px;
  --radius-sm: 8px;
  --shadow-soft: 0 6px 16px rgba(0,0,0,0.12);
  --shadow-deep: 0 15px 40px rgba(0,0,0,0.5);
  --surface-blur: blur(10px);
}

.dark {
  /* existing vars ... */

  /* âœ… Phase 2 add-ons */
  --accent-hover: #ffd54f;
}
      :root {
        /* --- Light Mode (Morning Mist) --- */
        --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        --surface: rgba(255, 255, 255, 0.9);
        --border: rgba(20, 30, 48, 0.15);
        --text: #1a2a3a;
        --text-light: #485563;
        --accent: #b8860b;
        --orbit-color: rgba(20, 30, 48, 0.2);
        --orbit-glow: none;
        --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        --info-bg: rgba(255, 255, 255, 0.95);
      }

      .dark {
        /* --- Dark Mode (Deep Nebula) --- */
        --bg-gradient: radial-gradient(
          circle at 50% 50%,
          #1b2735 0%,
          #090a0f 100%
        );
        --surface: rgba(30, 40, 55, 0.85);
        --border: rgba(255, 255, 255, 0.15);
        --text: #ecf0f1;
        --text-light: #bdc3c7;
        --accent: #f1c40f;
        --orbit-color: rgba(255, 255, 255, 0.2);
        --orbit-glow: 0 0 10px rgba(255, 255, 255, 0.05);
        --card-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
        --info-bg: rgba(25, 35, 50, 0.85);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: var(--bg-gradient);
        background-attachment: fixed;
        color: var(--text);
        font-family: "Exo 2", "Noto Serif TC", serif;
        line-height: 1.6;
        transition: color 0.5s, background 0.5s;
        min-height: 100vh;
        overflow-x: hidden;
      }

      #particle-canvas {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        pointer-events: none;
      }

      /* ==================== CONTROLS ==================== */
      .top-bar {
        position: absolute;
        top: 1.5rem;
        right: 2rem;
        display: flex;
        gap: 1rem;
        z-index: 2000;
      }

      .control-btn {
        background: var(--surface);
        border: 1px solid var(--border);
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--text);
        font-size: 1.2rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(5px);
      }

      .control-btn:hover {
        transform: scale(1.1);
        color: var(--accent);
        border-color: var(--accent);
      }

      /* ==================== HEADER ==================== */
      header {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem 1rem 0;
        position: relative;
        z-index: 10;
        text-align: center;
      }

      .main-title {
        font-family: "Cinzel Decorative", cursive;
        font-size: clamp(1.8rem, 5vw, 3.5rem);
        font-weight: 700;
        color: var(--text);
        line-height: 1.1;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .dark .main-title {
        color: #ffffff;
        text-shadow: 0 0 25px rgba(241, 196, 15, 0.5);
      }

      .title-underline {
        width: 80px;
        height: 3px;
        background: var(--accent);
        margin: 10px auto;
        border-radius: 2px;
      }

      /* ==================== UNIVERSE VIEW ==================== */
      #universe-view {
        display: none;
        opacity: 0;
        transition: opacity 0.8s ease;
        min-height: 85vh;
        width: 100%;
        position: relative;
        overflow: hidden;
      }

      #universe-view.active {
        display: block;
        opacity: 1;
      }

      .solar-system {
        position: relative;
        width: 100%;
        height: 85vh;
        display: flex;
        justify-content: center;
        align-items: center;
        transform: scale(1);
      }

      .orbit {
        position: absolute;
        border: 1px dashed var(--orbit-color);
        box-shadow: var(--orbit-glow);
        border-radius: 50%;
        top: 50%;
        left: 50%;
        pointer-events: none;
        transition: border-color 0.5s;
      }

      .orbit-1 {
        width: 320px;
        height: 320px;
        margin-top: -160px;
        margin-left: -160px;
        animation: spinOrbit 50s linear infinite;
      }

      .orbit-2 {
        width: 520px;
        height: 520px;
        margin-top: -260px;
        margin-left: -260px;
        animation: spinOrbit 90s linear infinite reverse;
        border-style: dotted;
      }

      .orbit-3 {
        width: 780px;
        height: 780px;
        margin-top: -390px;
        margin-left: -390px;
        animation: spinOrbit 140s linear infinite;
      }

      .mars-container {
        position: absolute;
        width: 320px;
        height: 320px;
        top: 50%;
        left: 50%;
        margin-top: -160px;
        margin-left: -160px;
        animation: spinOrbit 50s linear infinite;
        pointer-events: none;
        z-index: 5;
      }

      .mars-container:hover {
        animation-play-state: paused;
      }

      .mars-wrapper {
        position: absolute;
        width: 60px;
        height: 60px;
        top: -30px;
        left: 50%;
        margin-left: -30px;
        animation: spinCounter 50s linear infinite;
        pointer-events: auto;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .static-planet-wrapper {
        position: absolute;
        z-index: 6;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: transform 0.3s;
      }

      .static-planet-wrapper:hover {
        z-index: 100;
      }

      .static-planet-wrapper:hover .planet-visual {
        transform: scale(1.15);
        transition: transform 0.3s;
      }

      .pos-mercury {
        top: 50%;
        left: 50%;
        transform: translate(-50%, 260px) translate(-50%, -50%);
        margin-top: 30px;
      }

      .pos-saturn {
        top: 50%;
        left: 50%;
        transform: translate(-390px, 0) translate(-50%, -50%);
        margin-left: 20px;
      }

      .pos-jupiter {
        top: 50%;
        left: 50%;
        transform: translate(390px, 0) translate(-50%, -50%);
        margin-left: -20px;
      }

      .moon-wrapper {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .planet-moon {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: radial-gradient(
          circle at 35% 35%,
          #f5f6fa,
          #bdc3c7
        );
        box-shadow: 0 0 50px rgba(255, 255, 255, 0.6),
          inset -10px -10px 30px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.4);
        animation: bounce 2s ease-in-out infinite;
      }

      .planet-visual {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        position: relative;
      }

      .p-mars {
        background: radial-gradient(#e74c3c, #c0392b);
        box-shadow: 0 0 25px rgba(231, 76, 60, 0.6);
      }

      .p-jupiter {
        width: 85px;
        height: 85px;
        background: radial-gradient(#f1c40f, #d35400);
        box-shadow: 0 0 35px rgba(241, 196, 15, 0.6);
      }

      .p-saturn {
        width: 75px;
        height: 75px;
        background: radial-gradient(#f39c12, #e67e22);
        border: 4px double rgba(255, 255, 255, 0.3);
        box-shadow: 0 0 25px rgba(243, 156, 18, 0.4);
      }

      .p-mercury {
        width: 55px;
        height: 55px;
        background: radial-gradient(#dfe6e9, #95a5a6, #2c3e50);
        box-shadow: 0 0 25px rgba(189, 195, 199, 0.7);
      }

      .planet-info {
        position: absolute;
        width: 220px;
        background: var(--info-bg);
        backdrop-filter: blur(15px);
        padding: 12px 15px;
        border-radius: 12px;
        border: 1px solid var(--border);
        text-align: center;
        pointer-events: none;
        box-shadow: var(--card-shadow);
        bottom: 120%;
        left: 50%;
        transform: translateX(-50%);
      }

      .moon-info {
        width: 240px;
        bottom: 130%;
      }

      .p-name {
        font-family: "Cinzel Decorative";
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--text);
        margin-bottom: 4px;
        display: block;
      }

      .p-poem-cn {
        font-family: "Noto Serif TC", serif;
        font-size: 0.85rem;
        color: var(--text);
        line-height: 1.4;
        margin-bottom: 3px;
        font-weight: 600;
      }

      .p-poem-en {
        font-family: "Playfair Display", serif;
        font-size: 0.75rem;
        color: var(--text-light);
        font-style: italic;
        line-height: 1.2;
      }

      .checkin-tag {
        display: block;
        margin-top: 8px;
        background: linear-gradient(90deg, var(--accent), #f39c12);
        color: white;
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 15px;
        font-weight: bold;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
      }

      @keyframes spinOrbit {
        100% {
          transform: rotate(360deg);
        }
      }

      @keyframes spinCounter {
        100% {
          transform: rotate(-360deg);
        }
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-12px);
        }
      }

      @media (max-width: 1024px) {
        .solar-system {
          transform: scale(0.75);
        }
      }

      @media (max-width: 768px) {
        .solar-system {
          transform: scale(0.55);
          height: 70vh;
        }
      }

      @media (max-width: 420px) {
        .solar-system {
          transform: scale(0.42);
        }
        .pos-mercury {
          margin-top: 60px;
        }
      }

      /* ==================== REST OF THE SITE ==================== */
      /* Envelope */
      #intro-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(10px);
        z-index: 5000;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: opacity 1s ease;
      }

      .envelope-container {
        position: relative;
        cursor: pointer;
        width: 320px;
        height: 210px;
        transition: transform 0.5s ease;
        animation: floatEnv 4s ease-in-out infinite;
      }

      .envelope-container:hover {
        transform: scale(1.05);
      }

      .envelope-body {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 100%;
        background: #e6dac8;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        overflow: hidden;
        z-index: 2;
      }

      .envelope-txt {
        position: absolute;
        z-index: 10;
        text-align: center;
        width: 100%;
        top: 55%;
        left: 50%;
        transform: translate(-50%, -50%);
        pointer-events: none;
        padding: 0 10px;
      }

      .env-title {
        font-family: "Cinzel Decorative";
        font-size: 1.1rem;
        color: #5d4037;
        margin-bottom: 5px;
      }

      /* âœ… FIX: font-family typo */
    .env-subtitle {
  font-family: 'Dancing Script', cursive;
  font-size: 1.2rem;
  color: #8d6e63;
  margin-bottom: 15px;
}

      .env-highlight {
        font-family: "Exo 2";
        font-weight: 700;
        color: #c0392b;
        font-size: 0.85rem;
        margin-bottom: 2px;
      }

      .env-cn {
        font-family: "Noto Sans TC";
        font-size: 0.75rem;
        color: #6d4c41;
        font-weight: 500;
      }

      .envelope-flap {
        position: absolute;
        top: 0;
        left: 0;
        width: 0;
        height: 0;
        border-left: 160px solid transparent;
        border-right: 160px solid transparent;
        border-top: 130px solid #dccbb1;
        transform-origin: top;
        transition: transform 0.8s ease 0.2s, z-index 0.2s;
        z-index: 3;
      }

      .envelope-pocket {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 0;
        border-left: 160px solid #f0e6d6;
        border-right: 160px solid #ece0cd;
        border-bottom: 110px solid #f8f1e5;
        border-top: 110px solid transparent;
        z-index: 4;
      }

      .heart-seal {
        position: absolute;
        top: -55px;
        left: -15px;
        font-size: 2rem;
        color: #c0392b;
        animation: heartBeat 1.5s infinite;
      }

      .envelope-container.open .envelope-flap {
        transform: rotateX(180deg);
        z-index: 1;
      }

      .envelope-container.open {
        animation: none;
        transform: scale(1.5);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s 1s, transform 1s;
      }

      @keyframes floatEnv {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-8px);
        }
      }

      @keyframes heartBeat {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.15);
        }
      }

      /* Letter */
      .letter-paper {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        width: 95%;
        max-width: 750px;
        height: auto;
        max-height: 95vh;
        background: radial-gradient(
          circle at 50% 0%,
          #ffffff 10%,
          #f7f4e9 80%
        );
        box-shadow: 0 0 60px rgba(0, 0, 0, 0.6),
          inset 0 0 40px rgba(255, 255, 255, 0.8),
          inset 0 0 10px rgba(212, 175, 55, 0.1);
        padding: 2.5rem 3rem;
        opacity: 0;
        pointer-events: none;
        transition: all 0.8s ease 0.8s;
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
      }

      .letter-paper::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("https://ducj-creator.github.io/Teacher-Shirley/assets/Shirley.png");
        background-size: cover;
        background-position: center;
        filter: blur(6px) grayscale(20%);
        opacity: 0.1;
        z-index: 0;
        pointer-events: none;
      }

      .sparkle-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
        overflow: hidden;
      }

      .sparkle {
        position: absolute;
        width: 4px;
        height: 4px;
        background: rgba(212, 175, 55, 0.6);
        border-radius: 50%;
        box-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
        animation: floatSparkle 4s infinite linear;
      }

      .sparkle:nth-child(1) {
        top: 10%;
        left: 20%;
        animation-duration: 3s;
      }
      .sparkle:nth-child(2) {
        top: 30%;
        left: 80%;
        animation-duration: 5s;
      }
      .sparkle:nth-child(3) {
        top: 60%;
        left: 10%;
        animation-duration: 4s;
      }

      @keyframes floatSparkle {
        0% {
          opacity: 0;
        }
        50% {
          opacity: 1;
          transform: translateY(-20px) scale(1.2);
        }
        100% {
          transform: translateY(-40px) scale(0);
          opacity: 0;
        }
      }

      .letter-paper.show {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
        pointer-events: auto;
      }

      .letter-content {
        position: relative;
        z-index: 2;
        color: #2c3e50;
        font-family: "Playfair Display", serif;
      }

      .letter-p {
        margin-bottom: 0.8rem;
        font-size: 1.05rem;
        line-height: 1.5;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.6s ease;
        text-align: justify;
      }

      .letter-p.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .cn-text {
        display: block;
        font-family: "Noto Sans TC";
        font-size: 0.95rem;
        color: #7f8c8d;
        margin-top: 2px;
        line-height: 1.4;
      }

      .signature {
        text-align: right;
        font-family: "Dancing Script", cursive;
        font-size: 1.5rem;
        margin: 1rem 0;
        color: var(--accent);
      }

      .choice-area {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
        opacity: 0;
        transition: opacity 1s ease 0.5s;
      }

      .choice-area.visible {
        opacity: 1;
      }

      .btn-letter {
        padding: 8px 20px;
        border-radius: 25px;
        border: none;
        font-family: "Exo 2";
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 140px;
      }

      .btn-visitor {
        background: transparent;
        border: 1px solid #8d6e63;
        color: #5d4037;
      }

      .btn-visitor:hover {
        background: rgba(141, 110, 99, 0.1);
      }

      .btn-login {
        background: var(--accent);
        color: white;
        border: 1px solid var(--accent);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      }

      .btn-login:hover { background: var(--accent-hover); transform: translateY(-2px); }

      #auth-form-container {
        display: none;
        margin-top: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ddd;
      }

      .google-btn {
        width: 100%;
        padding: 10px;
        background: white;
        color: #555;
        border-radius: 6px;
        border: 1px solid #ddd;
        cursor: pointer;
        font-weight: bold;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .input-group input {
        width: 100%;
        padding: 8px;
        margin-bottom: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        font-family: "Exo 2";
      }

      .email-btn {
        width: 100%;
        padding: 8px;
        background: #2c3e50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      /* Views */
      #visitor-view {
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease;
        padding-bottom: 5rem;
      }

      #visitor-view.active {
        display: block;
        opacity: 1;
      }

      .categories {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 2rem;
        padding: 0 2rem;
        max-width: 1000px;
        margin: 0 auto;
        position: relative;
        z-index: 5;
      }

      .category-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 2.5rem 1.5rem;
        text-align: center;
        text-decoration: none;
        color: var(--text);
        transition: all 0.4s;
        box-shadow: var(--card-shadow);
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .category-card:hover {
        transform: translateY(-8px);
        border-color: var(--accent);
      }

      .icon {
        font-size: 3rem;
        margin-bottom: 1rem;
      }

      /* Member Terminal */
      #member-terminal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.95);
        width: 90%;
        max-width: 900px;
        max-height: 85vh;
        overflow-y: auto;
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 2.5rem;
        z-index: 200;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
        display: none;
        opacity: 0;
        transition: all 0.3s;
        backdrop-filter: blur(10px);
      }

      #member-terminal.show {
        display: block;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }

      .close-terminal {
        position: absolute;
        top: 20px;
        right: 25px;
        font-size: 1.5rem;
        cursor: pointer;
      }

      .member-dashboard {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 2rem;
        margin-top: 1rem;
      }

      @media (max-width: 800px) {
        .member-dashboard {
          grid-template-columns: 1fr;
        }
      }

      .profile-panel {
        background: rgba(0, 0, 0, 0.02);
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
        border: 1px solid var(--border);
      }

      .streak-ring {
        width: 110px;
        height: 110px;
        border: 5px solid var(--accent);
        border-radius: 50%;
        margin: 0 auto 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .streak-num {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--accent);
      }

      .data-card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 2rem;
      }

      .word-card {
        border-left: 5px solid #3498db;
      }

      .quote-card {
        border-left: 5px solid #f1c40f;
        margin-top: 1rem;
      }

      .checkin-btn {
        width: 100%;
        padding: 14px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
        margin-top: 15px;
      }

      .checkin-btn:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }

      /* Print Modal Styles */
      #print-selection-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 5000;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
      }

      .print-modal-content {
        background: white;
        width: 90%;
        max-width: 700px;
        border-radius: 12px;
        padding: 25px;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
        color: #333;
      }

      .print-modal-header {
        font-family: "Cinzel Decorative";
        font-size: 1.5rem;
        color: #2c3e50;
        border-bottom: 2px solid var(--accent);
        padding-bottom: 10px;
        margin-bottom: 15px;
        text-align: center;
      }

      .print-controls {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
      }

      .selection-list {
        flex-grow: 1;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 20px;
        max-height: 400px;
      }

      .log-item-row {
        display: flex;
        align-items: center;
        padding: 8px 5px;
        border-bottom: 1px solid #eee;
        transition: background 0.2s;
      }

      .log-item-row:hover {
        background: #f1f2f6;
      }

      .log-item-row input[type="checkbox"] {
        margin-right: 15px;
        transform: scale(1.2);
        cursor: pointer;
      }

      .log-details {
        display: flex;
        flex-direction: column;
        font-size: 0.9rem;
      }

      .log-time {
        font-size: 0.8rem;
        color: #666;
        font-family: "Exo 2";
      }

      .log-action {
        font-weight: 600;
        color: #2c3e50;
      }

      .print-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .action-btn {
        padding: 10px 25px;
        border-radius: 20px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        font-family: "Exo 2";
        transition: all 0.2s;
      }

      .btn-cancel {
        background: #95a5a6;
        color: white;
      }

      .btn-confirm {
        background: var(--accent);
        color: white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }

      .btn-confirm:hover {
        transform: scale(1.05);
      }

      .print-only {
        display: none;
      }

      @media print {
        body * {
          visibility: hidden;
        }

        #print-area,
        #print-area * {
          visibility: visible;
        }

        #print-area {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          color: black;
          background: white;
          padding: 20px;
        }

        .print-only {
          display: block;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
        }

        th,
        td {
          border: 1px solid #333;
          padding: 10px;
          text-align: left;
        }

        th {
          background: #f0f0f0;
        }
      }

      .highlight-box {
        display: inline-block;
        font-weight: 900;
        font-style: italic;
        color: #5d4037;
        border: 2px solid var(--accent);
        border-radius: 8px;
        padding: 5px 12px;
        margin: 5px 0;
        background: rgba(255, 255, 255, 0.6);
        box-shadow: 3px 3px 0px rgba(184, 134, 11, 0.2);
        text-decoration: underline;
        text-decoration-style: wavy;
        text-decoration-thickness: 1.5px;
        line-height: 1.6;
      }

      .highlight-box .key-term {
        color: #c0392b;
        text-decoration: none;
        border-bottom: 2px solid #c0392b;
      }

      /* --- In-App Browser Warning Overlay --- */
      #in-app-browser-warning {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        color: white;
        padding: 30px;
      }

      .warning-icon {
        font-size: 3rem;
        margin-bottom: 15px;
      }

      .warning-title {
        font-size: 1.4rem;
        font-weight: bold;
        margin-bottom: 15px;
        font-family: "Exo 2", sans-serif;
      }

      .warning-text {
        font-size: 1rem;
        line-height: 1.6;
        margin-bottom: 25px;
        color: #ddd;
        max-width: 500px;
      }

      .arrow-hint {
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 3rem;
        animation: bounceRight 1.5s infinite;
        color: var(--accent);
      }

      @keyframes bounceRight {
        0%,
        100% {
          transform: translateX(0);
        }
        50% {
          transform: translateX(-10px);
        }
      }

      .warning-actions {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 100%;
        max-width: 300px;
      }

      .btn-warning {
        padding: 12px;
        border: none;
        border-radius: 25px;
        font-weight: bold;
        font-family: "Exo 2";
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .btn-copy {
        background: #3498db;
        color: white;
      }

      .btn-close-warning {
        background: transparent;
        border: 1px solid #7f8c8d;
        color: #bdc3c7;
      }

      /* ==================== NEW MOON CARD STYLES ==================== */
      #card-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 6000;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.4s ease;
      }

      #card-modal.active {
        display: flex;
        opacity: 1;
      }

      .card-overlay-bg {
        position: absolute;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
      }

      .card-display-container {
        position: relative;
        z-index: 2;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        transform: scale(0.9);
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      #card-modal.active .card-display-container {
        transform: scale(1);
      }

      /* --- core card --- */
      .moon-card {
        width: 360px;
        min-height: 580px;
        background: var(--card-bg, #1a1a2e);
        border: 2px solid var(--card-border, #4a4e69);
        border-radius: 20px;
        padding: 30px 25px;
        color: var(--card-text, #e0e1dd);
        position: relative;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5),
          inset 0 0 60px rgba(0, 0, 0, 0.2);
        font-family: "Exo 2", sans-serif;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid
          var(--card-accent-dim, rgba(255, 255, 255, 0.2));
        padding-bottom: 15px;
        margin-bottom: 20px;
      }

      .card-title {
        font-family: "Cinzel Decorative";
        font-weight: 900;
        font-size: 0.9rem;
        letter-spacing: 1px;
        color: var(--card-accent, #c9d1d9);
        text-transform: uppercase;
      }

      .card-serial {
        font-family: "Exo 2";
        font-size: 0.7rem;
        color: var(--card-text-dim, #778ca3);
        letter-spacing: 1px;
      }

      .card-greeting {
        font-family: "Playfair Display";
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--card-highlight, #fff);
        line-height: 1.2;
        margin-bottom: 5px;
      }

      .card-subtitle {
        font-family: "Noto Serif TC";
        font-size: 0.85rem;
        color: var(--card-text-dim, #a0a0a0);
        font-style: italic;
        margin-bottom: 15px;
      }

      .card-divider {
        text-align: center;
        color: var(--card-accent, #ffd700);
        font-size: 1.2rem;
        margin: 15px 0;
        opacity: 0.7;
      }

      .card-content-box {
        text-align: center;
        margin-bottom: 20px;
      }

      .card-label {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--card-accent, #ffd700);
        margin-bottom: 5px;
        opacity: 0.8;
      }

      .card-wotd {
        font-family: "Playfair Display";
        font-size: 2.2rem;
        font-weight: 700;
        color: var(--card-highlight, #fff);
        text-shadow: 0 2px 10px rgba(255, 255, 255, 0.2);
        line-height: 1;
        margin-bottom: 5px;
      }

      .card-pos {
        font-family: "Exo 2";
        font-size: 0.8rem;
        background: var(--card-accent-dim, rgba(255, 255, 255, 0.1));
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        margin-bottom: 8px;
      }

      .card-def {
        font-family: "Noto Serif TC";
        font-size: 1rem;
        color: var(--card-text, #ddd);
        line-height: 1.4;
        font-weight: 600;
      }

      .card-sentence-container {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px dashed
          var(--card-accent-dim, rgba(255, 255, 255, 0.1));
      }

      .card-sent-en {
        font-family: "Exo 2";
        font-style: italic;
        font-size: 0.9rem;
        color: var(--card-text-dim, #ccc);
        margin-bottom: 5px;
        line-height: 1.3;
        font-weight: 500;
      }

      .card-sent-cn {
        font-family: "Noto Serif TC";
        font-size: 0.85rem;
        color: var(--card-text-dim, #888);
        opacity: 0.8;
      }

      .card-quote-box {
        position: relative;
        padding: 15px;
        border-left: 3px solid var(--card-accent, #ffd700);
        background: linear-gradient(
          90deg,
          var(--card-accent-dim, rgba(255, 255, 255, 0.05)),
          transparent
        );
        margin-top: auto;
      }

      .card-quote-text {
        font-family: "Playfair Display";
        font-style: italic;
        font-size: 1rem;
        line-height: 1.5;
        color: var(--card-text, #eee);
      }

      .card-quote-trans {
        font-family: "Noto Serif TC", serif;
        font-size: 0.9rem;
        color: var(--card-text-dim, #ccc);
        margin-top: 8px;
        font-style: normal;
        line-height: 1.4;
        opacity: 0.9;
      }

      .card-quote-author {
        text-align: right;
        font-size: 0.8rem;
        font-weight: bold;
        margin-top: 8px;
        color: var(--card-accent, #ffd700);
      }

      .card-footer {
        margin-top: 25px;
        padding-top: 15px;
        border-top: 1px solid
          var(--card-accent-dim, rgba(255, 255, 255, 0.2));
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .card-streak-badge {
        background: var(--card-accent, #ffd700);
        color: var(--card-bg, #000);
        padding: 5px 12px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.8rem;
        box-shadow: 0 0 10px
          var(--card-accent-dim, rgba(255, 215, 0, 0.4));
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .card-signature {
        font-family: "Dancing Script";
        font-size: 1.5rem;
        color: var(--card-text-dim, #aaa);
        transform: rotate(-5deg);
      }

      .card-watermark {
        position: absolute;
        bottom: 10px;
        right: 20px;
        font-size: 4rem;
        font-weight: 900;
        color: rgba(255, 255, 255, 0.03);
        pointer-events: none;
        z-index: 0;
        font-family: "Cinzel Decorative";
        white-space: nowrap;
      }

      .card-shine {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          125deg,
          transparent 40%,
          rgba(255, 255, 255, 0.05) 45%,
          transparent 50%
        );
        pointer-events: none;
      }

      .card-actions {
        display: flex;
        gap: 15px;
        margin-top: 15px;
      }

      .btn-card-action {
        padding: 10px 20px;
        border-radius: 25px;
        border: none;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
        font-family: "Exo 2";
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
      }

      .btn-download {
        background: linear-gradient(90deg, #b8860b, #f1c40f);
        color: #2c3e50;
        box-shadow: 0 4px 15px rgba(241, 196, 15, 0.3);
      }

      .btn-close {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      /* Calendar hint */
      .calendar-day-checked {
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .calendar-day-checked:hover::after {
        content: "ğŸƒ";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }
    </style>
  </head>

  <body>
    <!-- in-app browser warning -->
    <div id="in-app-browser-warning">
      <div class="arrow-hint">â†—</div>
      <div class="warning-icon">âš ï¸</div>
      <div class="warning-title">Sign-in Restricted<br />ç™»å…¥å—é™</div>
      <div class="warning-text">
        Google Login is blocked inside Line/WeChat/FB.<br />
        Please open this page in <strong>Chrome</strong> or
        <strong>Safari</strong> to log in. <br /><br />
        æ­¤æ‡‰ç”¨ç¨‹å¼ä¸æ”¯æ´ Google ç™»å…¥ã€‚<br />
        è«‹é»æ“Šå³ä¸Šè§’é¸å–®ï¼Œé¸æ“‡<strong>ã€Œåœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿã€</strong>ï¼Œæˆ–è¤‡è£½é€£çµè‡³
        Chrome/Safari é–‹å•Ÿã€‚
      </div>

      <div class="warning-actions">
        <button class="btn-warning btn-copy" onclick="copyCurrentUrl()">
          ğŸ“‹ Copy Link / è¤‡è£½é€£çµ
        </button>
        <button class="btn-warning btn-close-warning" onclick="closeWarning()">
          Cancel & Stay as Visitor<br />æš«ä¸ç™»å…¥ï¼Œç¹¼çºŒåƒè§€
        </button>
      </div>
    </div>

    <canvas id="particle-canvas"></canvas>

    <!-- audio -->
    <audio
      id="themeSong"
      src="https://ducj-creator.github.io/Teacher-Shirley/assets/theme%20song.mp3"
      preload="auto"
    ></audio>
    <audio
      id="windchime"
      src="https://ducj-creator.github.io/Teacher-Shirley/assets/windchime.mp3"
      preload="auto"
    ></audio>

    <!-- top controls -->
    <div class="top-bar">
      <div id="themeToggle" class="control-btn" title="Toggle Theme">ğŸŒ“</div>
      <div id="musicToggle" class="control-btn" title="Music">ğŸµ</div>
      <div
        id="logoutBtn"
        class="control-btn"
        title="Logout"
        style="display: none"
      >
        ğŸšª
      </div>
    </div>

    <!-- header -->
    <header>
      <div class="title-container">
        <h1 class="main-title">Teacher Shirleyâ€™s<br />ET Platform</h1>
        <div class="title-underline"></div>
      </div>
    </header>

    <!-- intro overlay -->
    <div id="intro-overlay">
      <div class="envelope-container" onclick="openLetter()">
        <div class="envelope-body"></div>
        <div class="envelope-txt">
          <div class="env-title">Welcome Message</div>
          <div class="env-subtitle">from Teacher Shirley</div>
          <div class="env-highlight">
            Welcome to my ET Platform<br />Ready for launch! ğŸš€
          </div>
          <div class="env-cn">æ­¡è¿ä¾†åˆ°æˆ‘çš„ ET æœˆå°ï¼Œæº–å‚™å‡ºç™¼å›‰ï¼</div>
        </div>
        <div class="envelope-pocket"></div>
        <div class="envelope-flap"><div class="heart-seal">ğŸ’—</div></div>
      </div>

      <div class="letter-paper" id="letter-view">
        <div class="sparkle-overlay">
          <div class="sparkle"></div>
          <div class="sparkle"></div>
          <div class="sparkle"></div>
          <div class="sparkle"></div>
          <div class="sparkle"></div>
        </div>

        <div class="letter-content">
          <div class="letter-p">
            <strong>Hi there! ğŸ‘‹</strong> Iâ€™m Shirleyâ€”an English teacher who
            believes learning should be joyful, interactive, and full of â€œaha!â€
            moments.
            <span class="cn-text"
              >æˆ‘æ˜¯ Shirleyâ€”â€”ä¸€ä½ç›¸ä¿¡å­¸ç¿’æ‡‰è©²å……æ»¿æ¨‚è¶£ã€äº’å‹•ï¼Œä¸¦æ™‚å¸¸è¿¸ç™¼ã€Œå•Šå“ˆï¼ã€éˆæ„Ÿçš„è‹±æ–‡è€å¸«ã€‚</span
            >
          </div>

          <div class="letter-p">
            This teaching-and-learning platform is your free, ad-free toolkitâ€”carefully
            crafted from years of real classroom experience and student feedback.
            <span class="cn-text"
              >é€™å€‹æ•™èˆ‡å­¸å¹³å°æ˜¯æ‚¨å…è²»ã€ç„¡å»£å‘Šçš„å­¸ç¿’å·¥å…·ç®±â€”â€”æºè‡ªå¤šå¹´çœŸå¯¦èª²å ‚ç¶“é©—èˆ‡å­¸ç”Ÿå›é¥‹ã€‚</span
            >
          </div>

          <div class="letter-p">
            Whether youâ€™re a teacher looking for ready-to-use activities or an
            English learner eager to practice anytime, anywhere, youâ€™re welcome
            to explore all tools and content freely as a visitor.
            <span class="cn-text"
              >ä¸è«–æ‚¨æ˜¯å°‹æ‰¾ç¾æˆæ•™å­¸æ´»å‹•çš„è€å¸«ï¼Œé‚„æ˜¯æƒ³éš¨æ™‚éš¨åœ°ç·´ç¿’è‹±æ–‡çš„å­¸ç¿’è€…ï¼Œéƒ½æ­¡è¿ä»¥è¨ªå®¢èº«ä»½è‡ªç”±ä½¿ç”¨æ‰€æœ‰è³‡æºã€‚</span
            >
          </div>

          <div
            class="letter-p"
            style="
              background: rgba(212, 175, 55, 0.1);
              padding: 15px;
              border-radius: 10px;
              margin-top: 10px;
            "
          >
            If you log in, each day youâ€™ll receive: âœ¨â€œWord of the Dayâ€, â€œBilingual
            Quoteâ€, and unlock your <br />
            <span class="highlight-box">Shirley's Moon Base Card</span> <br />
            to <span style="text-decoration: underline">track daily check-ins</span>,
            <span style="text-decoration: underline">build streaks</span>, and map
            your journey.

            <div
              class="cn-text"
              style="color: #5d4037; margin-top: 8px; line-height: 1.8"
            >
              è‹¥æ‚¨é¸æ“‡ç™»å…¥ï¼Œæ¯å¤©èƒ½ç²å¾—âœ¨ã€Œæ¯æ—¥å–®å­—ã€èˆ‡ã€Œæ¯æ—¥ä½³å¥ã€ï¼Œæ›´å¯å•Ÿç”¨
              <span class="highlight-box">
                <span class="key-term">Shirley è€å¸«å°ˆå±¬çš„ã€ŒæœˆçƒåŸºåœ°å¡ã€</span>
              </span>
              â€”â€”<span style="border-bottom: 1px solid #5d4037">è¨˜éŒ„æ‰“å¡</span>ã€<span
                style="border-bottom: 1px solid #5d4037"
                >ç´¯ç©å¤©æ•¸</span
              >èˆ‡<span style="border-bottom: 1px solid #5d4037">æ¢ç´¢è»Œè·¡</span>ã€‚
            </div>
          </div>

          <div class="letter-p">
            I highly encourage you to check in every dayâ€”consistency turns small
            efforts into big results, and learning is a journey of steady persistence
            and joyful discovery.
            <span class="cn-text"
              >æˆ‘èª æ‘¯é¼“å‹µæ‚¨æ¯æ—¥æ‰“å¡â€”â€”æŒä¹‹ä»¥æ†ï¼Œå¾®å°çš„åŠªåŠ›çµ‚å°‡é–‹èŠ±çµæœï¼›å­¸ç¿’æ˜¯ä¸€å ´éœ€è¦å …æŒï¼Œä¹Ÿå……æ»¿æ¨‚è¶£èˆ‡é©šå–œçš„æ—…ç¨‹ã€‚</span
            >
          </div>

          <div class="signature">â€” Teacher Shirley</div>

          <div class="choice-area" id="choice-buttons">
            <button class="btn-letter btn-visitor" onclick="enterVisitorMode()">
              <span>ğŸ›¸ Visitor Mode</span>
              <span style="font-size: 0.7rem; font-weight: normal"
                >è¨ªå®¢åƒè§€ (ç„¡ç´€éŒ„)</span
              >
            </button>

            <button class="btn-letter btn-login" onclick="showAuthForm()">
              <span>ğŸš€ Log In</span>
              <span style="font-size: 0.7rem; font-weight: normal"
                >ç™»å…¥ / è¨»å†Š</span
              >
            </button>
          </div>

          <div id="auth-form-container">
            <h4
              style="
                margin-bottom: 10px;
                text-align: center;
                color: var(--text);
              "
            >
              Log In / ç™»å…¥
            </h4>

            <button id="google-login-btn" class="google-btn">
              <svg width="18" height="18" viewBox="0 0 18 18">
                <path
                  fill="#4285F4"
                  d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"
                />
                <path
                  fill="#34A853"
                  d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z"
                />
                <path
                  fill="#FBBC05"
                  d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"
                />
                <path
                  fill="#EA4335"
                  d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.159 6.656 3.58 9 3.58z"
                />
              </svg>
              Google Login
            </button>

            <div style="text-align: center; font-size: 0.8rem; margin: 5px 0">
              â€” OR â€”
            </div>

            <div class="input-group">
              <input type="email" id="email-input" placeholder="Email" />
              <input type="password" id="pass-input" placeholder="Password" />
            </div>

            <button class="email-btn" id="email-login-btn">Log In</button>

            <div
              style="
                margin-top: 8px;
                text-align: center;
                font-size: 0.8rem;
                cursor: pointer;
                text-decoration: underline;
              "
              onclick="hideAuthForm()"
            >
              Cancel
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- visitor view -->
    <div id="visitor-view">
      <div
        style="
          text-align: center;
          margin-bottom: 2rem;
          color: var(--text-light);
          background: rgba(255, 255, 255, 0.5);
          padding: 10px;
          border-radius: 20px;
          display: inline-block;
          position: relative;
          left: 50%;
          transform: translateX(-50%);
        "
      >
        Currently in <strong>Visitor Mode</strong>.
        <button
          onclick="reopenAuth()"
          style="
            margin-left: 10px;
            background: var(--accent);
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Exo 2';
          "
        >
          Log in? ğŸš€
        </button>
      </div>

      <div class="categories">
        <a href="/Teacher-Shirley/teaching-tools/" class="category-card">
          <span class="icon">ğŸ</span>
          <h2>Teaching Tools</h2>
          <div class="subtitle">å¸«å¸«ç™¾å¯¶ç®±</div>
        </a>

        <a
          href="https://ducj-creator.github.io/Teacher-Shirley/study-tools/index.html"
          class="category-card"
        >
          <span class="icon">ğŸª</span>
          <h2>Study Tools</h2>
          <div class="subtitle">å­¸å­¸æ™ºè¶£é–£</div>
        </a>

        <a href="/Teacher-Shirley/amusement-park/" class="category-card">
          <span class="icon">ğŸª</span>
          <h2>Amusement Park</h2>
          <div class="subtitle">æ¨‚æ¨‚å¬‰éŠè°·</div>
        </a>

        <a href="/Teacher-Shirley/external-resources/" class="category-card">
          <span class="icon">ğŸ”—</span>
          <h2>External Resources</h2>
          <div class="subtitle">æºæºé€£çµåº«</div>
        </a>
      </div>
    </div>

    <!-- universe view -->
    <div id="universe-view">
      <div class="solar-system">
        <div class="orbit orbit-1"></div>
        <div class="orbit orbit-2"></div>
        <div class="orbit orbit-3"></div>

        <div class="mars-container">
          <div
            class="mars-wrapper"
            onclick="visitPlanet('Mars', '/Teacher-Shirley/teaching-tools/')"
          >
            <div class="planet-visual p-mars"></div>
            <div class="planet-info">
              <span class="p-name">Mars ğŸ”´</span>
              <div class="p-poem-cn">
                åœ¨ç«æ˜Ÿç‡ƒèµ·æ˜Ÿç«<br />æ–¼è¬›å°åŒ–ä½œæ™¨å…‰
              </div>
              <div class="p-poem-en">
                Upon Mars, kindle starlight; on the lectern, dawnlight blooms.
              </div>
            </div>
          </div>
        </div>

        <div
          class="static-planet-wrapper pos-mercury"
          onclick="visitPlanet('Mercury', '/Teacher-Shirley/external-resources/')"
        >
          <div class="planet-visual p-mercury"></div>
          <div class="planet-info">
            <span class="p-name">Mercury âšª</span>
            <div class="p-poem-cn">
              åœ¨æ°´æ˜Ÿæ”¬ç›¡æ˜Ÿèª<br />æ–¼å¾®å…‰çµæˆæ©‹æ¨‘
            </div>
            <div class="p-poem-en">
              Upon Mercury, catch star-words; in glimmers, weave a bridge.
            </div>
          </div>
        </div>

        <div
          class="static-planet-wrapper pos-jupiter"
          onclick="visitPlanet('Jupiter', 'https://ducj-creator.github.io/Teacher-Shirley/study-tools/index.html')"
        >
          <div class="planet-visual p-jupiter"></div>
          <div class="planet-info">
            <span class="p-name">Jupiter ğŸŸ¡</span>
            <div class="p-poem-cn">
              åœ¨æœ¨æ˜Ÿæ¶µç´æ˜Ÿæ²³<br />æ–¼æ›¸é é•·å‡ºæ–°èŠ½
            </div>
            <div class="p-poem-en">
              Upon Jupiter, gather star-rivers; in pages, sprouts unfold.
            </div>
          </div>
        </div>

        <div
          class="static-planet-wrapper pos-saturn"
          onclick="visitPlanet('Saturn', '/Teacher-Shirley/amusement-park/')"
        >
          <div class="planet-visual p-saturn"></div>
          <div class="planet-info">
            <span class="p-name">Saturn ğŸŸ </span>
            <div class="p-poem-cn">
              åœ¨åœŸæ˜Ÿæ—‹èˆå…‰ç’°<br />æ–¼ç¬‘èªæ‹¾å¾—ç ç’£
            </div>
            <div class="p-poem-en">
              Upon Saturn, spin the rings; in laughter, catch bright pearls.
            </div>
          </div>
        </div>

        <div class="moon-wrapper" onclick="openMemberTerminal()">
          <div class="planet-moon"></div>
          <div class="planet-info moon-info">
            <span class="p-name">Moon ğŸŒ•</span>
            <div class="p-poem-cn">
              åœ¨æœˆä¹‹æš—é¢æ²‰æ€<br />æ–¼æœˆä¹‹æ˜é¢æˆé•·
            </div>
            <div class="p-poem-en">
              In the moonâ€™s shadow, ponder. In its light, grow.
            </div>
            <span class="checkin-tag">Tap to Check-in: ğŸŒ•åŸºåœ°æ‰“å¡</span>
          </div>
        </div>
      </div>

      <div
        style="
          position: absolute;
          bottom: 20px;
          width: 100%;
          text-align: center;
          color: var(--text-light);
          font-size: 0.75rem;
          font-style: italic;
        "
      >
        Explore the galaxy to find your learning path.
      </div>
    </div>

    <!-- member terminal -->
    <div id="member-terminal">
      <div class="close-terminal" onclick="closeMemberTerminal()">âœ•</div>

      <h3
        id="greeting-name"
        style="
          font-family: 'Cinzel Decorative';
          color: var(--accent);
          text-align: center;
          margin-bottom: 1rem;
        "
      >
        Welcome to Moon Base
      </h3>

      <div class="member-dashboard">
        <div class="profile-panel">
          <div class="streak-ring">
            <div class="streak-num" id="streak-days">0</div>
            <div style="font-size: 0.7rem">Days Streak</div>
          </div>

          <div style="margin-bottom: 1rem; font-size: 0.9rem">
            Total Check-ins: <strong id="total-days">0</strong>
          </div>

          <div
            id="calendar-grid"
            style="
              display: grid;
              grid-template-columns: repeat(7, 1fr);
              gap: 3px;
              font-size: 0.7rem;
              margin-bottom: 10px;
            "
          ></div>

          <!-- âœ… card bag -->
          <div style="margin-top: 12px; text-align: left">
            <div
              style="
                font-size: 0.8rem;
                font-weight: bold;
                margin-bottom: 6px;
                color: var(--text-light);
              "
            >
              ğŸƒ Card Bag / å¡è¢‹æ”¶è—
            </div>
            <div id="card-bag-list"></div>
          </div>

          <button
            id="checkin-btn"
            class="checkin-btn"
            onclick="handleCheckIn()"
          >
            Daily Check-in
          </button>

          <div
            style="
              margin-top: 1rem;
              cursor: pointer;
              text-decoration: underline;
              font-size: 0.8rem;
              color: var(--text-light);
            "
            onclick="openPrintSelection()"
          >
            ğŸ–¨ï¸ Print Learning Log
          </div>
        </div>

        <div class="content-panel">
          <div class="data-card word-card">
            <span
              style="
                font-size: 0.7rem;
                text-transform: uppercase;
                color: var(--text-light);
                letter-spacing: 1px;
              "
            >
              Word of the Day <span id="word-date"></span>
            </span>

            <div
              style="
                display: flex;
                gap: 10px;
                align-items: baseline;
                margin-top: 5px;
              "
            >
              <span class="the-word" id="wotd-word">Wait...</span>
              <span
                id="wotd-pos"
                style="
                  background: var(--accent);
                  color: white;
                  padding: 1px 6px;
                  border-radius: 4px;
                  font-size: 0.75rem;
                "
              ></span>
            </div>

            <div
              id="wotd-meaning"
              style="
                font-family: 'Noto Sans TC';
                font-weight: bold;
                color: var(--accent);
                margin: 5px 0;
                font-size: 1.1rem;
              "
            ></div>

            <div
              id="wotd-ipa"
              style="
                font-style: italic;
                color: var(--text-light);
                font-size: 0.9rem;
                margin-bottom: 10px;
              "
            ></div>

            <div
              style="
                background: rgba(0, 0, 0, 0.03);
                padding: 10px;
                border-radius: 8px;
              "
            >
              <div id="wotd-sentence-e" style="font-style: italic; margin-bottom: 4px"></div>
              <div
                id="wotd-sentence-c"
                style="font-size: 0.9rem; color: var(--text-light)"
              ></div>
            </div>
          </div>

          <div class="data-card quote-card">
            <span
              style="
                font-size: 0.7rem;
                text-transform: uppercase;
                color: var(--text-light);
                letter-spacing: 1px;
              "
              >Daily Quote</span
            >

            <div
              id="qotd-text"
              style="
                font-family: 'Playfair Display';
                font-size: 1.3rem;
                margin: 15px 0;
                line-height: 1.4;
              "
            ></div>

            <div
              id="qotd-trans"
              style="font-size: 0.95rem; color: var(--text-light)"
            ></div>

            <div
              id="qotd-author"
              style="
                text-align: right;
                font-weight: bold;
                color: var(--accent);
                margin-top: 10px;
              "
            ></div>
          </div>
        </div>
      </div>
    </div>
<!-- Moonlight Box Embed START -->
<section id="moonlight-embed" class="moonlight-embed">
  <iframe
    id="moonlightFrame"
    src="https://ducj-creator.github.io/Teacher-Shirley/moonlight.html"
    title="Moonlight Box"
    loading="lazy"
    frameborder="0"
    allow="clipboard-read; clipboard-write"
  ></iframe>
</section>
<!-- Moonlight Box Embed END -->

    <!-- card modal -->
    <div id="card-modal">
      <div class="card-overlay-bg" onclick="closeCardModal()"></div>

      <div class="card-display-container">
        <div id="collectible-card" class="moon-card">
          <div class="card-decoration-top"></div>

          <div class="card-header">
            <div class="card-title">MOON BASE CLEARANCE</div>
            <div class="card-serial">
              NO. <span id="card-date-serial"></span>
            </div>
          </div>

          <div class="card-body">
            <div class="card-greeting">
              Welcome, <span id="card-user-name">Traveler</span>
            </div>

            <div class="card-subtitle">
              This is your Shirley's Moon Base Card for
              <span id="card-display-date"></span>
            </div>

            <div class="card-divider">âœ¦ âœ¦ âœ¦</div>

            <div class="card-content-box">
              <div class="card-label">Word of the Day</div>
              <div class="card-wotd" id="card-wotd"></div>
              <div class="card-pos" id="card-pos"></div>
              <div class="card-def" id="card-def"></div>

              <div class="card-sentence-container">
                <div id="card-sent-en" class="card-sent-en"></div>
                <div id="card-sent-cn" class="card-sent-cn"></div>
              </div>
            </div>

            <div class="card-quote-box">
              <div class="card-quote-text" id="card-quote"></div>
              <div class="card-quote-trans" id="card-quote-trans"></div>
              <div class="card-quote-author" id="card-author"></div>
            </div>
          </div>

          <div class="card-footer">
            <div class="card-streak-badge">
              <span class="badge-icon">ğŸ”¥</span> Streak:
              <span id="card-streak"></span>
            </div>
            <div class="card-signature">Teacher Shirley</div>
          </div>

          <div class="card-watermark">MOON BASE</div>
          <div class="card-shine"></div>
        </div>

        <div class="card-actions">
          <button class="btn-card-action btn-download" onclick="downloadCardImage()">
            ğŸ“¥ Download Image (æ”¶è—)
          </button>
          <button class="btn-card-action btn-close" onclick="closeCardModal()">
            âœ• Close (æ”¾å…¥å¡è¢‹)
          </button>
        </div>
      </div>
    </div>

    <!-- print modal -->
    <div id="print-selection-modal">
      <div class="print-modal-content">
        <div class="print-modal-header">Select Records to Print</div>

        <div class="print-controls">
          <button
            onclick="toggleAllLogs(true)"
            style="
              background: none;
              border: none;
              cursor: pointer;
              color: var(--accent);
              font-weight: bold;
            "
          >
            â˜‘ Select All
          </button>

          <button
            onclick="toggleAllLogs(false)"
            style="
              background: none;
              border: none;
              cursor: pointer;
              color: #7f8c8d;
              font-weight: bold;
            "
          >
            â˜ Clear All
          </button>
        </div>

        <div class="selection-list" id="log-selection-list"></div>

        <div class="print-actions">
          <button class="action-btn btn-cancel" onclick="closePrintSelection()">
            Cancel
          </button>
          <button class="action-btn btn-confirm" onclick="confirmPrint()">
            ğŸ–¨ï¸ Print / Save PDF
          </button>
        </div>
      </div>
    </div>

    <!-- print area -->
    <div id="print-area" class="print-only">
      <div
        class="print-header"
        style="
          text-align: center;
          border-bottom: 2px solid black;
          margin-bottom: 20px;
          padding-bottom: 10px;
        "
      >
        <h1>My Learning Journey</h1>
        <p>
          Student: <span id="print-name"></span> | Date:
          <span id="print-date"></span>
        </p>
      </div>

      <table id="print-table">
        <thead>
          <tr>
            <th style="width: 25%">Time / Duration</th>
            <th style="width: 20%">Activity Type</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="print-body"></tbody>
      </table>

      <div style="margin-top: 20px; font-size: 0.8rem; text-align: center">
        Generated from Teacher Shirley's ET Platform
      </div>
    </div>
.moonlight-embed{
  width: 100%;
  max-width: 520px;   /* ä½ æƒ³è¦çš„å€å¡Šå¯¬åº¦ï¼Œå¯èª¿ */
  margin: 12px auto 0;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 8px 24px rgba(0,0,0,.18);
  background: rgba(255,255,255,.04);
  backdrop-filter: blur(6px);
}

/* è®“ iframe æœ¬é«”åƒæ»¿å®¹å™¨ */
.moonlight-embed iframe{
  width: 100%;
  height: 680px;      /* å…ˆçµ¦å›ºå®šé«˜ï¼Œç¨å¾Œå¯åšè‡ªå‹•é«˜åº¦ */
  border: none;
  display: block;
}

    <!-- footer -->
    <footer
      class="page-footer"
      style="
        margin-top: 3rem;
        padding: 2rem;
        text-align: center;
        font-size: 0.8rem;
        color: var(--text-light);
        opacity: 0.6;
      "
    >
      <div>Â©ï¸ Teacher Shirleyâ€˜s ET Platform 2025</div>
      <span id="busuanzi_container_site_pv"
        >Total Visits: <span id="busuanzi_value_site_pv"></span
      ></span>
    </footer>

    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import {
    getAuth,
    signInWithPopup,
    GoogleAuthProvider,
    signOut,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    updateDoc,
    arrayUnion
  } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

      const THEMES = {
  1: {
    bg: "linear-gradient(180deg, #0f2027, #203a43, #2c5364)",
    border: "#b8860b",
    accent: "#ffd700",
    highlight: "#fff",
    text: "#e0e0e0",
    textDim: "#8fa1b3",
    accentDim: "rgba(184, 134, 11, 0.2)"
  },
  2: {
    bg: "linear-gradient(135deg, #2c3e50, #4ca1af)",
    border: "#bdc3c7",
    accent: "#ecf0f1",
    highlight: "#fff",
    text: "#ecf0f1",
    textDim: "#bdc3c7",
    accentDim: "rgba(255, 255, 255, 0.2)"
  },
  3: {
    bg: "radial-gradient(circle at 10% 20%, #240b36, #c31432)",
    border: "#ffafbd",
    accent: "#ffc3a0",
    highlight: "#fff0f5",
    text: "#ffe4e1",
    textDim: "#d8bfd8",
    accentDim: "rgba(255, 175, 189, 0.2)"
  },
  4: {
    bg: "#121212",
    border: "#333",
    accent: "#fff",
    highlight: "#fff",
    text: "#ccc",
    textDim: "#666",
    accentDim: "rgba(255, 255, 255, 0.1)"
  },
  5: {
    bg: "linear-gradient(to bottom, #141e30, #243b55)",
    border: "#f1c40f",
    accent: "#f39c12",
    highlight: "#fff",
    text: "#ecf0f1",
    textDim: "#95a5a6",
    accentDim: "rgba(241, 196, 15, 0.15)"
  },
  6: {
    bg: "linear-gradient(to top, #304352, #d7d2cc)",
    border: "#7f8c8d",
    accent: "#2c3e50",
    highlight: "#2c3e50",
    text: "#1a252f",
    textDim: "#546e7a",
    accentDim: "rgba(0, 0, 0, 0.1)"
  },
  7: {
    bg: "linear-gradient(160deg, #4b134f, #190a05)",
    border: "#c0392b",
    accent: "#e74c3c",
    highlight: "#fff",
    text: "#fdcb6e",
    textDim: "#fab1a0",
    accentDim: "rgba(231, 76, 60, 0.2)"
  },
  8: {
    bg: "linear-gradient(to right, #00416a, #799f0c, #ffe000)",
    border: "#a8ff78",
    accent: "#78ffd6",
    highlight: "#fff",
    text: "#f0f0f0",
    textDim: "#a8e063",
    accentDim: "rgba(120, 255, 214, 0.2)"
  },
  9: {
    bg: "linear-gradient(to bottom, #3e2b14, #2c1e0e)",
    border: "#d4af37",
    accent: "#c5a059",
    highlight: "#f3e5ab",
    text: "#e6d2b5",
    textDim: "#8b7355",
    accentDim: "rgba(212, 175, 55, 0.2)"
  },
  10: {
    bg: "radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%)",
    border: "rgba(255, 255, 255, 0.4)",
    accent: "#fff",
    highlight: "#fff",
    text: "#fff",
    textDim: "rgba(255, 255, 255, 0.6)",
    accentDim: "rgba(255, 255, 255, 0.1)"
  },
  11: {
    bg: "linear-gradient(45deg, #111, #222)",
    border: "#0ff",
    accent: "#0ff",
    highlight: "#fff",
    text: "#eee",
    textDim: "#0aa",
    accentDim: "rgba(0, 255, 255, 0.2)",
    fxClass: "theme-fx-11"
  },

  12: {
    bg: "linear-gradient(180deg, #1cb5e0 0%, #000851 100%)",
    border: "#89f7fe",
    accent: "#66a6ff",
    highlight: "#fff",
    text: "#e2f0f9",
    textDim: "#89f7fe",
    accentDim: "rgba(137, 247, 254, 0.2)"
  },
  13: {
    bg: "linear-gradient(45deg, #81fbb8 0%, #28c76f 100%)",
    border: "#fff",
    accent: "#0f4c2e",
    highlight: "#e0ffd4",
    text: "#082015",
    textDim: "#1e5c3e",
    accentDim: "rgba(255, 255, 255, 0.3)"
  },
  14: {
    bg: "linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)",
    border: "#ff6f91",
    accent: "#ff80bf",
    highlight: "#fff",
    text: "#5e2c3a",
    textDim: "#965f70",
    accentDim: "rgba(255, 111, 145, 0.2)"
  },
  15: {
    bg: "linear-gradient(to right, #654ea3, #eaafc8)",
    border: "#ffd700",
    accent: "#ffd700",
    highlight: "#fff",
    text: "#fff",
    textDim: "#e0c3fc",
    accentDim: "rgba(255, 215, 0, 0.2)"
  },
  16: {
    bg: "linear-gradient(to top, #ff0844 0%, #ffb199 100%)",
    border: "#520000",
    accent: "#8b0000",
    highlight: "#fff",
    text: "#520000",
    textDim: "#941818",
    accentDim: "rgba(82, 0, 0, 0.1)"
  },
  17: {
    bg: "linear-gradient(180deg, #0f0c29, #302b63, #24243e)",
    border: "#00f260",
    accent: "#0575e6",
    highlight: "#00f260",
    text: "#00f260",
    textDim: "#0575e6",
    accentDim: "rgba(0, 242, 96, 0.15)"
  },
  18: {
    bg: "linear-gradient(to right, #d7d2cc 0%, #304352 100%)",
    border: "#5d4037",
    accent: "#8d6e63",
    highlight: "#3e2723",
    text: "#1a1a1a",
    textDim: "#4e342e",
    accentDim: "rgba(93, 64, 55, 0.1)"
  },
  19: {
    bg: "linear-gradient(to bottom, #093028, #237a57)",
    border: "#43cca1",
    accent: "#43cca1",
    highlight: "#fff",
    text: "#d4fc79",
    textDim: "#96e6a1",
    accentDim: "rgba(67, 204, 161, 0.2)"
  },
  20: {
    bg: "linear-gradient(120deg, #f6d365 0%, #fda085 100%)",
    border: "#fff",
    accent: "#d35400",
    highlight: "#fff",
    text: "#d35400",
    textDim: "#e67e22",
    accentDim: "rgba(255, 255, 255, 0.4)"
  },
  21: {
    bg: "linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%)",
    border: "#7f8c8d",
    accent: "#2c3e50",
    highlight: "#bdc3c7",
    text: "#2c3e50",
    textDim: "#7f8c8d",
    accentDim: "rgba(44, 62, 80, 0.1)"
  },
  22: {
    bg: "linear-gradient(to right, #fff1eb 0%, #ace0f9 100%)",
    border: "#b76e79",
    accent: "#b76e79",
    highlight: "#fff",
    text: "#5e3b42",
    textDim: "#b76e79",
    accentDim: "rgba(183, 110, 121, 0.2)"
  },
  23: {
    bg: "#111",
    border: "#ff00de",
    accent: "#00ffea",
    highlight: "#fff",
    text: "#fff",
    textDim: "#ff00de",
    accentDim: "rgba(255, 0, 222, 0.2)",
    fxClass: "theme-fx-23"
  },
  24: {
    bg: "linear-gradient(to bottom, #c06c84, #6c5b7b, #355c7d)",
    border: "#f8b195",
    accent: "#f67280",
    highlight: "#fff",
    text: "#fff",
    textDim: "#f8b195",
    accentDim: "rgba(248, 177, 149, 0.2)"
  },
  25: {
    bg: "linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)",
    border: "#fff",
    accent: "#6a11cb",
    highlight: "#fff",
    text: "#4a00e0",
    textDim: "#8e2de2",
    accentDim: "rgba(255, 255, 255, 0.5)"
  },
  26: {
    bg: "linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%)",
    border: "#2d6a4f",
    accent: "#1b4332",
    highlight: "#fff",
    text: "#081c15",
    textDim: "#2d6a4f",
    accentDim: "rgba(45, 106, 79, 0.2)"
  },
  27: {
    bg: "linear-gradient(to right, #ffecd2 0%, #fcb69f 100%)",
    border: "#ff6b6b",
    accent: "#ff6b6b",
    highlight: "#fff",
    text: "#c0392b",
    textDim: "#e17055",
    accentDim: "rgba(255, 107, 107, 0.2)"
  },
  28: {
    bg: "#2d3436",
    border: "#dfe6e9",
    accent: "#fd79a8",
    highlight: "#fff",
    text: "#dfe6e9",
    textDim: "#b2bec3",
    accentDim: "rgba(255, 255, 255, 0.1)",
    fxClass: "theme-fx-28"
  },
  29: {
    bg: "linear-gradient(to bottom, #ffffff, #dcdcdc)",
    border: "#000",
    accent: "#c0392b",
    highlight: "#000",
    text: "#000",
    textDim: "#555",
    accentDim: "rgba(0, 0, 0, 0.1)"
  },

  30: {
    bg: "linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%)",
    border: "#d7d7d7",
    accent: "#b0b0b0",
    highlight: "#fff",
    text: "#2c3e50",
    textDim: "#7f8c8d",
    accentDim: "rgba(0, 0, 0, 0.05)"
  },
  31: {
    bg: "linear-gradient(to bottom right, #051937, #004d40)",
    border: "#00897b",
    accent: "#26a69a",
    highlight: "#b2dfdb",
    text: "#e0f2f1",
    textDim: "#80cbc4",
    accentDim: "rgba(38, 166, 154, 0.2)"
  },
  32: {
    bg: "radial-gradient(circle at top right, #360033, #0b8793)",
    border: "#d1c4e9",
    accent: "#e1bee7",
    highlight: "#fff",
    text: "#fff",
    textDim: "#b39ddb",
    accentDim: "rgba(225, 190, 231, 0.15)"
  },
  33: {
    bg: "linear-gradient(160deg, #002244, #001122)",
    border: "#1565c0",
    accent: "#42a5f5",
    highlight: "#fff",
    text: "#e3f2fd",
    textDim: "#90caf9",
    accentDim: "rgba(66, 165, 245, 0.2)"
  },
  34: {
    bg: "linear-gradient(to bottom, #4a0000, #2b0000)",
    border: "#b71c1c",
    accent: "#ff5252",
    highlight: "#ffcdd2",
    text: "#ffebee",
    textDim: "#ef9a9a",
    accentDim: "rgba(255, 82, 82, 0.2)"
  },
  35: {
    bg: "linear-gradient(45deg, #141e30, #243b55)",
    border: "#00bcd4",
    accent: "#00e5ff",
    highlight: "#e0f7fa",
    text: "#eceff1",
    textDim: "#607d8b",
    accentDim: "rgba(0, 229, 255, 0.1)"
  },
  36: {
    bg: "linear-gradient(to right, #b46105, #5e3100)",
    border: "#ffca28",
    accent: "#ffd54f",
    highlight: "#fff8e1",
    text: "#fff",
    textDim: "#ffecb3",
    accentDim: "rgba(255, 213, 79, 0.2)"
  },
  37: {
    bg: "linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%)",
    border: "#aab7b8",
    accent: "#78909c",
    highlight: "#fff",
    text: "#455a64",
    textDim: "#90a4ae",
    accentDim: "rgba(120, 144, 156, 0.1)"
  },
  38: {
    bg: "linear-gradient(to bottom, #1d2b25, #0f1612)",
    border: "#69f0ae",
    accent: "#b9f6ca",
    highlight: "#fff",
    text: "#e8f5e9",
    textDim: "#81c784",
    accentDim: "rgba(105, 240, 174, 0.1)"
  },
  39: {
    bg: "linear-gradient(to right, #4b3832, #2c1e18)",
    border: "#cd7f32",
    accent: "#d7a877",
    highlight: "#fff",
    text: "#f5deb3",
    textDim: "#a1887f",
    accentDim: "rgba(205, 127, 50, 0.2)"
  },

  40: {
    bg: "#1c2329",
    border: "#4a6fa5",
    accent: "#90caf9",
    highlight: "#e3f2fd",
    text: "#eceff1",
    textDim: "#78909c",
    accentDim: "rgba(144, 202, 249, 0.1)"
  },
  41: {
    bg: "linear-gradient(180deg, #1a2980 0%, #26d0ce 100%)",
    border: "#81d4fa",
    accent: "#4dd0e1",
    highlight: "#e0f7fa",
    text: "#e1f5fe",
    textDim: "#80deea",
    accentDim: "rgba(77, 208, 225, 0.2)"
  },
  42: {
    bg: "linear-gradient(to right, #ffecd2 0%, #fcb69f 100%)",
    border: "#ffab91",
    accent: "#ff8a65",
    highlight: "#fff",
    text: "#5d4037",
    textDim: "#a1887f",
    accentDim: "rgba(255, 138, 101, 0.2)"
  },
  43: {
    bg: "linear-gradient(to bottom, #c06c84, #6c5b7b, #355c7d)",
    border: "#f8b195",
    accent: "#ffccbc",
    highlight: "#fff",
    text: "#fff",
    textDim: "#ffab91",
    accentDim: "rgba(248, 177, 149, 0.2)"
  },
  44: {
    bg: "linear-gradient(to top, #2c3e50, #4ca1af)",
    border: "#80cbc4",
    accent: "#b2dfdb",
    highlight: "#e0f2f1",
    text: "#e0f7fa",
    textDim: "#80deea",
    accentDim: "rgba(178, 223, 219, 0.1)"
  },
  45: {
    bg: "linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%)",
    border: "#9fa8da",
    accent: "#7986cb",
    highlight: "#fff",
    text: "#303f9f",
    textDim: "#5c6bc0",
    accentDim: "rgba(121, 134, 203, 0.2)"
  },
  46: {
    bg: "linear-gradient(to right, #434343 0%, #000000 100%)",
    border: "#757575",
    accent: "#bdbdbd",
    highlight: "#fff",
    text: "#f5f5f5",
    textDim: "#9e9e9e",
    accentDim: "rgba(255, 255, 255, 0.1)"
  },
  47: {
    bg: "linear-gradient(to right, #d31027, #ea384d)",
    border: "#ff8a80",
    accent: "#ff5252",
    highlight: "#ffebee",
    text: "#fff",
    textDim: "#ffcdd2",
    accentDim: "rgba(255, 82, 82, 0.2)"
  },
  48: {
    bg: "linear-gradient(to top, #accbee 0%, #e7f0fd 100%)",
    border: "#90caf9",
    accent: "#64b5f6",
    highlight: "#fff",
    text: "#1565c0",
    textDim: "#64b5f6",
    accentDim: "rgba(33, 150, 243, 0.1)"
  },
  49: {
    bg: "linear-gradient(135deg, #134e5e, #71b280)",
    border: "#a5d6a7",
    accent: "#c8e6c9",
    highlight: "#e8f5e9",
    text: "#f1f8e9",
    textDim: "#a5d6a7",
    accentDim: "rgba(165, 214, 167, 0.2)"
  },

  50: {
    bg: "linear-gradient(to bottom, #eee4d6, #dccdb6)",
    border: "#c5a065",
    accent: "#bfa068",
    highlight: "#fff",
    text: "#5d4037",
    textDim: "#8d6e63",
    accentDim: "rgba(197, 160, 101, 0.2)"
  },
  51: {
    bg: "repeating-linear-gradient(45deg,#111,#111 10px,#222 10px,#222 20px)",
    border: "#333",
    accent: "#e74c3c",
    highlight: "#fff",
    text: "#eee",
    textDim: "#777",
    accentDim: "rgba(231, 76, 60, 0.3)"
  },
  52: {
    bg: "linear-gradient(#3e2723, #281a16)",
    border: "#8d6e63",
    accent: "#d7ccc8",
    highlight: "#efebe9",
    text: "#d7ccc8",
    textDim: "#a1887f",
    accentDim: "rgba(141, 110, 99, 0.2)"
  },
  53: {
    bg: "linear-gradient(to bottom, #1a237e, #0d1245)",
    border: "#7986cb",
    accent: "#c5cae9",
    highlight: "#fff",
    text: "#e8eaf6",
    textDim: "#9fa8da",
    accentDim: "rgba(197, 202, 233, 0.1)"
  },
  54: {
    bg: "linear-gradient(135deg, #e6b9b8, #c68a88)",
    border: "#fff",
    accent: "#8e5856",
    highlight: "#fff0f0",
    text: "#4e342e",
    textDim: "#8d6e63",
    accentDim: "rgba(255, 255, 255, 0.4)"
  },
  55: {
    bg: "linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%)",
    border: "#757575",
    accent: "#616161",
    highlight: "#fff",
    text: "#212121",
    textDim: "#616161",
    accentDim: "rgba(0, 0, 0, 0.1)"
  },
  56: {
    bg: "#121212",
    border: "#2c2c2c",
    accent: "#666",
    highlight: "#444",
    text: "#bbb",
    textDim: "#444",
    accentDim: "rgba(255, 255, 255, 0.05)"
  },
  57: {
    bg: "linear-gradient(to bottom, #000428, #004e92)",
    border: "#d500f9",
    accent: "#00e5ff",
    highlight: "#fff",
    text: "#fff",
    textDim: "#d500f9",
    accentDim: "rgba(213, 0, 249, 0.2)"
  },
  58: {
    bg: "linear-gradient(to bottom, #fffff0, #f0f0e0)",
    border: "#dcdcdc",
    accent: "#a9a9a9",
    highlight: "#fff",
    text: "#333",
    textDim: "#888",
    accentDim: "rgba(0, 0, 0, 0.03)"
  },
  59: {
    bg: "linear-gradient(180deg, #232526 0%, #414345 100%)",
    border: "#585858",
    accent: "#d32f2f",
    highlight: "#757575",
    text: "#e0e0e0",
    textDim: "#616161",
    accentDim: "rgba(211, 47, 47, 0.2)"
  },

  60: {
    bg: "linear-gradient(to bottom, #f5f5f5, #cfd9df)",
    border: "#212121",
    accent: "#424242",
    highlight: "#000",
    text: "#000",
    textDim: "#616161",
    accentDim: "rgba(0, 0, 0, 0.1)"
  },
  61: {
    bg: "#fff",
    border: "#1565c0",
    accent: "#0d47a1",
    highlight: "#e3f2fd",
    text: "#0d47a1",
    textDim: "#64b5f6",
    accentDim: "rgba(13, 71, 161, 0.1)",
    fxClass: "theme-fx-61"
  },
  62: {
    bg: "#fff8e1",
    border: "#d7ccc8",
    accent: "#8d6e63",
    highlight: "#fff",
    text: "#5d4037",
    textDim: "#a1887f",
    accentDim: "rgba(141, 110, 99, 0.1)"
  },
  63: {
    bg: "linear-gradient(to right, #3e5151, #decba4)",
    border: "#8d6e63",
    accent: "#d7ccc8",
    highlight: "#fff",
    text: "#fff",
    textDim: "#efebe9",
    accentDim: "rgba(255, 255, 255, 0.2)"
  },
  64: {
    bg: "radial-gradient(circle, #444, #000)",
    border: "#fff",
    accent: "#eee",
    highlight: "#fff",
    text: "#fff",
    textDim: "#aaa",
    accentDim: "rgba(255, 255, 255, 0.1)"
  },
  65: {
    bg: "linear-gradient(to bottom, #2b5876, #4e4376)",
    border: "#ffccbc",
    accent: "#ffab91",
    highlight: "#fff",
    text: "#fff",
    textDim: "#b39ddb",
    accentDim: "rgba(255, 171, 145, 0.2)"
  },
  66: {
    bg: "#1c1c1c",
    border: "#d4af37",
    accent: "#f1c40f",
    highlight: "#fff",
    text: "#d4af37",
    textDim: "#8e7d48",
    accentDim: "rgba(212, 175, 55, 0.15)",
    fxClass: "theme-fx-66"
  },
  67: {
    bg: "#f0f0f0",
    border: "#d32f2f",
    accent: "#1976d2",
    highlight: "#ffeb3b",
    text: "#212121",
    textDim: "#757575",
    accentDim: "rgba(25, 118, 210, 0.1)"
  },
  68: {
    bg: "linear-gradient(to right, #cc2b5e, #753a88)",
    border: "#00d2ff",
    accent: "#3a7bd5",
    highlight: "#fff",
    text: "#fff",
    textDim: "#eaafc8",
    accentDim: "rgba(0, 210, 255, 0.2)"
  },
  69: {
    bg: "linear-gradient(45deg, #85ffbd 0%, #ffffb0 100%)",
    border: "#009688",
    accent: "#00796b",
    highlight: "#fff",
    text: "#004d40",
    textDim: "#4db6ac",
    accentDim: "rgba(0, 121, 107, 0.1)"
  },

  70: {
    bg: "radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%)",
    border: "#3f51b5",
    accent: "#7986cb",
    highlight: "#fff",
    text: "#e8eaf6",
    textDim: "#5c6bc0",
    accentDim: "rgba(121, 134, 203, 0.1)"
  },
  71: {
    bg: "linear-gradient(to right, #ff512f, #dd2476)",
    border: "#ffcc80",
    accent: "#ffe0b2",
    highlight: "#fff",
    text: "#fff",
    textDim: "#ffab91",
    accentDim: "rgba(255, 204, 128, 0.2)"
  },
  72: {
    bg: "linear-gradient(to bottom, #20002c, #cbb4d4)",
    border: "#e1bee7",
    accent: "#fff",
    highlight: "#fff",
    text: "#fff",
    textDim: "#ba68c8",
    accentDim: "rgba(225, 190, 231, 0.2)"
  },
  73: {
    bg: "linear-gradient(to bottom, #f83600 0%, #f9d423 100%)",
    border: "#fff59d",
    accent: "#ffeb3b",
    highlight: "#fff",
    text: "#fff",
    textDim: "#fff9c4",
    accentDim: "rgba(255, 235, 59, 0.2)"
  },
  74: {
    bg: "radial-gradient(circle, #000000, #434343)",
    border: "#fff",
    accent: "#fff",
    highlight: "#fff",
    text: "#fff",
    textDim: "#666",
    accentDim: "rgba(255, 255, 255, 0.05)",
    fxClass: "theme-fx-74"
  },
  75: {
    bg: "linear-gradient(to left, #89f7fe, #66a6ff)",
    border: "#fff",
    accent: "#fff",
    highlight: "#fff",
    text: "#01579b",
    textDim: "#0288d1",
    accentDim: "rgba(255, 255, 255, 0.3)"
  },
  76: {
    bg: "linear-gradient(to bottom, #870000, #190a05)",
    border: "#ff5722",
    accent: "#ffab91",
    highlight: "#fff",
    text: "#ffccbc",
    textDim: "#bf360c",
    accentDim: "rgba(255, 87, 34, 0.2)"
  },
  77: {
    bg: "#0f2027",
    border: "#fff",
    accent: "#fff",
    highlight: "#fff",
    text: "#fff",
    textDim: "#cfd8dc",
    accentDim: "rgba(255, 255, 255, 0.1)",
    fxClass: "theme-fx-77"
  },
  78: {
    bg: "radial-gradient(circle at 50% 0, #5c5c5c, #000000)",
    border: "#f5f5f5",
    accent: "#e0e0e0",
    highlight: "#fff",
    text: "#fff",
    textDim: "#9e9e9e",
    accentDim: "rgba(255, 255, 255, 0.1)"
  },
  79: {
    bg: "#2c3e50",
    border: "#f1c40f",
    accent: "#f39c12",
    highlight: "#fff",
    text: "#ecf0f1",
    textDim: "#95a5a6",
    accentDim: "rgba(241, 196, 15, 0.1)"
  },

  80: {
    bg: "linear-gradient(to right, #8e9eab, #eef2f3)",
    border: "#78909c",
    accent: "#546e7a",
    highlight: "#fff",
    text: "#263238",
    textDim: "#607d8b",
    accentDim: "rgba(84, 110, 122, 0.1)"
  },
  81: {
    bg: "linear-gradient(to bottom, #d7d2cc, #304352)",
    border: "#90a4ae",
    accent: "#cfd8dc",
    highlight: "#fff",
    text: "#eceff1",
    textDim: "#b0bec5",
    accentDim: "rgba(207, 216, 220, 0.1)"
  },
  82: {
    bg: "linear-gradient(147deg, #f71735 0%, #db3445 74%)",
    border: "#ff8a80",
    accent: "#ffcdd2",
    highlight: "#fff",
    text: "#fff",
    textDim: "#ef9a9a",
    accentDim: "rgba(255, 205, 210, 0.2)"
  },
  83: {
    bg: "linear-gradient(to right, #243949 0%, #517fa4 100%)",
    border: "#b3e5fc",
    accent: "#81d4fa",
    highlight: "#fff",
    text: "#e1f5fe",
    textDim: "#81d4fa",
    accentDim: "rgba(129, 212, 250, 0.1)"
  },
  84: {
    bg: "linear-gradient(90deg, #111 50%, #eee 50%)",
    border: "#888",
    accent: "#888",
    highlight: "#f00",
    text: "#888",
    textDim: "#aaa",
    accentDim: "rgba(136, 136, 136, 0.2)"
  },
  85: {
    bg: "linear-gradient(43deg,#4158d0 0%,#c850c0 46%,#ffcc70 100%)",
    border: "#fff",
    accent: "#fff",
    highlight: "#fff",
    text: "#fff",
    textDim: "#ffe0b2",
    accentDim: "rgba(255, 255, 255, 0.3)"
  },

  86: {
    bg: "linear-gradient(135deg, #141414 0%, #333 100%)",
    border: "#ffd700",
    accent: "#ffecb3",
    highlight: "#fff",
    text: "#ffd700",
    textDim: "#bf953f",
    accentDim: "rgba(255, 215, 0, 0.3)",
    fxClass: "theme-fx-86"
  },
  87: {
    bg: "radial-gradient(circle at 50% 50%, #2b1055, #7597de)",
    border: "rgba(255, 255, 255, 0.5)",
    accent: "#fff",
    highlight: "#fff",
    text: "#fff",
    textDim: "rgba(255, 255, 255, 0.8)",
    accentDim: "rgba(255, 255, 255, 0.2)",
    fxClass: "theme-fx-87"
  },
  88: {
    bg: "linear-gradient(45deg,#ff0000,#ff7f00,#ffff00,#00ff00,#0000ff,#4b0082,#9400d3)",
    border: "#0ff",
    accent: "#0ff",
    highlight: "#f0f",
    text: "#fff",
    textDim: "#0ff",
    accentDim: "rgba(0, 255, 255, 0.3)",
    fxClass: "theme-fx-88"
  }
};

  /* ==================== Firebase ==================== */
  const firebaseConfig = {
    apiKey: "AIzaSyCta1_RddjhYBA437cl8Wg1kGW_bsVimK8",
    authDomain: "teacher-shirley.firebaseapp.com",
    databaseURL: "https://teacher-shirley-default-rtdb.firebaseio.com",
    projectId: "teacher-shirley",
    storageBucket: "teacher-shirley.firebasestorage.app",
    messagingSenderId: "534843195436",
    appId: "1:534843195436:web:f1f873e6f6e8c257ce9189"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;
  let csvData = { words: [], quotes: [] };
  let checkinHistory = [];
  let activityLog = [];
  let processedLogs = [];

  /* ==================== In-app browser warning ==================== */
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  const isInApp =
    ua.includes("FBAN") ||
    ua.includes("FBAV") ||
    ua.includes("Instagram") ||
    ua.includes("Line") ||
    ua.includes("MicroMessenger");

  window.closeWarning = () => {
    document.getElementById("in-app-browser-warning").style.display = "none";
  };

  window.copyCurrentUrl = () => {
    navigator.clipboard
      .writeText(window.location.href)
      .then(() => alert("Link copied! Open Chrome/Safari and paste it."))
      .catch(() => alert("Failed to copy. Please copy the URL manually."));
  };

  /* ==================== Date helpers ==================== */
  function getLocalISODate() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  function getTodayMMDD() {
    const now = new Date();
    return (
      String(now.getMonth() + 1).padStart(2, "0") +
      "-" +
      String(now.getDate()).padStart(2, "0")
    );
  }

  /* ==================== Intro / Envelope ==================== */
  window.openLetter = () => {
    const windchime = document.getElementById("windchime");
    windchime.volume = 0.5;
    windchime.play().catch(() => {});

    const container = document.querySelector(".envelope-container");
    container.classList.add("open");

    setTimeout(() => {
      const letterView = document.getElementById("letter-view");
      letterView.classList.add("show");

      const paragraphs = document.querySelectorAll(".letter-p");
      paragraphs.forEach((p, index) => {
        setTimeout(() => p.classList.add("visible"), index * 800);
      });

      setTimeout(() => {
        document.getElementById("choice-buttons").classList.add("visible");
      }, paragraphs.length * 800 + 400);
    }, 800);
  };

  window.enterVisitorMode = () => {
    const overlay = document.getElementById("intro-overlay");
    overlay.style.opacity = "0";
    setTimeout(() => (overlay.style.display = "none"), 1000);
    document.getElementById("visitor-view").classList.add("active");
  };

  window.reopenAuth = () => {
    document.getElementById("visitor-view").classList.remove("active");

    const overlay = document.getElementById("intro-overlay");
    overlay.style.display = "flex";
    void overlay.offsetWidth;
    overlay.style.opacity = "1";

    const container = document.querySelector(".envelope-container");
    const letterView = document.getElementById("letter-view");
    if (!container.classList.contains("open")) {
      container.classList.add("open");
      letterView.classList.add("show");
    }
    showAuthForm();
  };

  window.showAuthForm = () => {
    document.getElementById("choice-buttons").style.display = "none";
    document.getElementById("auth-form-container").style.display = "block";
  };

  window.hideAuthForm = () => {
    document.getElementById("choice-buttons").style.display = "flex";
    document.getElementById("auth-form-container").style.display = "none";
  };

  /* ==================== Universe / Member terminal ==================== */
  window.openMemberTerminal = () =>
    document.getElementById("member-terminal").classList.add("show");
  window.closeMemberTerminal = () =>
    document.getElementById("member-terminal").classList.remove("show");

  window.visitPlanet = (planetName, url) => {
    if (currentUser) trackActivity("Exploration", `Departed Moon for ${planetName}`);
    setTimeout(() => (window.location.href = url), 300);
  };

  /* ==================== Auth buttons ==================== */
  document.getElementById("google-login-btn").addEventListener("click", () => {
    if (isInApp) {
      document.getElementById("in-app-browser-warning").style.display = "flex";
      return;
    }
    signInWithPopup(auth, provider).catch((e) =>
      alert("Login Error: " + e.message)
    );
  });

  document.getElementById("email-login-btn").addEventListener("click", () => {
    const email = document.getElementById("email-input").value;
    const pass = document.getElementById("pass-input").value;
    if (!email || !pass) return alert("Please fill in fields");

    signInWithEmailAndPassword(auth, email, pass).catch((error) => {
      if (
        error.code === "auth/user-not-found" ||
        error.code === "auth/invalid-credential"
      ) {
        if (confirm("Create account?"))
          createUserWithEmailAndPassword(auth, email, pass);
      } else alert(error.message);
    });
  });

  document.getElementById("logoutBtn").addEventListener("click", () => {
    signOut(auth).then(() => location.reload());
  });

  /* ==================== Auth state ==================== */
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;

      document.getElementById("intro-overlay").style.display = "none";
      document.getElementById("visitor-view").classList.remove("active");
      document.getElementById("universe-view").classList.add("active");
      document.getElementById("logoutBtn").style.display = "flex";

      await loadCSVData();
      await loadUserData(user.uid);
      renderDailyContent(getTodayMMDD());
    } else {
      currentUser = null;
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("universe-view").classList.remove("active");
      // intro / visitor ä¿ç•™ä½ åŸæµç¨‹
    }
  });

  /* ==================== Firestore helpers ==================== */
  async function trackActivity(type, detail) {
    if (!currentUser) return;
    const userRef = doc(db, "users", currentUser.uid);
    try {
      await updateDoc(userRef, {
        activityLogs: arrayUnion({
          date: new Date().toISOString(),
          type,
          detail
        })
      });
    } catch {}
  }

  async function loadUserData(uid) {
    const userRef = doc(db, "users", uid);
    const docSnap = await getDoc(userRef);
    const fullDate = getLocalISODate();

    if (docSnap.exists()) {
      const data = docSnap.data();
      checkinHistory = data.history || [];
      activityLog = data.activityLogs || [];

      document.getElementById("total-days").innerText = checkinHistory.length;
      document.getElementById("streak-days").innerText = data.streak || 0;

      if (checkinHistory.includes(fullDate)) {
        document.getElementById("checkin-btn").disabled = true;
      }
    } else {
      await setDoc(
        userRef,
        { email: currentUser.email, history: [], streak: 0, activityLogs: [] },
        { merge: true }
      );
    }

    renderCalendar();
    renderCardBagList();
  }

  /* ==================== Card / Check-in logic ==================== */
  function getTemplateIdByDate(dateStr) {
    if (!dateStr) return 1;

    let uid = "visitor";
    try {
      if (currentUser?.uid) uid = currentUser.uid;
    } catch {}

    const [y, m, d] = dateStr.split("-").map(Number);
    const seedStr = `${y}${m}${d}-${uid}`;

    let hash = 0;
    for (let i = 0; i < seedStr.length; i++) {
      hash = (hash << 5) - hash + seedStr.charCodeAt(i);
      hash |= 0;
    }
    hash = Math.abs(hash);

    const luck = hash % 100;
    if (luck === 99) return 88; // SP 1%
    if (luck >= 97) return 87;  // UR 2%
    if (luck >= 94) return 86;  // SSR 3%
    return (hash % 85) + 1;
  }
window.openCard = (dateStr) => {
  const userName =
    (currentUser &&
      (currentUser.displayName || currentUser.email.split("@")[0])) ||
    "Traveler";

  let wotd = "Mystery",
    wotdPos = "n.",
    wotdDef = "To explore the unknown.",
    sentEn = "Keep looking up.",
    sentCn = "ä¿æŒä»°æœ›æ˜Ÿç©ºã€‚",
    quote = "The stars are calling.",
    quoteTrans = "ç¾¤æ˜Ÿåœ¨å¬å–šã€‚",
    author = "Universe";

  if (csvData?.words) {
    const queryDate = dateStr.slice(5);
    const wordObj = csvData.words.find((r) => r.date === queryDate);
    const quoteObj = csvData.quotes.find((r) => r.date === queryDate);

    if (wordObj) {
      wotd = wordObj.word || wotd;
      wotdPos = wordObj.pos || wotdPos;
      wotdDef = wordObj.meaning || wotdDef;
      sentEn = wordObj["sentence e"] || sentEn;
      sentCn = wordObj["sentence c"] || sentCn;
    }
    if (quoteObj) {
      quote = quoteObj["quote e"] || quote;
      quoteTrans = quoteObj["quote c"] || quoteTrans;
      author = quoteObj.author || author;
    }
  }

  const streakDisplay =
    document.getElementById("streak-days")?.innerText || "0";

  document.getElementById("card-user-name").innerText = userName;
  document.getElementById("card-display-date").innerText = dateStr;
  document.getElementById("card-date-serial").innerText = dateStr.replace(/-/g, "");

  document.getElementById("card-wotd").innerText = wotd;
  document.getElementById("card-pos").innerText = wotdPos;
  document.getElementById("card-def").innerText = wotdDef;
  document.getElementById("card-sent-en").innerText = sentEn;
  document.getElementById("card-sent-cn").innerText = sentCn;

  document.getElementById("card-quote").innerText = `â€œ${quote}â€`;
  document.getElementById("card-quote-trans").innerText = quoteTrans;
  document.getElementById("card-author").innerText = author;
  document.getElementById("card-streak").innerText = streakDisplay;

  const cardEl = document.getElementById("collectible-card");
  const themeId = getTemplateIdByDate(dateStr);

  applyTheme(cardEl, themeId);     // âœ… å¥—ä¸»é¡Œ
  document.getElementById("card-modal").classList.add("active");  // âœ… é–‹ modal
};

// âœ… ç§»åˆ° openCard å¤–é¢
function applyTheme(cardEl, themeId) {
  const t = THEMES[themeId];
  cardEl.classList.add("card-theme");

  for (let i = 1; i <= 88; i++) cardEl.classList.remove(`theme-fx-${i}`);

  if (t) {
    cardEl.style.setProperty("--card-bg", t.bg);
    cardEl.style.setProperty("--card-border", t.border);
    cardEl.style.setProperty("--card-accent", t.accent);
    cardEl.style.setProperty("--card-highlight", t.highlight);
    cardEl.style.setProperty("--card-text", t.text);
    cardEl.style.setProperty("--card-text-dim", t.textDim);
    cardEl.style.setProperty("--card-accent-dim", t.accentDim);

    if (t.fxClass) cardEl.classList.add(t.fxClass);
  }
}
  window.closeCardModal = () => {
    document.getElementById("card-modal").classList.remove("active");
  };

  window.downloadCardImage = () => {
    const cardElement = document.getElementById("collectible-card");
    const btn = document.querySelector(".btn-download");
    const originalText = btn.innerText;
    btn.innerText = "Capturing... ğŸ“¸";

    if (typeof html2canvas === "undefined") {
      alert("Snapshot library not loaded.");
      btn.innerText = originalText;
      return;
    }

    html2canvas(cardElement, {
      scale: 2,
      backgroundColor: null,
      useCORS: true
    })
      .then((canvas) => {
        const link = document.createElement("a");
        const dateText =
          document.getElementById("card-display-date").innerText;
        link.download = `Shirley_MoonBase_Card_${dateText}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
        btn.innerText = originalText;
      })
      .catch(() => {
        alert("Image capture failed.");
        btn.innerText = originalText;
      });
  };

  window.handleCheckIn = async () => {
    if (!currentUser) return;
    const fullDate = getLocalISODate();
    if (checkinHistory.includes(fullDate)) return;

    const btn = document.getElementById("checkin-btn");
    btn.disabled = true;
    btn.innerText = "Transmitting...";

    try {
      let currentStreak =
        parseInt(document.getElementById("streak-days").innerText) || 0;
      const lastCheckIn =
        checkinHistory.length > 0
          ? checkinHistory[checkinHistory.length - 1]
          : null;

      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.toISOString().slice(0, 10);

      currentStreak = lastCheckIn === yesterdayStr ? currentStreak + 1 : 1;

      const userRef = doc(db, "users", currentUser.uid);
      const logEntry = {
        date: new Date().toISOString(),
        type: "Check-in",
        detail: "Daily Check-in"
      };

      await updateDoc(userRef, {
        streak: currentStreak,
        history: arrayUnion(fullDate),
        activityLogs: arrayUnion(logEntry)
      });

      checkinHistory.push(fullDate);
      activityLog.push(logEntry);

      document.getElementById("streak-days").innerText = currentStreak;
      document.getElementById("total-days").innerText = checkinHistory.length;

      btn.innerText = "Moon Check-in Success! ğŸŒ•";

      renderCalendar();
      renderCardBagList();

      setTimeout(() => window.openCard(fullDate), 800);
    } catch (e) {
      console.error(e);
      btn.innerText = "Check-in Failed";
      btn.disabled = false;
    }
  };

  window.renderCalendar = () => {
    const grid = document.getElementById("calendar-grid");
    grid.innerHTML = "";

    const now = new Date();
    const daysInMonth = new Date(
      now.getFullYear(),
      now.getMonth() + 1,
      0
    ).getDate();

    const currentYearMonth = `${now.getFullYear()}-${String(
      now.getMonth() + 1
    ).padStart(2, "0")}`;

    for (let i = 1; i <= daysInMonth; i++) {
      const dayEl = document.createElement("div");
      dayEl.innerText = i;
      dayEl.style.cssText =
        "aspect-ratio:1; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.05); border-radius:4px; transition:all 0.2s; color: var(--text);";

      const thisDateStr = `${currentYearMonth}-${String(i).padStart(2, "0")}`;

      if (checkinHistory.includes(thisDateStr)) {
        dayEl.style.background = "var(--accent)";
        dayEl.style.color = "white";
        dayEl.style.borderRadius = "50%";
        dayEl.style.fontWeight = "bold";
        dayEl.classList.add("calendar-day-checked");
        dayEl.title = "Tap to open Card Pocket";
        dayEl.onclick = () => window.openCard(thisDateStr);
      }

      grid.appendChild(dayEl);
    }
  };

  function renderCardBagList() {
    const bag = document.getElementById("card-bag-list");
    if (!bag) return;
    bag.innerHTML = "";

    if (!checkinHistory.length) {
      bag.innerHTML =
        '<div style="font-size:0.75rem; color:var(--text-light);">No cards yet.</div>';
      return;
    }

    const sorted = [...checkinHistory].sort().reverse();
    const groups = {};

    sorted.forEach((d) => {
      const ym = d.slice(0, 7);
      (groups[ym] ||= []).push(d);
    });

    Object.keys(groups)
      .sort()
      .reverse()
      .forEach((ym) => {
        const section = document.createElement("div");
        section.style.cssText =
          "margin-bottom:10px; padding:8px; border:1px dashed var(--border); border-radius:10px; background:rgba(0,0,0,0.02);";

        const title = document.createElement("div");
        title.innerText = ym;
        title.style.cssText =
          "font-size:0.75rem; font-weight:bold; color:var(--text-light); margin-bottom:6px; letter-spacing:0.5px;";
        section.appendChild(title);

        const row = document.createElement("div");
        row.style.cssText = "display:flex; flex-wrap:wrap; gap:6px;";

        groups[ym].forEach((dateStr) => {
          const btn = document.createElement("button");
          btn.innerText = dateStr.slice(8);
          btn.style.cssText = `
            padding:4px 8px; border-radius:999px; border:1px solid var(--border);
            background:var(--surface); color:var(--text); font-size:0.75rem;
            cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.1);
          `;
          btn.title = dateStr;
          btn.onclick = () => window.openCard(dateStr);
          row.appendChild(btn);
        });

        section.appendChild(row);
        bag.appendChild(section);
      });
  }

  /* ==================== CSV ==================== */
  async function loadCSVData() {
    try {
      const [resWords, resQuotes] = await Promise.all([
        fetch(
          "https://ducj-creator.github.io/Teacher-Shirley/assets/word%20of%20the%20day.csv"
        ),
        fetch(
          "https://ducj-creator.github.io/Teacher-Shirley/assets/quote%20of%20the%20day.csv"
        )
      ]);

      csvData.words = parseCSV(await resWords.text());
      csvData.quotes = parseCSV(await resQuotes.text());
    } catch {}
  }

  function parseCSV(text) {
    const lines = text.trim().split("\n");
    const headers = lines[0].split(",").map((h) => h.trim());

    return lines.slice(1).map((line) => {
      const row = {};
      const regex =
        /(?:,|\n|^)("(?:(?:"")*[^"]*)*"|[^",\n]*|(?:\n|$))/g;

      const matches = [];
      let match;
      while ((match = regex.exec(line)) !== null) {
        if (match.index === regex.lastIndex) regex.lastIndex++;
        if (match[1] !== undefined)
          matches.push(
            match[1].replace(/^"|"$/g, "").replace(/""/g, '"')
          );
      }

      headers.forEach(
        (h, i) => (row[h] = matches[i] ? matches[i].trim() : "")
      );
      return row;
    });
  }

  function renderDailyContent(dateStr) {
    const wordObj = csvData.words.find((r) => r.date === dateStr);
    if (wordObj) {
      document.getElementById("wotd-word").innerText = wordObj.word;
      document.getElementById("wotd-ipa").innerText = wordObj.ipa;
      document.getElementById("wotd-pos").innerText = wordObj.pos;
      document.getElementById("wotd-meaning").innerText = wordObj.meaning;
      document.getElementById("wotd-sentence-e").innerText =
        wordObj["sentence e"];
      document.getElementById("wotd-sentence-c").innerText =
        wordObj["sentence c"];
      document.getElementById("word-date").innerText = `(${dateStr})`;
    }

    const quoteObj = csvData.quotes.find((r) => r.date === dateStr);
    if (quoteObj) {
      document.getElementById("qotd-text").innerText =
        quoteObj["quote e"];
      document.getElementById("qotd-trans").innerText =
        quoteObj["quote c"];
      document.getElementById("qotd-author").innerText =
        "â€” " + quoteObj.author;
    }
  }

  /* ==================== Particles + UI toggles ==================== */
  const canvas = document.getElementById("particle-canvas");
  const ctx = canvas.getContext("2d");
  let particlesArray = [];

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }

  class Particle {
    constructor() {
      this.x = Math.random() * canvas.width;
      this.y = Math.random() * canvas.height;
      this.size = Math.random() * 2;
      this.speedX = Math.random() * 0.2 - 0.1;
      this.speedY = Math.random() * 0.2 - 0.1;
      this.opacity = Math.random() * 0.5;
    }
    update() {
      this.x += this.speedX;
      this.y += this.speedY;
      if (this.x > canvas.width) this.x = 0;
      if (this.x < 0) this.x = canvas.width;
      if (this.y > canvas.height) this.y = 0;
      if (this.y < 0) this.y = canvas.height;
    }
    draw(isDark) {
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      ctx.fillStyle = isDark
        ? `rgba(255,255,255,${this.opacity})`
        : `rgba(44,62,80,${this.opacity * 0.5})`;
      ctx.fill();
    }
  }

  function initParticles() {
    particlesArray = [];
    for (let i = 0; i < 80; i++) particlesArray.push(new Particle());
  }

  function animateParticles() {
    requestAnimationFrame(animateParticles);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const isDark = document
      .getElementById("htmlRoot")
      .classList.contains("dark");
    particlesArray.forEach((p) => {
      p.update();
      p.draw(isDark);
    });
  }

  window.addEventListener("resize", () => {
    resizeCanvas();
    initParticles();
  });

  resizeCanvas();
  initParticles();
  animateParticles();

  const html = document.getElementById("htmlRoot");
  document
    .getElementById("themeToggle")
    .addEventListener("click", () => html.classList.toggle("dark"));

  const musicToggle = document.getElementById("musicToggle");
  const themeSong = document.getElementById("themeSong");
  let isPlaying = false;

  musicToggle.addEventListener("click", () => {
    if (isPlaying) {
      themeSong.pause();
      musicToggle.style.color = "var(--text)";
    } else {
      themeSong.currentTime = 0;
      themeSong.play();
      musicToggle.style.color = "var(--accent)";
    }
    isPlaying = !isPlaying;
  });
<script>
  window.addEventListener("message", (e) => {
    if (e.data?.type === "moonlightHeight") {
      const frame = document.getElementById("moonlightFrame");
      if(frame) frame.style.height = e.data.height + "px";
    }
  });
</script>
  </body>
</html>
