<!DOCTYPE html>
<html lang="en" id="htmlRoot" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Shirley's ET Platform</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Exo+2:wght@300;400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='14' fill='%232c3e50'/%3E%3Ctext x='16' y='22' font-family='serif' font-size='18' text-anchor='middle' fill='%23f1c40f'%3ES%3C/text%3E%3C/svg%3E" type="image/svg+xml">
  
  <style id="themeStyles">
    :root {
      /* --- Light Mode --- */
      --bg-gradient: linear-gradient(to bottom, #fdfbfb 0%, #f4f7f6 100%);
      --surface: rgba(255, 255, 255, 0.85);
      --border: rgba(0, 0, 0, 0.08);
      --text: #2c3e50; 
      --text-light: #7f8c8d;
      --accent: #2980b9; 
      --accent-glow: rgba(41, 128, 185, 0.3);
      --card-shadow: 0 10px 25px rgba(0,0,0,0.05);
      --card-hover-shadow: 0 15px 35px rgba(41, 128, 185, 0.15);
      --underline-gradient: linear-gradient(90deg, transparent, #2980b9, transparent);
      --subtitle-color: #34495e;
      
      /* Â§©È´îÈ°èËâ≤ */
      --sun-color: #f39c12;
      --moon-color: #95a5a6;
      --planet-color: #3498db;
    }

    .dark {
      /* --- Dark Mode --- */
      --bg-gradient: radial-gradient(circle at 50% 20%, #1a253a 0%, #0f1219 100%);
      --surface: rgba(30, 35, 50, 0.7);
      --border: rgba(255, 255, 255, 0.1);
      --text: #ecf0f1;
      --text-light: #bdc3c7;
      --accent: #f1c40f; 
      --accent-glow: rgba(241, 196, 15, 0.4);
      --card-shadow: 0 10px 30px rgba(0,0,0,0.4);
      --card-hover-shadow: 0 0 25px rgba(241, 196, 15, 0.15);
      --underline-gradient: linear-gradient(90deg, transparent, #f1c40f, transparent);
      --subtitle-color: #f6f6f6;

      /* Â§©È´îÈ°èËâ≤ */
      --sun-color: #f1c40f;
      --moon-color: #dfe6e9;
      --planet-color: #00d2ff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text);
      font-family: 'Exo 2', 'Noto Sans TC', sans-serif;
      line-height: 1.7;
      transition: color 0.3s, background 0.3s;
      position: relative;
      overflow-x: hidden;
      min-height: 100vh;
    }

    #particle-canvas {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: -1; pointer-events: none;
    }

    body.modal-open { overflow: hidden; }

    /* --- ‚ú® ÊúÉÂì°Â∞àÂçÄÔºöÊòüÈöõËà™Á´ôÈ¢®Ê†º --- */
    #member-terminal {
        max-width: 900px;
        margin: -2rem auto 3rem; /* ÊîæÂú®Ê®ôÈ°åÂíåÂàÜÈ°û‰πãÈñì */
        position: relative;
        z-index: 20;
        font-family: 'Exo 2', sans-serif;
    }

    /* ÁôªÂÖ•ÂâçÔºöÁ∞°Á¥ÑÊåâÈàï */
    .login-trigger-box {
        text-align: center;
        padding: 2rem;
        background: var(--surface);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        border: 1px solid var(--border);
        box-shadow: var(--card-shadow);
        transition: transform 0.3s;
    }
    .login-trigger-box:hover { transform: translateY(-3px); border-color: var(--accent); }

    /* ÁôªÂÖ•ÂæåÔºöÈ´òÁ¥öÈÄöË°åË≠âÂç°Áâá */
    .member-card {
        display: none; /* È†êË®≠Èö±Ëóè */
        background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        color: var(--text);
        position: relative;
    }
    .dark .member-card {
        background: linear-gradient(135deg, rgba(30,35,50,0.8), rgba(20,20,30,0.9));
        border: 1px solid rgba(241, 196, 15, 0.2);
    }

    /* Âç°ÁâáÈ†≠ÈÉ® */
    .card-header {
        padding: 2rem;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0,0,0,0.02);
    }
    .user-info h2 { font-family: 'Cinzel Decorative', cursive; color: var(--accent); margin-bottom: 0.5rem; }
    .streak-badge {
        background: var(--accent);
        color: #fff; /* Âú®ÈªÉËâ≤ËÉåÊôØ‰∏ä‰øùÊåÅÁôΩËâ≤ÊñáÂ≠óÔºåÊàñË¶ñÈúÄË¶ÅÊîπÈªë */
        text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-weight: bold;
        box-shadow: 0 0 15px var(--accent-glow);
        animation: pulse 2s infinite;
    }

    /* ÂÖ©Ê¨Ñ‰ΩàÂ±Ä */
    .card-body {
        display: grid;
        grid-template-columns: 1fr 1.5fr;
        gap: 0;
    }
    @media (max-width: 768px) { .card-body { grid-template-columns: 1fr; } }

    /* Â∑¶ÂÅ¥ÔºöÊó•ÊõÜ */
    .checkin-section {
        padding: 2rem;
        border-right: 1px solid var(--border);
        text-align: center;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        margin: 1.5rem 0;
        font-size: 0.8rem;
    }
    .cal-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(0,0,0,0.05);
        color: var(--text-light);
        position: relative;
    }
    .cal-day.checked {
        background: var(--accent);
        color: #fff;
        box-shadow: 0 0 10px var(--accent-glow);
    }
    .cal-day.checked::after {
        content: '‚úì'; font-size: 0.6rem; position: absolute; bottom: 2px;
    }
    .checkin-btn {
        background: linear-gradient(45deg, var(--accent), #2ecc71);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 50px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: transform 0.2s;
        width: 100%;
        font-family: 'Exo 2', sans-serif;
        font-weight: bold;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .checkin-btn:hover { transform: scale(1.05); filter: brightness(1.1); }
    .checkin-btn:disabled { background: #95a5a6; cursor: not-allowed; transform: none; }

    /* Âè≥ÂÅ¥ÔºöÂÖßÂÆπ */
    .content-section {
        padding: 2rem;
        position: relative;
    }
    .daily-box { margin-bottom: 2rem; }
    .label-tag {
        font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px;
        color: var(--text-light); margin-bottom: 0.5rem; display: block;
    }
    .word-display { font-size: 2.5rem; font-weight: 700; color: var(--accent); line-height: 1.2; }
    .ipa-display { font-family: 'Times New Roman', serif; font-style: italic; color: var(--text-light); margin-left: 10px; font-size: 1.2rem; }
    .meaning-display { font-size: 1.2rem; margin-top: 0.5rem; }
    .sentence-display { 
        margin-top: 1rem; padding-left: 1rem; border-left: 3px solid var(--accent); 
        font-style: italic; color: var(--text-light);
    }
    .quote-display { font-family: 'Cinzel Decorative', cursive; font-size: 1.3rem; line-height: 1.4; }
    .quote-author { text-align: right; margin-top: 0.5rem; color: var(--accent); }

    /* ÂäüËÉΩÂàó */
    .card-footer {
        padding: 1rem 2rem;
        background: rgba(0,0,0,0.02);
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }
    .action-link { color: var(--text-light); cursor: pointer; font-size: 0.9rem; text-decoration: underline; }
    .action-link:hover { color: var(--accent); }

    @media print {
        body * { visibility: hidden; }
        #print-area, #print-area * { visibility: visible; }
        #print-area { position: absolute; left: 0; top: 0; width: 100%; color: black; background: white; padding: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #333; padding: 10px; text-align: left; }
        th { background: #f0f0f0; }
    }

    /* --- Top Bar & Header --- */
    .top-bar {
      position: absolute;
      top: 1.5rem;
      right: 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      z-index: 50;
    }
    .control-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      font-size: 1.2rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      backdrop-filter: blur(5px);
    }
    .control-btn:hover {
        transform: scale(1.1);
        border-color: var(--accent);
        color: var(--accent);
        box-shadow: 0 0 15px var(--accent-glow);
    }
    .playing { animation: pulse 2s infinite; color: #e74c3c !important; border-color: #e74c3c !important; }
    .letter-trigger { font-size: 1.4rem; animation: floatLetter 3s ease-in-out infinite; position: relative; }
    .letter-trigger::after { content: ''; position: absolute; top: 8px; right: 8px; width: 6px; height: 6px; background: #e74c3c; border-radius: 50%; }

    header { display: flex; flex-direction: column; align-items: center; padding: 4rem 1rem 1rem; position: relative; z-index: 10; text-align: center; }
    .title-container { position: relative; width: 100%; max-width: 800px; height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .orbit-system { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; pointer-events: none; z-index: -1; }
    .orbit-ring { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; border: 1px dashed rgba(255,255,255,0.05); }
    .orbit-1 { width: 320px; height: 100px; animation: rotateOrbit 12s linear infinite; }
    .orbit-2 { width: 450px; height: 160px; animation: rotateOrbit 20s linear infinite reverse; }
    .orbit-3 { width: 220px; height: 220px; animation: rotateOrbit 8s linear infinite; }
    .celestial-body { position: absolute; border-radius: 50%; box-shadow: 0 0 10px var(--accent-glow); }
    .sun { top: 0; left: 50%; width: 20px; height: 20px; background: var(--sun-color); box-shadow: 0 0 20px var(--sun-color); transform: translate(-50%, -50%); }
    .moon { top: 50%; right: 0; width: 15px; height: 15px; background: var(--moon-color); box-shadow: 0 0 15px var(--moon-color); transform: translate(50%, -50%); }
    .planet { bottom: 0; left: 20%; width: 10px; height: 10px; background: var(--planet-color); transform: translate(-50%, 50%); }
    
    .main-title { font-family: 'Cinzel Decorative', cursive; font-size: clamp(1.7rem, 5.5vw, 4rem); font-weight: 700; color: var(--text); line-height: 1.1; letter-spacing: 0.05em; text-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; cursor: default; word-break: keep-all; }
    .dark .main-title { color: #ffffff; text-shadow: 0 0 15px rgba(241, 196, 15, 0.5), 0 0 30px rgba(241, 196, 15, 0.2); }
    .char { display: inline-block; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.2s; position: relative; }
    .char:hover { transform: translateY(-15px) scale(1.1); color: var(--accent); text-shadow: 0 0 15px var(--accent-glow); }
    .title-underline { width: 60%; height: 2px; background: var(--underline-gradient); background-size: 200% 100%; animation: flowLine 3s linear infinite; border-radius: 2px; margin-top: 10px; opacity: 0.8; }
    .sub-title { font-family: 'Exo 2', sans-serif; font-size: 0.9rem; color: var(--accent); letter-spacing: 2px; margin-top: 5px; font-weight: 500; text-transform: uppercase; opacity: 0.8; }
    
    /* Modal */
    .letter-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); background: var(--surface); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: 12px; padding: 3rem; max-width: 650px; width: 90%; box-shadow: 0 25px 50px rgba(0,0,0,0.3); z-index: 1000; opacity: 0; pointer-events: none; transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1); color: var(--text); max-height: 85vh; overflow-y: auto; }
    .dark .letter-content { background: #151922; border: 1px solid rgba(241, 196, 15, 0.3); }
    .letter-content.show { opacity: 1; pointer-events: auto; transform: translate(-50%, -50%) scale(1); }
    .letter-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 1rem; margin-bottom: 1.5rem; }
    .letter-title { font-family: 'Cinzel Decorative', cursive; font-size: 1.6rem; color: var(--accent); }
    .letter-body { font-family: 'Exo 2', sans-serif; font-size: 1.05rem; }
    .letter-body p { margin-bottom: 1.2rem; opacity: 0; transform: translateY(10px); transition: all 0.5s ease; }
    .letter-body p.show { opacity: 1; transform: translateY(0); }

    /* Categories */
    .categories { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; padding: 1rem 2rem 4rem; max-width: 1000px; margin: 0 auto; position: relative; z-index: 5; }
    .category-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; text-align: center; text-decoration: none; color: var(--text); transition: all 0.3s ease; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; box-shadow: var(--card-shadow); }
    .category-card:hover { transform: translateY(-5px); box-shadow: var(--card-hover-shadow); border-color: var(--accent); }
    .icon { font-size: 2.5rem; margin-bottom: 0.5rem; display: block; transition: transform 0.3s; filter: sepia(20%) hue-rotate(180deg) saturate(80%); }
    .dark .icon { filter: drop-shadow(0 0 8px rgba(255,255,255,0.3)); }
    .category-card:hover .icon { transform: scale(1.15) rotate(5deg); }
    .category-card h2 { font-family: 'Exo 2', sans-serif; font-size: 1.25rem; font-weight: 600; margin-bottom: 0.3rem; }
    .category-card .subtitle { font-family: 'Noto Sans TC', sans-serif; font-size: 1rem; font-weight: 500; color: var(--subtitle-color); transition: color 0.3s; }
    .category-card:hover .subtitle { color: var(--accent); }

    .page-footer { border-top: 1px solid var(--border); padding: 2rem; text-align: center; font-size: 0.9rem; color: var(--text-light); background: rgba(0,0,0,0.02); }
    .page-footer a { color: var(--accent); text-decoration: none; font-weight: 600; }
    .page-footer a:hover { text-decoration: underline; }

    @keyframes flowLine { 0% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    @keyframes floatLetter { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    @keyframes rotateOrbit { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

    @media (max-width: 768px) {
      .categories { grid-template-columns: 1fr; }
      header { padding-top: 6rem; } 
      .top-bar { top: 1rem; right: 1rem; gap: 0.5rem; }
      .orbit-1 { width: 250px; }
      .orbit-2 { width: 300px; }
    }
  </style>
</head>
<body>

  <canvas id="particle-canvas"></canvas>

  <div class="top-bar">
      <div id="openLetter" class="control-btn letter-trigger" title="Read Message">üì©</div>
      <div id="themeToggle" class="control-btn" title="ÂàáÊèõ‰∫Æ/ÊöóÊ®°Âºè">üåì</div>
      <div id="musicToggle" class="control-btn" title="Êí≠Êîæ‰∏ªÈ°åÊõ≤">üéµ</div>
  </div>

  <header>
    <div class="title-container">
        <div class="orbit-system">
            <div class="orbit-ring orbit-1"><div class="celestial-body sun"></div></div>
            <div class="orbit-ring orbit-2"><div class="celestial-body moon"></div></div>
            <div class="orbit-ring orbit-3"><div class="celestial-body planet"></div></div>
        </div>

        <h1 class="main-title" id="animatedTitle">Teacher Shirley‚Äôs<br>ET Platform</h1>
        <div class="title-underline"></div>
        <div class="sub-title">(ET means English Teaching)</div>
    </div>
  </header>

  <audio id="chimeSound" src="https://ducj-creator.github.io/Teacher-Shirley/assets/windchime.mp3" preload="auto"></audio>
  <audio id="themeSong" src="https://ducj-creator.github.io/Teacher-Shirley/assets/theme%20song.mp3" preload="auto"></audio>

  <div class="letter-content" id="letterContent">
    <div class="letter-header">
      <div class="letter-title">A Message from Shirley</div>
      <button class="control-btn" style="width:30px; height:30px; font-size:1rem; border:none;" id="closeLetter">√ó</button>
    </div>
    <div class="letter-body" id="letterBody"></div>
    <div style="text-align: right; margin-top: 1rem; font-style: italic; color: var(--accent);">‚Äî Teacher Shirley</div>
  </div>

  <div id="member-terminal">
    <div id="login-view" class="login-trigger-box">
        <h2 style="font-family: 'Cinzel Decorative'; margin-bottom:1rem;">Galaxy Pass Login</h2>
        <p style="margin-bottom: 1.5rem; color: var(--text-light);">Log in with your Google account to track your learning journey.</p>
        <button id="google-login-btn" class="control-btn" style="width: auto; padding: 0 2rem; border-radius: 50px;">
            <span style="margin-right:8px">üöÄ</span> Login with Google
        </button>
    </div>

    <div id="member-view" class="member-card">
        <div class="card-header">
            <div class="user-info">
                <h2 id="greeting-name">Welcome, Traveler</h2>
                <div style="font-size: 0.9rem; opacity: 0.8;">
                    Total Visits: <strong id="total-days">0</strong> Days | 
                    Current Streak: <strong id="streak-days" style="color:var(--accent)">0</strong> Days
                </div>
            </div>
            <div class="streak-badge">
                Day <span id="current-day-num">1</span>
            </div>
        </div>

        <div class="card-body">
            <div class="checkin-section">
                <div style="font-weight:bold; margin-bottom:0.5rem;" id="current-month-display">Month</div>
                <div class="calendar-grid" id="calendar-grid"></div>
                <button id="checkin-btn" class="checkin-btn" onclick="handleCheckIn()">
                    Sign In Today
                </button>
                <p id="checkin-msg" style="margin-top:0.5rem; font-size:0.8rem; height: 1.2em;"></p>
            </div>

            <div class="content-section">
                <div class="daily-box">
                    <span class="label-tag">Word of the Day <span id="word-date"></span></span>
                    <div>
                        <span class="word-display" id="wotd-word">Loading...</span>
                        <span class="ipa-display" id="wotd-ipa"></span>
                        <span style="font-size:0.9rem; border:1px solid var(--accent); border-radius:4px; padding:2px 5px; margin-left:5px; vertical-align:middle;" id="wotd-pos"></span>
                    </div>
                    <div class="meaning-display" id="wotd-meaning"></div>
                    <div class="sentence-display">
                        <div id="wotd-sentence-e"></div>
                        <div id="wotd-sentence-c" style="font-size:0.9rem; opacity:0.8; margin-top:3px;"></div>
                    </div>
                </div>

                <div class="daily-box">
                    <span class="label-tag">Quote of the Day</span>
                    <div class="quote-display" id="qotd-text"></div>
                    <div style="font-size:0.95rem; opacity:0.8; margin-top:5px;" id="qotd-trans"></div>
                    <div class="quote-author" id="qotd-author"></div>
                </div>
            </div>
        </div>

        <div class="card-footer">
            <span class="action-link" onclick="printRecords()">üñ®Ô∏è Print / Export Records</span>
            <span class="action-link" onclick="handleLogout()">Logout</span>
        </div>
    </div>
  </div>

  <div id="print-area" style="display:none;">
      <h1 style="text-align:center; margin-bottom:20px;">My Learning Journey - Teacher Shirley's Platform</h1>
      <p>Student: <span id="print-name"></span></p>
      <p>Generated on: <span id="print-date"></span></p>
      <br>
      <table id="print-table">
          <thead>
              <tr>
                  <th>Date</th>
                  <th>Word</th>
                  <th>Meaning</th>
                  <th>Quote</th>
              </tr>
          </thead>
          <tbody id="print-body"></tbody>
      </table>
  </div>

  <div class="categories">
    <a href="/Teacher-Shirley/teaching-tools/" class="category-card">
      <span class="icon">üöÄ</span>
      <h2>Teaching Tools for Teachers</h2>
      <div class="subtitle">Â∏´Â∏´ÁôæÂØ∂ÁÆ±</div>
    </a>
    
    <a href="https://ducj-creator.github.io/Teacher-Shirley/study-tools/index.html" class="category-card">
      <span class="icon">ü™ê</span>
      <h2>Study Tools/Resources for Students</h2>
      <div class="subtitle">Â≠∏Â≠∏Êô∫Ë∂£Èñ£</div>
    </a>
    
    <a href="/Teacher-Shirley/amusement-park/" class="category-card">
      <span class="icon">üõ∏</span>
      <h2>Amusement Park</h2>
      <div class="subtitle">Ê®ÇÊ®ÇÂ¨âÈÅäË∞∑</div>
    </a>
    
    <a href="/Teacher-Shirley/external-resources/" class="category-card">
      <span class="icon">üåå</span>
      <h2>External Resources</h2>
      <div class="subtitle">Ê∫êÊ∫êÈÄ£ÁµêÂ∫´</div>
    </a>
  </div>
  
  <footer class="page-footer">
    <div>¬©Ô∏è Shirley‚Äòs ET Platform; Since 2025; All Rights Reserved</div>
    <span id="busuanzi_container_site_pv">
    Total Visits <span id="busuanzi_value_site_pv"></span> 
    </span>
    <div style="margin-top: 0.4rem;">
      Signal Frequency: 
      <a href="https://forms.gle/EW62xKbBjHaLpBUy9" target="_blank" rel="noopener noreferrer">Contact Teacher Shirley</a>
    </div>
  </footer>

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    // ÊÇ®ÁöÑ Config (Â∑≤Ëá™ÂãïÂ°´ÂÖ•)
    const firebaseConfig = {
      apiKey: "AIzaSyCta1_RddjhYBA437cl8Wg1kGW_bsVimK8",
      authDomain: "teacher-shirley.firebaseapp.com",
      databaseURL: "https://teacher-shirley-default-rtdb.firebaseio.com",
      projectId: "teacher-shirley",
      storageBucket: "teacher-shirley.firebasestorage.app",
      messagingSenderId: "534843195436",
      appId: "1:534843195436:web:f1f873e6f6e8c257ce9189"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let csvData = { words: [], quotes: [] };
    let checkinHistory = []; 

    // CSV Ëß£Êûê (ËôïÁêÜÈÄóËôüËàáÂºïËôü)
    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        return lines.slice(1).map(line => {
            const regex = /(?:,|\n|^)("(?:(?:"")*[^"]*)*"|[^",\n]*|(?:\n|$))/g;
            const matches = [];
            let match;
            while ((match = regex.exec(line)) !== null) {
                 if (match.index === regex.lastIndex) regex.lastIndex++; 
                 if (match[1] !== undefined) matches.push(match[1].replace(/^"|"$/g, '').replace(/""/g, '"'));
            }
            const row = {};
            headers.forEach((h, i) => row[h] = matches[i] ? matches[i].trim() : '');
            return row;
        });
    }

    async function loadCSVData() {
        try {
            const [resWords, resQuotes] = await Promise.all([
                fetch('https://ducj-creator.github.io/Teacher-Shirley/assets/word%20of%20the%20day.csv'),
                fetch('https://ducj-creator.github.io/Teacher-Shirley/assets/quote%20of%20the%20day.csv')
            ]);
            csvData.words = parseCSV(await resWords.text());
            csvData.quotes = parseCSV(await resQuotes.text());
        } catch (e) {
            console.error("CSV Load Failed:", e);
        }
    }

    function getTodayMMDD() {
        const now = new Date();
        return String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
    }

    function renderDailyContent(dateStr) {
        const wordObj = csvData.words.find(r => r.date === dateStr);
        if (wordObj) {
            document.getElementById('wotd-word').innerText = wordObj.word;
            document.getElementById('wotd-ipa').innerText = wordObj.ipa;
            document.getElementById('wotd-pos').innerText = wordObj.pos;
            document.getElementById('wotd-meaning').innerText = wordObj.meaning;
            document.getElementById('wotd-sentence-e').innerText = wordObj['sentence e'];
            document.getElementById('wotd-sentence-c').innerText = wordObj['sentence c'];
            document.getElementById('word-date').innerText = `(${dateStr})`;
        } else {
            document.getElementById('wotd-word').innerText = "Loading...";
            document.getElementById('wotd-meaning').innerText = "Please wait or refresh.";
        }

        const quoteObj = csvData.quotes.find(r => r.date === dateStr);
        if (quoteObj) {
            document.getElementById('qotd-text').innerText = quoteObj['quote e'];
            document.getElementById('qotd-trans').innerText = quoteObj['quote c'];
            document.getElementById('qotd-author').innerText = "‚Äî " + quoteObj.author;
        }
    }

    // Auth Events
    document.getElementById('google-login-btn').addEventListener('click', () => {
        signInWithPopup(auth, provider).catch(err => alert(err.message));
    });

    window.handleLogout = () => {
        signOut(auth).then(() => location.reload());
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('member-view').style.display = 'block';
            document.getElementById('greeting-name').innerText = `Welcome, ${user.displayName || 'Traveler'}`;
            
            await loadCSVData();
            await loadUserData(user.uid);
            renderDailyContent(getTodayMMDD());
        } else {
            document.getElementById('login-view').style.display = 'block';
            document.getElementById('member-view').style.display = 'none';
        }
    });

    async function loadUserData(uid) {
        const userRef = doc(db, "users", uid);
        const docSnap = await getDoc(userRef);
        const fullDate = new Date().toISOString().split('T')[0];

        if (docSnap.exists()) {
            const data = docSnap.data();
            checkinHistory = data.history || [];
            document.getElementById('total-days').innerText = checkinHistory.length;
            document.getElementById('streak-days').innerText = data.streak || 0;
            if (checkinHistory.includes(fullDate)) disableCheckInBtn("Checked in! ‚úÖ");
        } else {
            checkinHistory = [];
        }
        renderCalendar();
    }

    window.handleCheckIn = async () => {
        if (!currentUser) return;
        const btn = document.getElementById('checkin-btn');
        btn.disabled = true;
        btn.innerText = "Signing in...";

        const fullDate = new Date().toISOString().split('T')[0];
        const userRef = doc(db, "users", currentUser.uid);
        
        try {
            const docSnap = await getDoc(userRef);
            let currentStreak = 0;
            let lastCheckIn = null;
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                currentStreak = data.streak || 0;
                const history = data.history || [];
                if (history.length > 0) lastCheckIn = history[history.length - 1];
            }

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            if (lastCheckIn === yesterdayStr) {
                currentStreak++;
            } else if (lastCheckIn !== fullDate) {
                currentStreak = 1;
            }

            // Êõ¥Êñ∞ DB
            const newHistory = checkinHistory.includes(fullDate) ? checkinHistory : [...checkinHistory, fullDate];
            await setDoc(userRef, {
                email: currentUser.email,
                name: currentUser.displayName,
                streak: currentStreak,
                lastUpdate: fullDate,
                history: newHistory
            }, { merge: true });

            checkinHistory = newHistory;
            document.getElementById('streak-days').innerText = currentStreak;
            document.getElementById('total-days').innerText = checkinHistory.length;
            
            disableCheckInBtn("Success! üéâ");
            renderCalendar();
            
        } catch (e) {
            console.error(e);
            btn.disabled = false;
            btn.innerText = "Try Again";
        }
    };

    function disableCheckInBtn(msg) {
        const btn = document.getElementById('checkin-btn');
        btn.disabled = true;
        btn.innerText = msg;
        btn.style.background = "var(--surface)";
        btn.style.color = "var(--text)";
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';
        const now = new Date();
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        document.getElementById('current-month-display').innerText = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;
        
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        const currentYearMonth = now.toISOString().slice(0, 7); 
        
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'cal-day';
            dayEl.innerText = i;
            const dateStr = `${currentYearMonth}-${String(i).padStart(2, '0')}`;
            if (checkinHistory.includes(dateStr)) dayEl.classList.add('checked');
            grid.appendChild(dayEl);
        }
    }

    window.printRecords = () => {
        if (!currentUser) return;
        const printBody = document.getElementById('print-body');
        printBody.innerHTML = '';
        document.getElementById('print-name').innerText = currentUser.displayName;
        document.getElementById('print-date').innerText = new Date().toLocaleDateString();

        checkinHistory.sort().forEach(dateStr => { 
            const mmdd = dateStr.slice(5); 
            const wordObj = csvData.words.find(r => r.date === mmdd) || {};
            const quoteObj = csvData.quotes.find(r => r.date === mmdd) || {};
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${dateStr}</td>
                <td><strong>${wordObj.word || '-'}</strong> <br> ${wordObj.ipa || ''}</td>
                <td>${wordObj.meaning || '-'}</td>
                <td>${quoteObj['quote e'] || '-'}</td>
            `;
            printBody.appendChild(tr);
        });
        window.print();
    };

    // ÂÖ∂‰ªñ UI ÁâπÊïà (‰øùÁïôÊÇ®ÂéüÊú¨ÁöÑ)
    const titleElement = document.getElementById('animatedTitle');
    const textContent = titleElement.innerHTML; 
    const lines = textContent.split('<br>');
    let newHtml = '';
    lines.forEach((line, index) => {
        const words = line.split(' ');
        const wrappedWords = words.map(word => {
            const wrappedChars = word.split('').map(char => `<span class="char">${char}</span>`).join('');
            return `<span class="word" style="display: inline-block; white-space: nowrap;">${wrappedChars}</span>`; 
        }).join(' '); 
        newHtml += wrappedWords;
        if (index < lines.length - 1) newHtml += '<br>';
    });
    titleElement.innerHTML = newHtml;

    const canvas = document.getElementById('particle-canvas');
    const ctx = canvas.getContext('2d');
    let particlesArray;
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; initParticles(); });
    const mouse = { x: null, y: null, radius: 150 };
    window.addEventListener('mousemove', (event) => { mouse.x = event.x; mouse.y = event.y; });
    class Particle {
      constructor() {
        this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height;
        this.size = Math.random() * 2; this.speedX = (Math.random() * 0.4 - 0.2); this.speedY = (Math.random() * 0.4 - 0.2);
        this.opacity = Math.random(); this.pulseSpeed = 0.01; 
      }
      update() {
        this.x += this.speedX; this.y += this.speedY;
        if (this.x > canvas.width) this.x = 0; if (this.x < 0) this.x = canvas.width;
        if (this.y > canvas.height) this.y = 0; if (this.y < 0) this.y = canvas.height;
        this.opacity += this.pulseSpeed; if (this.opacity > 1 || this.opacity < 0.2) this.pulseSpeed = -this.pulseSpeed;
        let dx = mouse.x - this.x; let dy = mouse.y - this.y; let distance = Math.sqrt(dx*dx + dy*dy);
        if (distance < mouse.radius) { const angle = Math.atan2(dy, dx); this.x -= Math.cos(angle) * 1; this.y -= Math.sin(angle) * 1; }
      }
      draw(isDark) {
        ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        let color = isDark ? `rgba(241, 196, 15, ${this.opacity})` : `rgba(44, 62, 80, ${this.opacity * 0.3})`;
        ctx.fillStyle = color; ctx.fill();
      }
    }
    function initParticles() { particlesArray = []; let numberOfParticles = (canvas.width * canvas.height) / 12000; for (let i = 0; i < numberOfParticles; i++) { particlesArray.push(new Particle()); } }
    function animateParticles() {
      requestAnimationFrame(animateParticles);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const isDark = document.getElementById('htmlRoot').classList.contains('dark');
      const lineColor = isDark ? 'rgba(241, 196, 15, 0.1)' : 'rgba(44, 62, 80, 0.05)';
      for (let i = 0; i < particlesArray.length; i++) {
        particlesArray[i].update(); particlesArray[i].draw(isDark);
        for (let j = i; j < particlesArray.length; j++) {
            let dx = particlesArray[i].x - particlesArray[j].x; let dy = particlesArray[i].y - particlesArray[j].y; let distance = Math.sqrt(dx*dx + dy*dy);
            if (distance < 100) { ctx.beginPath(); ctx.strokeStyle = lineColor; ctx.lineWidth = 0.5; ctx.moveTo(particlesArray[i].x, particlesArray[i].y); ctx.lineTo(particlesArray[j].x, particlesArray[j].y); ctx.stroke(); }
        }
      }
    }
    initParticles(); animateParticles();

    const html = document.getElementById('htmlRoot');
    const toggleBtn = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'dark';
    if (savedTheme === 'light') { html.classList.remove('dark'); } else { html.classList.add('dark'); }
    toggleBtn.addEventListener('click', () => { html.classList.toggle('dark'); const isDark = html.classList.contains('dark'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); });

    const paragraphs = ["Hi there! üëã", "I‚Äôm Shirley...", "This is not just a website...", "Whether you‚Äôre a teacher...", "Everything here is free...", "Let‚Äôs make language learning..."];
    const letterBody = document.getElementById('letterBody');
    paragraphs.forEach(text => { const p = document.createElement('p'); p.textContent = text; letterBody.appendChild(p); });
    const openLetter = document.getElementById('openLetter'); const letterContent = document.getElementById('letterContent'); const closeLetter = document.getElementById('closeLetter'); const chimeSound = document.getElementById('chimeSound');
    openLetter.addEventListener('click', () => { chimeSound.currentTime = 0; chimeSound.play().catch(e => console.warn(e)); letterContent.classList.add('show'); document.body.classList.add('modal-open'); setTimeout(() => { letterBody.querySelectorAll('p').forEach((p, i) => { setTimeout(() => p.classList.add('show'), i * 300); }); }, 300); });
    function closeLetterModal() { letterContent.classList.remove('show'); document.body.classList.remove('modal-open'); letterBody.querySelectorAll('p').forEach(p => p.classList.remove('show')); }
    closeLetter.addEventListener('click', closeLetterModal);
    document.addEventListener('click', (e) => { if (letterContent.classList.contains('show') && !letterContent.contains(e.target) && !openLetter.contains(e.target)) { closeLetterModal(); } });

    const musicToggle = document.getElementById('musicToggle'); const themeSong = document.getElementById('themeSong'); let isPlaying = false;
    musicToggle.addEventListener('click', () => { if (isPlaying) { themeSong.pause(); musicToggle.classList.remove('playing'); musicToggle.style.color = "var(--text)"; } else { themeSong.currentTime = 0; themeSong.play().then(() => { musicToggle.classList.add('playing'); }).catch(e => { console.warn(e); alert("Click again to launch!"); }); } isPlaying = !isPlaying; });
    window.addEventListener('beforeunload', () => { if (!themeSong.paused) themeSong.pause(); });
  </script>
</body>
</html>
