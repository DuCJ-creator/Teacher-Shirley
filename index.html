<!DOCTYPE html>
<html lang="en" id="htmlRoot">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Teacher Shirley's ET Platform</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Exo+2:wght@300;400;500&family=Noto+Serif+TC:wght@400;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ™</text></svg>">
  
  <style id="themeStyles">
    :root {
      /* --- Light Mode (Morning Mist) --- */
      --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --surface: rgba(255, 255, 255, 0.9);
      --border: rgba(20, 30, 48, 0.15);
      --text: #1a2a3a; 
      --text-light: #485563;
      --accent: #b8860b; 
      --orbit-color: rgba(20, 30, 48, 0.2); 
      --orbit-glow: none;
      --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
      --info-bg: rgba(255, 255, 255, 0.95);
    }

    .dark {
      /* --- Dark Mode (Deep Nebula) --- */
      --bg-gradient: radial-gradient(circle at 50% 50%, #1b2735 0%, #090a0f 100%);
      --surface: rgba(30, 40, 55, 0.85);
      --border: rgba(255, 255, 255, 0.15);
      --text: #ecf0f1;
      --text-light: #bdc3c7;
      --accent: #f1c40f; 
      --orbit-color: rgba(255, 255, 255, 0.2); 
      --orbit-glow: 0 0 10px rgba(255, 255, 255, 0.05);
      --card-shadow: 0 15px 40px rgba(0,0,0,0.5);
      --info-bg: rgba(25, 35, 50, 0.85);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text);
      font-family: 'Exo 2', 'Noto Serif TC', serif;
      line-height: 1.6;
      transition: color 0.5s, background 0.5s;
      min-height: 100vh;
      overflow-x: hidden;
    }

    #particle-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
    
    /* --- Controls --- */
    .top-bar { position: absolute; top: 1.5rem; right: 2rem; display: flex; gap: 1rem; z-index: 2000; }
    .control-btn {
      background: var(--surface); border: 1px solid var(--border);
      width: 42px; height: 42px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: var(--text); font-size: 1.2rem;
      transition: all 0.3s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      backdrop-filter: blur(5px);
    }
    .control-btn:hover { transform: scale(1.1); color: var(--accent); border-color: var(--accent); }

    /* --- Header --- */
    header { display: flex; flex-direction: column; align-items: center; padding: 2rem 1rem 0; position: relative; z-index: 10; text-align: center; }
    .main-title { font-family: 'Cinzel Decorative', cursive; font-size: clamp(1.8rem, 5vw, 3.5rem); font-weight: 700; color: var(--text); line-height: 1.1; text-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .dark .main-title { color: #ffffff; text-shadow: 0 0 25px rgba(241, 196, 15, 0.5); }
    .title-underline { width: 80px; height: 3px; background: var(--accent); margin: 10px auto; border-radius: 2px; }

    /* ==================== UNIVERSE VIEW ==================== */
    #universe-view { 
        display: none; opacity: 0; transition: opacity 0.8s ease; 
        min-height: 85vh; width: 100%; position: relative; overflow: hidden; 
    }
    #universe-view.active { display: block; opacity: 1; }

    .solar-system { 
        position: relative; width: 100%; height: 85vh; 
        display: flex; justify-content: center; align-items: center; 
        transform: scale(1);
    }

    .orbit { 
        position: absolute; border: 1px dashed var(--orbit-color); box-shadow: var(--orbit-glow); 
        border-radius: 50%; top: 50%; left: 50%; pointer-events: none; transition: border-color 0.5s;
    }
    .orbit-1 { width: 320px; height: 320px; margin-top: -160px; margin-left: -160px; animation: spinOrbit 50s linear infinite; }
    .orbit-2 { width: 520px; height: 520px; margin-top: -260px; margin-left: -260px; animation: spinOrbit 90s linear infinite reverse; border-style: dotted; }
    .orbit-3 { width: 780px; height: 780px; margin-top: -390px; margin-left: -390px; animation: spinOrbit 140s linear infinite; }

    .mars-container { position: absolute; width: 320px; height: 320px; top: 50%; left: 50%; margin-top: -160px; margin-left: -160px; animation: spinOrbit 50s linear infinite; pointer-events: none; z-index: 5; }
    .mars-container:hover { animation-play-state: paused; }
    .mars-wrapper { position: absolute; width: 60px; height: 60px; top: -30px; left: 50%; margin-left: -30px; animation: spinCounter 50s linear infinite; pointer-events: auto; cursor: pointer; display: flex; flex-direction: column; align-items: center; }

    .static-planet-wrapper { position: absolute; z-index: 6; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.3s; }
    .static-planet-wrapper:hover { z-index: 100; }
    .static-planet-wrapper:hover .planet-visual { transform: scale(1.15); transition: transform 0.3s; }

    .pos-mercury { top: 50%; left: 50%; transform: translate(-50%, 260px) translate(-50%, -50%); margin-top: 30px; }
    .pos-saturn { top: 50%; left: 50%; transform: translate(-390px, 0) translate(-50%, -50%); margin-left: 20px; }
    .pos-jupiter { top: 50%; left: 50%; transform: translate(390px, 0) translate(-50%, -50%); margin-left: -20px; }

    .moon-wrapper { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
    .planet-moon { width: 100px; height: 100px; border-radius: 50%; background: radial-gradient(circle at 35% 35%, #f5f6fa, #bdc3c7); box-shadow: 0 0 50px rgba(255,255,255,0.6), inset -10px -10px 30px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.4); animation: bounce 2s ease-in-out infinite; }

    .planet-visual { width: 100%; height: 100%; border-radius: 50%; position: relative; }
    .p-mars { background: radial-gradient(#e74c3c, #c0392b); box-shadow: 0 0 25px rgba(231, 76, 60, 0.6); }
    .p-jupiter { width: 85px; height: 85px; background: radial-gradient(#f1c40f, #d35400); box-shadow: 0 0 35px rgba(241, 196, 15, 0.6); }
    .p-saturn { width: 75px; height: 75px; background: radial-gradient(#f39c12, #e67e22); border: 4px double rgba(255,255,255,0.3); box-shadow: 0 0 25px rgba(243, 156, 18, 0.4); }
    .p-mercury { width: 55px; height: 55px; background: radial-gradient(#dfe6e9, #95a5a6, #2c3e50); box-shadow: 0 0 25px rgba(189, 195, 199, 0.7); }

    .planet-info {
        position: absolute; width: 220px; background: var(--info-bg); backdrop-filter: blur(15px);
        padding: 12px 15px; border-radius: 12px; border: 1px solid var(--border);
        text-align: center; pointer-events: none; box-shadow: var(--card-shadow);
        bottom: 120%; left: 50%; transform: translateX(-50%);
    }
    .moon-info { width: 240px; bottom: 130%; }
    .p-name { font-family: 'Cinzel Decorative'; font-weight: 700; font-size: 1.1rem; color: var(--text); margin-bottom: 4px; display:block; }
    .p-poem-cn { font-family: 'Noto Serif TC', serif; font-size: 0.85rem; color: var(--text); line-height: 1.4; margin-bottom: 3px; font-weight: 600; }
    .p-poem-en { font-family: 'Playfair Display', serif; font-size: 0.75rem; color: var(--text-light); font-style: italic; line-height: 1.2; }
    .checkin-tag { display: block; margin-top: 8px; background: linear-gradient(90deg, var(--accent), #f39c12); color: white; font-size: 0.75rem; padding: 4px 10px; border-radius: 15px; font-weight: bold; box-shadow: 0 3px 8px rgba(0,0,0,0.2); }

    @keyframes spinOrbit { 100% { transform: rotate(360deg); } }
    @keyframes spinCounter { 100% { transform: rotate(-360deg); } }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }

    @media (max-width: 1024px) { .solar-system { transform: scale(0.75); } }
    @media (max-width: 768px) { .solar-system { transform: scale(0.55); height: 70vh; } }
    @media (max-width: 420px) { .solar-system { transform: scale(0.42); } .pos-mercury { margin-top: 60px; } }

    /* ==================== REST OF THE SITE ==================== */
    /* Envelope */
    #intro-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); z-index: 5000; display: flex; align-items: center; justify-content: center; transition: opacity 1s ease; }
    .envelope-container { position: relative; cursor: pointer; width: 320px; height: 210px; transition: transform 0.5s ease; animation: floatEnv 4s ease-in-out infinite; }
    .envelope-container:hover { transform: scale(1.05); }
    .envelope-body { position: absolute; bottom: 0; width: 100%; height: 100%; background: #e6dac8; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border-radius: 5px; overflow: hidden; z-index: 2; }
    .envelope-txt { position: absolute; z-index: 10; text-align: center; width: 100%; top: 55%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; padding: 0 10px; }
    .env-title { font-family: 'Cinzel Decorative'; font-size: 1.1rem; color: #5d4037; margin-bottom: 5px; }
    .env-subtitle { font-family: 'Dancing Script', font-size: 1.2rem; color: #8d6e63; margin-bottom: 15px; }
    .env-highlight { font-family: 'Exo 2'; font-weight: 700; color: #c0392b; font-size: 0.85rem; margin-bottom: 2px; }
    .env-cn { font-family: 'Noto Sans TC'; font-size: 0.75rem; color: #6d4c41; font-weight: 500; }
    .envelope-flap { position: absolute; top: 0; left: 0; width: 0; height: 0; border-left: 160px solid transparent; border-right: 160px solid transparent; border-top: 130px solid #dccbb1; transform-origin: top; transition: transform 0.8s ease 0.2s, z-index 0.2s; z-index: 3; }
    .envelope-pocket { position: absolute; bottom: 0; left: 0; width: 0; height: 0; border-left: 160px solid #f0e6d6; border-right: 160px solid #ece0cd; border-bottom: 110px solid #f8f1e5; border-top: 110px solid transparent; z-index: 4; }
    .heart-seal { position: absolute; top: -55px; left: -15px; font-size: 2rem; color: #c0392b; animation: heartBeat 1.5s infinite; }
    .envelope-container.open .envelope-flap { transform: rotateX(180deg); z-index: 1; }
    .envelope-container.open { animation: none; transform: scale(1.5); opacity: 0; pointer-events: none; transition: opacity 0.5s 1s, transform 1s; }
    @keyframes floatEnv { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    @keyframes heartBeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }

    /* Letter */
    .letter-paper { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8); width: 95%; max-width: 750px; height: auto; max-height: 95vh; background: radial-gradient(circle at 50% 0%, #ffffff 10%, #f7f4e9 80%); box-shadow: 0 0 60px rgba(0,0,0,0.6), inset 0 0 40px rgba(255,255,255,0.8), inset 0 0 10px rgba(212, 175, 55, 0.1); padding: 2.5rem 3rem; opacity: 0; pointer-events: none; transition: all 0.8s ease 0.8s; overflow-y: auto; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.8); display: flex; flex-direction: column; }
    .letter-paper::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('https://ducj-creator.github.io/Teacher-Shirley/assets/Shirley.png'); background-size: cover; background-position: center; filter: blur(6px) grayscale(20%); opacity: 0.1; z-index: 0; pointer-events: none; }
    .sparkle-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: hidden; }
    .sparkle { position: absolute; width: 4px; height: 4px; background: rgba(212, 175, 55, 0.6); border-radius: 50%; box-shadow: 0 0 4px rgba(255, 255, 255, 0.8); animation: floatSparkle 4s infinite linear; }
    .sparkle:nth-child(1) { top: 10%; left: 20%; animation-duration: 3s; } .sparkle:nth-child(2) { top: 30%; left: 80%; animation-duration: 5s; } .sparkle:nth-child(3) { top: 60%; left: 10%; animation-duration: 4s; }
    @keyframes floatSparkle { 0% { opacity: 0; } 50% { opacity: 1; transform: translateY(-20px) scale(1.2); } 100% { transform: translateY(-40px) scale(0); opacity: 0; } }
    .letter-paper.show { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
    .letter-content { position: relative; z-index: 2; color: #2c3e50; font-family: 'Playfair Display', serif; }
    .letter-p { margin-bottom: 0.8rem; font-size: 1.05rem; line-height: 1.5; opacity: 0; transform: translateY(10px); transition: all 0.6s ease; text-align: justify; }
    .letter-p.visible { opacity: 1; transform: translateY(0); }
    .cn-text { display: block; font-family: 'Noto Sans TC'; font-size: 0.95rem; color: #7f8c8d; margin-top: 2px; line-height: 1.4; }
    .signature { text-align: right; font-family: 'Dancing Script', cursive; font-size: 1.5rem; margin: 1rem 0; color: var(--accent); }

    .choice-area { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.1); display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; opacity: 0; transition: opacity 1s ease 0.5s; }
    .choice-area.visible { opacity: 1; }
    .btn-letter { padding: 8px 20px; border-radius: 25px; border: none; font-family: 'Exo 2'; font-weight: 600; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center; min-width: 140px; }
    .btn-visitor { background: transparent; border: 1px solid #8d6e63; color: #5d4037; }
    .btn-visitor:hover { background: rgba(141, 110, 99, 0.1); }
    .btn-login { background: var(--accent); color: white; border: 1px solid var(--accent); box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
    .btn-login:hover { background: var(--accent-hover); transform: translateY(-2px); }

    #auth-form-container { display: none; margin-top: 10px; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
    .google-btn { width: 100%; padding: 10px; background: white; color: #555; border-radius: 6px; border: 1px solid #ddd; cursor: pointer; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .input-group input { width: 100%; padding: 8px; margin-bottom: 8px; border-radius: 4px; border: 1px solid #ccc; font-family: 'Exo 2'; }
    .email-btn { width: 100%; padding: 8px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; }

    /* Views */
    #visitor-view { display: none; opacity: 0; transition: opacity 0.5s ease; padding-bottom: 5rem; }
    #visitor-view.active { display: block; opacity: 1; }
    .categories { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; padding: 0 2rem; max-width: 1000px; margin: 0 auto; position: relative; z-index: 5; }
    .category-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 2.5rem 1.5rem; text-align: center; text-decoration: none; color: var(--text); transition: all 0.4s; box-shadow: var(--card-shadow); display: flex; flex-direction: column; align-items: center; }
    .category-card:hover { transform: translateY(-8px); border-color: var(--accent); }
    .icon { font-size: 3rem; margin-bottom: 1rem; }

    #member-terminal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.95); width: 90%; max-width: 900px; max-height: 85vh; overflow-y: auto; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 2.5rem; z-index: 200; box-shadow: 0 25px 80px rgba(0,0,0,0.4); display: none; opacity: 0; transition: all 0.3s; backdrop-filter: blur(10px); }
    #member-terminal.show { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .close-terminal { position: absolute; top: 20px; right: 25px; font-size: 1.5rem; cursor: pointer; }
    .member-dashboard { display: grid; grid-template-columns: 280px 1fr; gap: 2rem; margin-top: 1rem; }
    @media (max-width: 800px) { .member-dashboard { grid-template-columns: 1fr; } }
    .profile-panel { background: rgba(0,0,0,0.02); border-radius: 16px; padding: 2rem; text-align: center; border: 1px solid var(--border); }
    .streak-ring { width: 110px; height: 110px; border: 5px solid var(--accent); border-radius: 50%; margin: 0 auto 1.5rem; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .streak-num { font-size: 2.5rem; font-weight: 800; color: var(--accent); }
    .data-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; }
    .word-card { border-left: 5px solid #3498db; }
    .quote-card { border-left: 5px solid #f1c40f; margin-top: 1rem; }
    .checkin-btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 15px; }
    .checkin-btn:disabled { background: #bdc3c7; cursor: not-allowed; }

    /* Print Modal Styles */
    #print-selection-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .print-modal-content { background: white; width: 90%; max-width: 700px; border-radius: 12px; padding: 25px; display: flex; flex-direction: column; max-height: 90vh; color: #333; }
    .print-modal-header { font-family: 'Cinzel Decorative'; font-size: 1.5rem; color: #2c3e50; border-bottom: 2px solid var(--accent); padding-bottom: 10px; margin-bottom: 15px; text-align: center; }
    .print-controls { display: flex; justify-content: space-between; margin-bottom: 10px; background: #f8f9fa; padding: 10px; border-radius: 8px; }
    .selection-list { flex-grow: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px; margin-bottom: 20px; max-height: 400px; }
    .log-item-row { display: flex; align-items: center; padding: 8px 5px; border-bottom: 1px solid #eee; transition: background 0.2s; }
    .log-item-row:hover { background: #f1f2f6; }
    .log-item-row input[type="checkbox"] { margin-right: 15px; transform: scale(1.2); cursor: pointer; }
    .log-details { display: flex; flex-direction: column; font-size: 0.9rem; }
    .log-time { font-size: 0.8rem; color: #666; font-family: 'Exo 2'; }
    .log-action { font-weight: 600; color: #2c3e50; }
    .print-actions { display: flex; gap: 15px; justify-content: center; }
    .action-btn { padding: 10px 25px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; font-family: 'Exo 2'; transition: all 0.2s; }
    .btn-cancel { background: #95a5a6; color: white; }
    .btn-confirm { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    .btn-confirm:hover { transform: scale(1.05); }

    .print-only { display: none; }
    @media print { 
        body * { visibility: hidden; } 
        #print-area, #print-area * { visibility: visible; } 
        #print-area { position: absolute; left: 0; top: 0; width: 100%; color: black; background: white; padding: 20px; } 
        .print-only { display: block; } 
        table { width: 100%; border-collapse: collapse; margin-top: 20px; } 
        th, td { border: 1px solid #333; padding: 10px; text-align: left; } 
        th { background: #f0f0f0; }
    }

    .highlight-box {
        display: inline-block;
        font-weight: 900; font-style: italic; color: #5d4037;
        border: 2px solid var(--accent); border-radius: 8px;
        padding: 5px 12px; margin: 5px 0;
        background: rgba(255, 255, 255, 0.6);
        box-shadow: 3px 3px 0px rgba(184, 134, 11, 0.2);
        text-decoration: underline; text-decoration-style: wavy;
        text-decoration-thickness: 1.5px; line-height: 1.6;
    }
    .highlight-box .key-term {
        color: #c0392b; text-decoration: none; border-bottom: 2px solid #c0392b;
    }

    /* --- In-App Browser Warning Overlay --- */
    #in-app-browser-warning {
        display: none; /* Default hidden, triggered via JS */
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 9999;
        flex-direction: column; justify-content: center; align-items: center;
        text-align: center; color: white; padding: 30px;
    }
    .warning-icon { font-size: 3rem; margin-bottom: 15px; }
    .warning-title { font-size: 1.4rem; font-weight: bold; margin-bottom: 15px; font-family: 'Exo 2', sans-serif; }
    .warning-text { font-size: 1rem; line-height: 1.6; margin-bottom: 25px; color: #ddd; max-width: 500px; }
    .arrow-hint { position: absolute; top: 10px; right: 20px; font-size: 3rem; animation: bounceRight 1.5s infinite; color: var(--accent); }
    @keyframes bounceRight { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(-10px); } }
    
    .warning-actions { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 300px; }
    .btn-warning { padding: 12px; border: none; border-radius: 25px; font-weight: bold; font-family: 'Exo 2'; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-copy { background: #3498db; color: white; }
    .btn-close-warning { background: transparent; border: 1px solid #7f8c8d; color: #bdc3c7; }

    /* ==================== NEW MOON CARD STYLES ==================== */
    /* å¡ç‰‡æ¨¡æ…‹æ¡†å®¹å™¨ */
    #card-modal {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 6000; justify-content: center; align-items: center;
        opacity: 0; transition: opacity 0.4s ease;
    }
    #card-modal.active { display: flex; opacity: 1; }
    
    .card-overlay-bg { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
    
    .card-display-container { 
        position: relative; z-index: 2; display: flex; flex-direction: column; 
        align-items: center; gap: 20px; transform: scale(0.9); 
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    }
    #card-modal.active .card-display-container { transform: scale(1); }

    /* --- æ ¸å¿ƒå¡ç‰‡çµæ§‹ (360x580) --- */
    .moon-card {
        width: 360px; min-height: 580px;
        background: var(--card-bg, #1a1a2e);
        border: 2px solid var(--card-border, #4a4e69);
        border-radius: 20px;
        padding: 30px 25px;
        color: var(--card-text, #e0e1dd);
        position: relative;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 60px rgba(0,0,0,0.2);
        font-family: 'Exo 2', sans-serif;
        overflow: hidden;
        display: flex; flex-direction: column;
    }

    /* å¡ç‰‡å…§éƒ¨å…ƒç´  */
    .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--card-accent-dim, rgba(255,255,255,0.2)); padding-bottom: 15px; margin-bottom: 20px; }
    .card-title { font-family: 'Cinzel Decorative'; font-weight: 900; font-size: 0.9rem; letter-spacing: 1px; color: var(--card-accent, #c9d1d9); text-transform: uppercase; }
    .card-serial { font-family: 'Exo 2'; font-size: 0.7rem; color: var(--card-text-dim, #778ca3); letter-spacing: 1px; }

    .card-greeting { font-family: 'Playfair Display'; font-size: 1.5rem; font-weight: 700; color: var(--card-highlight, #fff); line-height: 1.2; margin-bottom: 5px; }
    .card-subtitle { font-family: 'Noto Serif TC'; font-size: 0.85rem; color: var(--card-text-dim, #a0a0a0); font-style: italic; margin-bottom: 15px; }

    .card-divider { text-align: center; color: var(--card-accent, #ffd700); font-size: 1.2rem; margin: 15px 0; opacity: 0.7; }

    .card-content-box { text-align: center; margin-bottom: 20px; }
    .card-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 2px; color: var(--card-accent, #ffd700); margin-bottom: 5px; opacity: 0.8; }
    .card-wotd { font-family: 'Playfair Display'; font-size: 2.2rem; font-weight: 700; color: var(--card-highlight, #fff); text-shadow: 0 2px 10px rgba(255,255,255,0.2); line-height: 1; margin-bottom: 5px; }
    .card-pos { font-family: 'Exo 2'; font-size: 0.8rem; background: var(--card-accent-dim, rgba(255,255,255,0.1)); display: inline-block; padding: 2px 8px; border-radius: 4px; margin-bottom: 8px; }
    .card-def { font-family: 'Noto Serif TC'; font-size: 1rem; color: var(--card-text, #ddd); line-height: 1.4; font-weight: 600; }
    
    /* ä¾‹å¥æ¨£å¼ */
    .card-sentence-container { margin-top: 15px; padding-top: 10px; border-top: 1px dashed var(--card-accent-dim, rgba(255,255,255,0.1)); }
    .card-sent-en { font-family: 'Exo 2'; font-style: italic; font-size: 0.9rem; color: var(--card-text-dim, #ccc); margin-bottom: 5px; line-height: 1.3; font-weight:500; }
    .card-sent-cn { font-family: 'Noto Serif TC'; font-size: 0.85rem; color: var(--card-text-dim, #888); opacity: 0.8; }

    /* ä½³å¥èˆ‡ç¿»è­¯æ¨£å¼ */
    .card-quote-box { position: relative; padding: 15px; border-left: 3px solid var(--card-accent, #ffd700); background: linear-gradient(90deg, var(--card-accent-dim, rgba(255,255,255,0.05)), transparent); margin-top: auto; }
    .card-quote-text { font-family: 'Playfair Display'; font-style: italic; font-size: 1rem; line-height: 1.5; color: var(--card-text, #eee); }
    .card-quote-trans { font-family: 'Noto Serif TC', serif; font-size: 0.9rem; color: var(--card-text-dim, #ccc); margin-top: 8px; font-style: normal; line-height: 1.4; opacity: 0.9; }
    .card-quote-author { text-align: right; font-size: 0.8rem; font-weight: bold; margin-top: 8px; color: var(--card-accent, #ffd700); }

    .card-footer { margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--card-accent-dim, rgba(255,255,255,0.2)); display: flex; justify-content: space-between; align-items: center; }
    .card-streak-badge { background: var(--card-accent, #ffd700); color: var(--card-bg, #000); padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; box-shadow: 0 0 10px var(--card-accent-dim, rgba(255,215,0,0.4)); display: flex; align-items: center; gap: 5px; }
    .card-signature { font-family: 'Dancing Script'; font-size: 1.5rem; color: var(--card-text-dim, #aaa); transform: rotate(-5deg); }

    .card-watermark { position: absolute; bottom: 10px; right: 20px; font-size: 4rem; font-weight: 900; color: rgba(255,255,255,0.03); pointer-events: none; z-index: 0; font-family: 'Cinzel Decorative'; white-space: nowrap; }
    .card-shine { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(125deg, transparent 40%, rgba(255,255,255,0.05) 45%, transparent 50%); pointer-events: none; }

    /* æŒ‰éˆ•æ¨£å¼ */
    .card-actions { display: flex; gap: 15px; margin-top: 15px; }
    .btn-card-action { padding: 10px 20px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; transition: transform 0.2s; font-family: 'Exo 2'; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
    .btn-download { background: linear-gradient(90deg, #b8860b, #f1c40f); color: #2c3e50; box-shadow: 0 4px 15px rgba(241, 196, 15, 0.3); }
    .btn-close { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); }
    .btn-card-action:hover { transform: translateY(-3px); filter: brightness(1.1); }

    /* === 11 ç¨®é«˜é›…æ¨¡æ¿æ¨£å¼ === */
    /* 1. Midnight Gold (ç¶“å…¸é»‘é‡‘) */
    .theme-1 { --card-bg: linear-gradient(180deg, #0f2027, #203a43, #2c5364); --card-border: #b8860b; --card-accent: #ffd700; --card-highlight: #fff; --card-text: #e0e0e0; --card-text-dim: #8fa1b3; --card-accent-dim: rgba(184, 134, 11, 0.2); }
    /* 2. Silver Mist (å†·éŠ€æœˆéœ§) */
    .theme-2 { --card-bg: linear-gradient(135deg, #2c3e50, #4ca1af); --card-border: #bdc3c7; --card-accent: #ecf0f1; --card-highlight: #fff; --card-text: #ecf0f1; --card-text-dim: #bdc3c7; --card-accent-dim: rgba(255,255,255,0.2); }
    /* 3. Deep Nebula (æ·±é‚ƒæ˜Ÿé›² - ç´«) */
    .theme-3 { --card-bg: radial-gradient(circle at 10% 20%, #240b36, #c31432); --card-border: #ffafbd; --card-accent: #ffc3a0; --card-highlight: #fff0f5; --card-text: #ffe4e1; --card-text-dim: #d8bfd8; --card-accent-dim: rgba(255,175,189,0.2); }
    /* 4. Obsidian (é»‘æ›œçŸ³) */
    .theme-4 { --card-bg: #121212; --card-border: #333; --card-accent: #fff; --card-highlight: #fff; --card-text: #ccc; --card-text-dim: #666; --card-accent-dim: rgba(255,255,255,0.1); }
    /* 5. Royal Blue (çš‡å®¶å¤œè—) */
    .theme-5 { --card-bg: linear-gradient(to bottom, #141e30, #243b55); --card-border: #f1c40f; --card-accent: #f39c12; --card-highlight: #fff; --card-text: #ecf0f1; --card-text-dim: #95a5a6; --card-accent-dim: rgba(241, 196, 15, 0.15); }
    /* 6. Lunar Ash (æœˆå¡µç°) */
    .theme-6 { --card-bg: linear-gradient(to top, #304352, #d7d2cc); --card-border: #7f8c8d; --card-accent: #2c3e50; --card-highlight: #2c3e50; --card-text: #1a252f; --card-text-dim: #546e7a; --card-accent-dim: rgba(0,0,0,0.1); }
    /* 7. Crimson Eclipse (è¡€æœˆ) */
    .theme-7 { --card-bg: linear-gradient(160deg, #4b134f, #190a05); --card-border: #c0392b; --card-accent: #e74c3c; --card-highlight: #fff; --card-text: #fdcb6e; --card-text-dim: #fab1a0; --card-accent-dim: rgba(231, 76, 60, 0.2); }
    /* 8. Aurora (æ¥µå…‰) */
    .theme-8 { --card-bg: linear-gradient(to right, #00416a, #799f0c, #ffe000); --card-border: #a8ff78; --card-accent: #78ffd6; --card-highlight: #fff; --card-text: #f0f0f0; --card-text-dim: #a8e063; --card-accent-dim: rgba(120, 255, 214, 0.2); }
    /* 9. Vintage Parchment (å¤è€ç¾Šçš®å·) */
    .theme-9 { --card-bg: linear-gradient(to bottom, #3e2b14, #2c1e0e); --card-border: #d4af37; --card-accent: #c5a059; --card-highlight: #f3e5ab; --card-text: #e6d2b5; --card-text-dim: #8b7355; --card-accent-dim: rgba(212, 175, 55, 0.2); }
    /* 10. Starry Night (æ¢µè°·æ˜Ÿç©º) */
    .theme-10 { --card-bg: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); --card-border: rgba(255,255,255,0.4); --card-accent: #fff; --card-highlight: #fff; --card-text: #fff; --card-text-dim: rgba(255,255,255,0.6); --card-accent-dim: rgba(255,255,255,0.1); }
    /* 11. Cyber Moon (è³½åšé¾å…‹) */
    .theme-11 { --card-bg: linear-gradient(45deg, #111, #222); --card-border: #0ff; --card-accent: #0ff; --card-highlight: #fff; --card-text: #eee; --card-text-dim: #0aa; --card-accent-dim: rgba(0, 255, 255, 0.2); border-width: 1px; box-shadow: 0 0 15px rgba(0,255,255,0.2); }
    /* --- æ–°å¢æ™®é€šæ¬¾ Theme 12 - 29 --- */
    /* 12. Ocean Depth (æ·±æµ·) */
    .theme-12 { --card-bg: linear-gradient(180deg, #1cb5e0 0%, #000851 100%); --card-border: #89f7fe; --card-accent: #66a6ff; --card-highlight: #fff; --card-text: #e2f0f9; --card-text-dim: #89f7fe; --card-accent-dim: rgba(137, 247, 254, 0.2); }
    /* 13. Mint Leaf (è–„è·) */
    .theme-13 { --card-bg: linear-gradient(45deg, #81fbb8 0%, #28c76f 100%); --card-border: #fff; --card-accent: #0f4c2e; --card-highlight: #e0ffd4; --card-text: #082015; --card-text-dim: #1e5c3e; --card-accent-dim: rgba(255,255,255,0.3); }
    /* 14. Sweet Candy (ç³–æœ) */
    .theme-14 { --card-bg: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); --card-border: #ff6f91; --card-accent: #ff80bf; --card-highlight: #fff; --card-text: #5e2c3a; --card-text-dim: #965f70; --card-accent-dim: rgba(255, 111, 145, 0.2); }
    /* 15. Royal Purple (çš‡å®¤) */
    .theme-15 { --card-bg: linear-gradient(to right, #654ea3, #eaafc8); --card-border: #ffd700; --card-accent: #ffd700; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #e0c3fc; --card-accent-dim: rgba(255, 215, 0, 0.2); }
    /* 16. Volcano (ç«å±±) */
    .theme-16 { --card-bg: linear-gradient(to top, #ff0844 0%, #ffb199 100%); --card-border: #520000; --card-accent: #8b0000; --card-highlight: #fff; --card-text: #520000; --card-text-dim: #941818; --card-accent-dim: rgba(82, 0, 0, 0.1); }
    /* 17. Cyberpunk (è³½åš) */
    .theme-17 { --card-bg: linear-gradient(180deg, #0f0c29, #302b63, #24243e); --card-border: #00f260; --card-accent: #0575e6; --card-highlight: #00f260; --card-text: #00f260; --card-text-dim: #0575e6; --card-accent-dim: rgba(0, 242, 96, 0.15); }
    /* 18. Coffee Time (å’–å•¡) */
    .theme-18 { --card-bg: linear-gradient(to right, #d7d2cc 0%, #304352 100%); --card-border: #5d4037; --card-accent: #8d6e63; --card-highlight: #3e2723; --card-text: #1a1a1a; --card-text-dim: #4e342e; --card-accent-dim: rgba(93, 64, 55, 0.1); }
    /* 19. Forest Night (æ£®å¤œ) */
    .theme-19 { --card-bg: linear-gradient(to bottom, #093028, #237a57); --card-border: #43cca1; --card-accent: #43cca1; --card-highlight: #fff; --card-text: #d4fc79; --card-text-dim: #96e6a1; --card-accent-dim: rgba(67, 204, 161, 0.2); }
    /* 20. Lemonade (æª¸æª¬) */
    .theme-20 { --card-bg: linear-gradient(120deg, #f6d365 0%, #fda085 100%); --card-border: #fff; --card-accent: #d35400; --card-highlight: #fff; --card-text: #d35400; --card-text-dim: #e67e22; --card-accent-dim: rgba(255,255,255,0.4); }
    /* 21. Steel Grey (é‹¼éµ) */
    .theme-21 { --card-bg: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%); --card-border: #7f8c8d; --card-accent: #2c3e50; --card-highlight: #bdc3c7; --card-text: #2c3e50; --card-text-dim: #7f8c8d; --card-accent-dim: rgba(44, 62, 80, 0.1); }
    /* 22. Rose Gold (ç«ç‘°é‡‘) */
    .theme-22 { --card-bg: linear-gradient(to right, #fff1eb 0%, #ace0f9 100%); --card-border: #b76e79; --card-accent: #b76e79; --card-highlight: #fff; --card-text: #5e3b42; --card-text-dim: #b76e79; --card-accent-dim: rgba(183, 110, 121, 0.2); }
    /* 23. Neon City (éœ“è™¹) */
    .theme-23 { --card-bg: #111; --card-border: #ff00de; --card-accent: #00ffea; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #ff00de; --card-accent-dim: rgba(255, 0, 222, 0.2); box-shadow: 0 0 15px rgba(255,0,222,0.4); }
    /* 24. Desert Sand (æ²™æ¼ ) */
    .theme-24 { --card-bg: linear-gradient(to bottom, #C06C84, #6C5B7B, #355C7D); --card-border: #F8B195; --card-accent: #F67280; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #F8B195; --card-accent-dim: rgba(248, 177, 149, 0.2); }
    /* 25. Frozen (å†°é›ª) */
    .theme-25 { --card-bg: linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%); --card-border: #fff; --card-accent: #6a11cb; --card-highlight: #fff; --card-text: #4a00e0; --card-text-dim: #8e2de2; --card-accent-dim: rgba(255,255,255,0.5); }
    /* 26. Matcha (æŠ¹èŒ¶) */
    .theme-26 { --card-bg: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); --card-border: #2d6a4f; --card-accent: #1b4332; --card-highlight: #fff; --card-text: #081c15; --card-text-dim: #2d6a4f; --card-accent-dim: rgba(45, 106, 79, 0.2); }
    /* 27. Sunset (æ—¥è½) */
    .theme-27 { --card-bg: linear-gradient(to right, #ffecd2 0%, #fcb69f 100%); --card-border: #ff6b6b; --card-accent: #ff6b6b; --card-highlight: #fff; --card-text: #c0392b; --card-text-dim: #e17055; --card-accent-dim: rgba(255, 107, 107, 0.2); }
    /* 28. Blackboard (é»‘æ¿) */
    .theme-28 { --card-bg: #2d3436; --card-border: #dfe6e9; --card-accent: #fd79a8; --card-highlight: #fff; --card-text: #dfe6e9; --card-text-dim: #b2bec3; --card-accent-dim: rgba(255,255,255,0.1); border-style: dashed; }
    /* 29. Ink Wash (æ°´å¢¨) */
    .theme-29 { --card-bg: linear-gradient(to bottom, #ffffff, #dcdcdc); --card-border: #000; --card-accent: #c0392b; --card-highlight: #000; --card-text: #000; --card-text-dim: #555; --card-accent-dim: rgba(0,0,0,0.1); }

   /* --- 30-39: ç å¯¶èˆ‡ç¤¦çŸ³ç³»åˆ— (Gemstones & Minerals) --- */
    
    /* 30. White Pearl (ç™½çç ) - æº«æ½¤å…‰æ¾¤ */
    .theme-30 { --card-bg: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); --card-border: #d7d7d7; --card-accent: #b0b0b0; --card-highlight: #fff; --card-text: #2c3e50; --card-text-dim: #7f8c8d; --card-accent-dim: rgba(0,0,0,0.05); }

    /* 31. Emerald City (ç¥–æ¯ç¶ ) - æ·±é‚ƒå°Šè²´ */
    .theme-31 { --card-bg: linear-gradient(to bottom right, #051937, #004d40); --card-border: #00897b; --card-accent: #26a69a; --card-highlight: #b2dfdb; --card-text: #e0f2f1; --card-text-dim: #80cbc4; --card-accent-dim: rgba(38, 166, 154, 0.2); }

    /* 32. Royal Amethyst (çš‡å®¶ç´«æ™¶) - ç¥ç§˜å¥¢è¯ */
    .theme-32 { --card-bg: radial-gradient(circle at top right, #360033, #0b8793); --card-border: #d1c4e9; --card-accent: #e1bee7; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #b39ddb; --card-accent-dim: rgba(225, 190, 231, 0.15); }

    /* 33. Sapphire Night (è—å¯¶çŸ³) - éœè¬æ·±è— */
    .theme-33 { --card-bg: linear-gradient(160deg, #002244, #001122); --card-border: #1565c0; --card-accent: #42a5f5; --card-highlight: #fff; --card-text: #e3f2fd; --card-text-dim: #90caf9; --card-accent-dim: rgba(66, 165, 245, 0.2); }

    /* 34. Ruby Wine (ç´…å¯¶çŸ³é…’ç´…) - é†‡åšè³ªæ„Ÿ */
    .theme-34 { --card-bg: linear-gradient(to bottom, #4a0000, #2b0000); --card-border: #b71c1c; --card-accent: #ff5252; --card-highlight: #ffcdd2; --card-text: #ffebee; --card-text-dim: #ef9a9a; --card-accent-dim: rgba(255, 82, 82, 0.2); }

    /* 35. Black Opal (é»‘è›‹ç™½çŸ³) - æš—å¤œæµå…‰ */
    .theme-35 { --card-bg: linear-gradient(45deg, #141e30, #243b55); --card-border: #00bcd4; --card-accent: #00e5ff; --card-highlight: #e0f7fa; --card-text: #eceff1; --card-text-dim: #607d8b; --card-accent-dim: rgba(0, 229, 255, 0.1); }

    /* 36. Amber Fossil (ç¥ç€) - å‡å›ºæ™‚å…‰ */
    .theme-36 { --card-bg: linear-gradient(to right, #b46105, #5e3100); --card-border: #ffca28; --card-accent: #ffd54f; --card-highlight: #fff8e1; --card-text: #fff; --card-text-dim: #ffecb3; --card-accent-dim: rgba(255, 213, 79, 0.2); }

    /* 37. Moonstone (æœˆå…‰çŸ³) - å¤¢å¹»è—æšˆ */
    .theme-37 { --card-bg: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%); --card-border: #aab7b8; --card-accent: #78909c; --card-highlight: #fff; --card-text: #455a64; --card-text-dim: #90a4ae; --card-accent-dim: rgba(120, 144, 156, 0.1); }

    /* 38. Jade Dragon (å¢¨ç‰) - æ±æ–¹å¤å…¸ */
    .theme-38 { --card-bg: linear-gradient(to bottom, #1d2b25, #0f1612); --card-border: #69f0ae; --card-accent: #b9f6ca; --card-highlight: #fff; --card-text: #e8f5e9; --card-text-dim: #81c784; --card-accent-dim: rgba(105, 240, 174, 0.1); }

    /* 39. Bronze Age (é’éŠ…æ™‚ä»£) - å¾©å¤é‡‘å±¬ */
    .theme-39 { --card-bg: linear-gradient(to right, #4b3832, #2c1e18); --card-border: #cd7f32; --card-accent: #d7a877; --card-highlight: #fff; --card-text: #f5deb3; --card-text-dim: #a1887f; --card-accent-dim: rgba(205, 127, 50, 0.2); }

    /* --- 40-49: è‡ªç„¶èˆ‡æ°›åœç³»åˆ— (Nature & Atmosphere) --- */

    /* 40. Nordic Aurora (åŒ—æ­æ¥µå…‰) - å¹½å†·æ¥µç°¡ */
    .theme-40 { --card-bg: #1c2329; --card-border: #4a6fa5; --card-accent: #90caf9; --card-highlight: #e3f2fd; --card-text: #eceff1; --card-text-dim: #78909c; --card-accent-dim: rgba(144, 202, 249, 0.1); }

    /* 41. Deep Ocean (æ·±æµ·æ½›è¡Œ) - æ¼¸å±¤è—ç¶  */
    .theme-41 { --card-bg: linear-gradient(180deg, #1a2980 0%, #26d0ce 100%); --card-border: #81d4fa; --card-accent: #4dd0e1; --card-highlight: #e0f7fa; --card-text: #e1f5fe; --card-text-dim: #80deea; --card-accent-dim: rgba(77, 208, 225, 0.2); }

    /* 42. Sakura Rain (æ«»èŠ±é›¨) - æŸ”ç¾ç²‰å«© */
    .theme-42 { --card-bg: linear-gradient(to right, #ffecd2 0%, #fcb69f 100%); --card-border: #ffab91; --card-accent: #ff8a65; --card-highlight: #fff; --card-text: #5d4037; --card-text-dim: #a1887f; --card-accent-dim: rgba(255, 138, 101, 0.2); }

    /* 43. Desert Gold (æµæ²™é‡‘) - æº«æš–è¼ç…Œ */
    .theme-43 { --card-bg: linear-gradient(to bottom, #C06C84, #6C5B7B, #355C7D); --card-border: #f8b195; --card-accent: #ffccbc; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #ffab91; --card-accent-dim: rgba(248, 177, 149, 0.2); }

    /* 44. Misty Forest (è¿·éœ§æ£®æ—) - ä½é£½å’Œç¶  */
    .theme-44 { --card-bg: linear-gradient(to top, #2C3E50, #4CA1AF); --card-border: #80cbc4; --card-accent: #b2dfdb; --card-highlight: #e0f2f1; --card-text: #e0f7fa; --card-text-dim: #80deea; --card-accent-dim: rgba(178, 223, 219, 0.1); }

    /* 45. Lavender Dream (è–°è¡£è‰å¤¢) - æ·¡é›…ç´« */
    .theme-45 { --card-bg: linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%); --card-border: #9fa8da; --card-accent: #7986cb; --card-highlight: #fff; --card-text: #303f9f; --card-text-dim: #5c6bc0; --card-accent-dim: rgba(121, 134, 203, 0.2); }

    /* 46. Volcanic Ash (ç«å±±ç°) - å†·å†½è³ªæ„Ÿ */
    .theme-46 { --card-bg: linear-gradient(to right, #434343 0%, #000000 100%); --card-border: #757575; --card-accent: #bdbdbd; --card-highlight: #fff; --card-text: #f5f5f5; --card-text-dim: #9e9e9e; --card-accent-dim: rgba(255,255,255,0.1); }

    /* 47. Autumn Maple (ç§‹æ¥“) - æ¿ƒéƒæ©™ç´… */
    .theme-47 { --card-bg: linear-gradient(to right, #d31027, #ea384d); --card-border: #ff8a80; --card-accent: #ff5252; --card-highlight: #ffebee; --card-text: #fff; --card-text-dim: #ffcdd2; --card-accent-dim: rgba(255, 82, 82, 0.2); }

    /* 48. Glacial Ice (å†°æ²³) - é€šé€è—ç™½ */
    .theme-48 { --card-bg: linear-gradient(to top, #accbee 0%, #e7f0fd 100%); --card-border: #90caf9; --card-accent: #64b5f6; --card-highlight: #fff; --card-text: #1565c0; --card-text-dim: #64b5f6; --card-accent-dim: rgba(33, 150, 243, 0.1); }

    /* 49. Bamboo Zen (ç«¹ç¦ª) - æ¸…å¹½é›…è‡´ */
    .theme-49 { --card-bg: linear-gradient(135deg, #134e5e, #71b280); --card-border: #a5d6a7; --card-accent: #c8e6c9; --card-highlight: #e8f5e9; --card-text: #f1f8e9; --card-text-dim: #a5d6a7; --card-accent-dim: rgba(165, 214, 167, 0.2); }

    /* --- 50-59: é«˜ç´šæè³ªèˆ‡ç¾ä»£é¢¨ (Material & Modern) --- */

    /* 50. Champagne Gold (é¦™æª³é‡‘) - æ´¾å°å¥¢è¯ */
    .theme-50 { --card-bg: linear-gradient(to bottom, #eee4d6, #dccdb6); --card-border: #c5a065; --card-accent: #bfa068; --card-highlight: #fff; --card-text: #5d4037; --card-text-dim: #8d6e63; --card-accent-dim: rgba(197, 160, 101, 0.2); }

    /* 51. Carbon Fiber (ç¢³çº–ç¶­) - ç§‘æŠ€é‹å‹• */
    .theme-51 { --card-bg: repeating-linear-gradient(45deg, #111, #111 10px, #222 10px, #222 20px); --card-border: #333; --card-accent: #e74c3c; --card-highlight: #fff; --card-text: #eee; --card-text-dim: #777; --card-accent-dim: rgba(231, 76, 60, 0.3); }

    /* 52. Vintage Leather (è€çš®é©) - ç´³å£«æ£• */
    .theme-52 { --card-bg: linear-gradient(#3e2723, #281a16); --card-border: #8d6e63; --card-accent: #d7ccc8; --card-highlight: #efebe9; --card-text: #d7ccc8; --card-text-dim: #a1887f; --card-accent-dim: rgba(141, 110, 99, 0.2); }

    /* 53. Royal Velvet (çµ²çµ¨è—) - æŸ”è»Ÿæ·±æ²‰ */
    .theme-53 { --card-bg: linear-gradient(to bottom, #1a237e, #0d1245); --card-border: #7986cb; --card-accent: #c5cae9; --card-highlight: #fff; --card-text: #e8eaf6; --card-text-dim: #9fa8da; --card-accent-dim: rgba(197, 202, 233, 0.1); }

    /* 54. Rose Gold (ç«ç‘°é‡‘ç®”) - æ™‚å°šé‡‘å±¬ */
    .theme-54 { --card-bg: linear-gradient(135deg, #e6b9b8, #c68a88); --card-border: #fff; --card-accent: #8e5856; --card-highlight: #fff0f0; --card-text: #4e342e; --card-text-dim: #8d6e63; --card-accent-dim: rgba(255, 255, 255, 0.4); }

    /* 55. Polished Steel (æ‹‹å…‰é‹¼) - å·¥æ¥­å†·èª¿ */
    .theme-55 { --card-bg: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%); --card-border: #757575; --card-accent: #616161; --card-highlight: #fff; --card-text: #212121; --card-text-dim: #616161; --card-accent-dim: rgba(0,0,0,0.1); }

    /* 56. Matte Black (æ¶ˆå…‰é»‘) - æ¥µè‡´ä½èª¿ */
    .theme-56 { --card-bg: #121212; --card-border: #2c2c2c; --card-accent: #666; --card-highlight: #444; --card-text: #bbb; --card-text-dim: #444; --card-accent-dim: rgba(255,255,255,0.05); }

    /* 57. Neon Noir (éœ“è™¹é»‘å¤œ) - è³½åšé¾å…‹ */
    .theme-57 { --card-bg: linear-gradient(to bottom, #000428, #004e92); --card-border: #d500f9; --card-accent: #00e5ff; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #d500f9; --card-accent-dim: rgba(213, 0, 249, 0.2); }

    /* 58. Ivory Tower (è±¡ç‰™ç™½) - ç´”æ·¨å…¸é›… */
    .theme-58 { --card-bg: linear-gradient(to bottom, #fffff0, #f0f0e0); --card-border: #dcdcdc; --card-accent: #a9a9a9; --card-highlight: #fff; --card-text: #333; --card-text-dim: #888; --card-accent-dim: rgba(0,0,0,0.03); }

    /* 59. Gunmetal (æ§ç°è‰²) - ç¡¬æ´¾è»äº‹ */
    .theme-59 { --card-bg: linear-gradient(180deg, #232526 0%, #414345 100%); --card-border: #585858; --card-accent: #d32f2f; --card-highlight: #757575; --card-text: #e0e0e0; --card-text-dim: #616161; --card-accent-dim: rgba(211, 47, 47, 0.2); }

    /* --- 60-69: è—è¡“èˆ‡äººæ–‡ç³»åˆ— (Arts & Culture) --- */

    /* 60. Ink Wash Painting (æ°´å¢¨å±±æ°´) - é»‘ç™½å±¤æ¬¡ */
    .theme-60 { --card-bg: linear-gradient(to bottom, #f5f5f5, #cfd9df); --card-border: #212121; --card-accent: #424242; --card-highlight: #000; --card-text: #000; --card-text-dim: #616161; --card-accent-dim: rgba(0,0,0,0.1); }

    /* 61. Porcelain Blue (é’èŠ±ç“·) - è—ç™½ç›¸é–“ */
    .theme-61 { --card-bg: #fff; --card-border: #1565c0; --card-accent: #0d47a1; --card-highlight: #e3f2fd; --card-text: #0d47a1; --card-text-dim: #64b5f6; --card-accent-dim: rgba(13, 71, 161, 0.1); border: 2px solid #1565c0; }

    /* 62. Old Parchment (èˆŠç¾Šçš®ç´™) - æ­·å²æ„Ÿ */
    .theme-62 { --card-bg: linear-gradient(to bottom, #fdfbfb, #ebedee); background-color: #f3e5f5; --card-bg: #fff8e1; --card-border: #d7ccc8; --card-accent: #8d6e63; --card-highlight: #fff; --card-text: #5d4037; --card-text-dim: #a1887f; --card-accent-dim: rgba(141, 110, 99, 0.1); }

    /* 63. Renaissance (æ–‡è—å¾©èˆˆ) - æ²¹ç•«è³ªæ„Ÿ */
    .theme-63 { --card-bg: linear-gradient(to right, #3e5151, #decba4); --card-border: #8d6e63; --card-accent: #d7ccc8; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #efebe9; --card-accent-dim: rgba(255,255,255,0.2); }

    /* 64. Film Noir (é»‘è‰²é›»å½±) - é«˜å°æ¯” */
    .theme-64 { --card-bg: radial-gradient(circle, #444, #000); --card-border: #fff; --card-accent: #eee; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #aaa; --card-accent-dim: rgba(255,255,255,0.1); }

    /* 65. Ukiyo-e (æµ®ä¸–ç¹ª) - æµªèŠ±è— */
    .theme-65 { --card-bg: linear-gradient(to bottom, #2b5876, #4e4376); --card-border: #ffccbc; --card-accent: #ffab91; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #b39ddb; --card-accent-dim: rgba(255, 171, 145, 0.2); }

    /* 66. Art Deco (è£é£¾è—è¡“) - è“‹èŒ¨æ¯”é‡‘é»‘ */
    .theme-66 { --card-bg: #1c1c1c; --card-border: #d4af37; --card-accent: #f1c40f; --card-highlight: #fff; --card-text: #d4af37; --card-text-dim: #8e7d48; --card-accent-dim: rgba(212, 175, 55, 0.15); border-width: 2px; }

    /* 67. Bauhaus (åŒ…æµ©æ–¯) - å¹¾ä½•åŸè‰² */
    .theme-67 { --card-bg: #f0f0f0; --card-border: #d32f2f; --card-accent: #1976d2; --card-highlight: #ffeb3b; --card-text: #212121; --card-text-dim: #757575; --card-accent-dim: rgba(25, 118, 210, 0.1); }

    /* 68. Vaporwave (è’¸æ±½æ³¢) - å¾©å¤æœªä¾† */
    .theme-68 { --card-bg: linear-gradient(to right, #cc2b5e, #753a88); --card-border: #00d2ff; --card-accent: #3a7bd5; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #eaafc8; --card-accent-dim: rgba(0, 210, 255, 0.2); }

    /* 69. Mosaic (é¦¬è³½å…‹) - ç•°åŸŸé¢¨æƒ… */
    .theme-69 { --card-bg: linear-gradient(45deg, #85ffbd 0%, #ffffb0 100%); --card-border: #009688; --card-accent: #00796b; --card-highlight: #fff; --card-text: #004d40; --card-text-dim: #4db6ac; --card-accent-dim: rgba(0, 121, 107, 0.1); }

    /* --- 70-79: å®‡å®™èˆ‡æ˜Ÿéš›ç³»åˆ— (Cosmic & Celestial) --- */

    /* 70. Deep Space (æ·±ç©º) - ç„¡ç›¡é»‘ */
    .theme-70 { --card-bg: radial-gradient(ellipse at bottom, #1B2735 0%, #090A0F 100%); --card-border: #3f51b5; --card-accent: #7986cb; --card-highlight: #fff; --card-text: #e8eaf6; --card-text-dim: #5c6bc0; --card-accent-dim: rgba(121, 134, 203, 0.1); }

    /* 71. Supernova (è¶…æ–°æ˜Ÿ) - çˆ†ç™¼èƒ½é‡ */
    .theme-71 { --card-bg: linear-gradient(to right, #ff512f, #dd2476); --card-border: #ffcc80; --card-accent: #ffe0b2; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #ffab91; --card-accent-dim: rgba(255, 204, 128, 0.2); }

    /* 72. Nebula Cloud (æ˜Ÿé›²åœ˜) - ç²‰ç´«è¿·å¹» */
    .theme-72 { --card-bg: linear-gradient(to bottom, #20002c, #cbb4d4); --card-border: #e1bee7; --card-accent: #fff; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #ba68c8; --card-accent-dim: rgba(225, 190, 231, 0.2); }

    /* 73. Solar Flare (å¤ªé™½è€€æ–‘) - ç‚™ç†± */
    .theme-73 { --card-bg: linear-gradient(0deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); background: linear-gradient(to bottom, #f83600 0%, #f9d423 100%); --card-border: #fff59d; --card-accent: #ffeb3b; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #fff9c4; --card-accent-dim: rgba(255, 235, 59, 0.2); }

    /* 74. Black Hole (é»‘æ´) - å¼•åŠ›é‚Šç·£ */
    .theme-74 { --card-bg: radial-gradient(circle, #000000, #434343); --card-border: #fff; --card-accent: #fff; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #666; --card-accent-dim: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); }

    /* 75. Comet Tail (å½—å°¾) - å†°è—è»Œè·¡ */
    .theme-75 { --card-bg: linear-gradient(to left, #89f7fe, #66a6ff); --card-border: #fff; --card-accent: #fff; --card-highlight: #fff; --card-text: #01579b; --card-text-dim: #0288d1; --card-accent-dim: rgba(255,255,255,0.3); }

    /* 76. Mars Dust (ç«æ˜Ÿå¡µ) - é½ç´…ç•°æ˜Ÿ */
    .theme-76 { --card-bg: linear-gradient(to bottom, #870000, #190a05); --card-border: #ff5722; --card-accent: #ffab91; --card-highlight: #fff; --card-text: #ffccbc; --card-text-dim: #bf360c; --card-accent-dim: rgba(255, 87, 34, 0.2); }

    /* 77. Starlight (æ˜Ÿå…‰) - é»é»é–ƒçˆ */
    .theme-77 { --card-bg: #0f2027; --card-border: #fff; --card-accent: #fff; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #cfd8dc; --card-accent-dim: rgba(255,255,255,0.1); box-shadow: inset 0 0 20px rgba(255,255,255,0.05); }

    /* 78. Eclipse (æ—¥è•) - å…‰ç’° */
    .theme-78 { --card-bg: radial-gradient(circle at 50% 0, #5c5c5c, #000000); --card-border: #f5f5f5; --card-accent: #e0e0e0; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #9e9e9e; --card-accent-dim: rgba(255,255,255,0.1); }

    /* 79. Constellation (æ˜Ÿåº§) - é€£ç·š */
    .theme-79 { --card-bg: #2c3e50; --card-border: #f1c40f; --card-accent: #f39c12; --card-highlight: #fff; --card-text: #ecf0f1; --card-text-dim: #95a5a6; --card-accent-dim: rgba(241, 196, 15, 0.1); }

    /* --- 80-85: æŠ½è±¡æ¦‚å¿µç³»åˆ— (Abstract Concepts) --- */

    /* 80. Eternal Time (æ°¸æ†æ™‚é–“) - é½’è¼ªéŠ…é‡‘ */
    .theme-80 { --card-bg: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%); background: linear-gradient(to right, #8e9eab, #eef2f3); --card-border: #78909c; --card-accent: #546e7a; --card-highlight: #fff; --card-text: #263238; --card-text-dim: #607d8b; --card-accent-dim: rgba(84, 110, 122, 0.1); }

    /* 81. Inner Peace (å…§å¿ƒå¹³éœ) - ç¦ªæ„ç° */
    .theme-81 { --card-bg: #d7d2cc; --card-bg: linear-gradient(to bottom, #d7d2cc, #304352); --card-border: #90a4ae; --card-accent: #cfd8dc; --card-highlight: #fff; --card-text: #eceff1; --card-text-dim: #b0bec5; --card-accent-dim: rgba(207, 216, 220, 0.1); }

    /* 82. Passion (ç†±æƒ…) - é­…æƒ‘æ·±ç´… */
    .theme-82 { --card-bg: linear-gradient(147deg, #f71735 0%, #db3445 74%); --card-border: #ff8a80; --card-accent: #ffcdd2; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #ef9a9a; --card-accent-dim: rgba(255, 205, 210, 0.2); }

    /* 83. Wisdom (æ™ºæ…§) - é›è—æ·±æ²ˆ */
    .theme-83 { --card-bg: linear-gradient(to right, #243949 0%, #517fa4 100%); --card-border: #b3e5fc; --card-accent: #81d4fa; --card-highlight: #fff; --card-text: #e1f5fe; --card-text-dim: #81d4fa; --card-accent-dim: rgba(129, 212, 250, 0.1); }

    /* 84. Balance (é™°é™½å¹³è¡¡) - é»‘ç™½å¤ªæ¥µ */
    .theme-84 { --card-bg: linear-gradient(90deg, #111 50%, #eee 50%); --card-border: #888; --card-accent: #888; --card-highlight: #f00; --card-text: #888; --card-text-dim: #aaa; --card-accent-dim: rgba(136, 136, 136, 0.2); }

    /* 85. The Singularity (å¥‡é») - çµ‚æ¥µè™¹å…‰ */
    .theme-85 { --card-bg: linear-gradient(43deg, #4158D0 0%, #C850C0 46%, #FFCC70 100%); --card-border: #fff; --card-accent: #fff; --card-highlight: #fff; --card-text: #fff; --card-text-dim: #ffe0b2; --card-accent-dim: rgba(255, 255, 255, 0.3); }
 
    /* --- THE BIG 3: éš±è—æ¬¾ (Blind Box Rares) --- */
    
    /* 86. Golden Legend (SSR - ç‹è€…é‡‘) - æ©Ÿç‡ 3% */
    .theme-86 { 
        --card-bg: linear-gradient(135deg, #141414 0%, #333 100%); 
        --card-border: #ffd700; 
        --card-accent: #ffecb3; 
        --card-highlight: #fff; 
        --card-text: #ffd700; 
        --card-text-dim: #bf953f; 
        --card-accent-dim: rgba(255, 215, 0, 0.3);
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.4), inset 0 0 30px rgba(0,0,0,0.8);
        border: 2px solid transparent;
        background-clip: padding-box, border-box;
        background-origin: padding-box, border-box;
        background-image: linear-gradient(135deg, #141414 0%, #333 100%), linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
        animation: goldShine 5s infinite linear;
    }

    /* 87. Cosmic Aurora (UR - å¹»å½©æ¥µå…‰) - æ©Ÿç‡ 2% */
    .theme-87 { 
        --card-bg: radial-gradient(circle at 50% 50%, #2b1055, #7597de); 
        --card-border: rgba(255,255,255,0.5); 
        --card-accent: #fff; 
        --card-highlight: #fff; 
        --card-text: #fff; 
        --card-text-dim: rgba(255,255,255,0.8); 
        --card-accent-dim: rgba(255,255,255,0.2);
        box-shadow: 0 0 25px rgba(118, 224, 255, 0.6);
        animation: holoPulse 3s infinite alternate;
        border-width: 3px;
        border-style: double;
    }

    /* 88. Singularity Void (SP - è™›ç©ºå¥‡é») - æ©Ÿç‡ 1% (æ–°å¢) */
    .theme-88 {
        --card-bg: #000;
        --card-border: #0ff;
        --card-accent: #0ff;
        --card-highlight: #f0f;
        --card-text: #fff;
        --card-text-dim: #0ff;
        --card-accent-dim: rgba(0, 255, 255, 0.3);
        background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
        background-size: 400% 400%;
        animation: rainbowGlitch 3s ease infinite;
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
        border: 2px solid #fff;
    }
    
    @keyframes goldShine { 0% { filter: brightness(1); } 50% { filter: brightness(1.2); } 100% { filter: brightness(1); } }
    @keyframes holoPulse { 0% { box-shadow: 0 0 20px rgba(118, 224, 255, 0.4); border-color: #81ecec; } 100% { box-shadow: 0 0 40px rgba(253, 121, 168, 0.6); border-color: #fd79a8; } }
    @keyframes rainbowGlitch { 
        0% { background-position: 0% 50%; filter: hue-rotate(0deg); }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; filter: hue-rotate(360deg); }
    }
    
    /* æ—¥æ›†äº’å‹•å¢å¼· (åŠ å…¥å¡è¢‹æç¤º) */
    .calendar-day-checked {
        cursor: pointer; position: relative; overflow: hidden;
    }
    .calendar-day-checked:hover::after {
        content: 'ğŸƒ'; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
        font-size: 1.2rem;
    }
  </style>
</head>
<body>

  <div id="in-app-browser-warning">
      <div class="arrow-hint">â†—</div>
      <div class="warning-icon">âš ï¸</div>
      <div class="warning-title">Sign-in Restricted<br>ç™»å…¥å—é™</div>
      <div class="warning-text">
          Google Login is blocked inside Line/WeChat/FB.<br>
          Please open this page in <strong>Chrome</strong> or <strong>Safari</strong> to log in.
          <br><br>
          æ­¤æ‡‰ç”¨ç¨‹å¼ä¸æ”¯æ´ Google ç™»å…¥ã€‚<br>
          è«‹é»æ“Šå³ä¸Šè§’é¸å–®ï¼Œé¸æ“‡<strong>ã€Œåœ¨ç€è¦½å™¨ä¸­é–‹å•Ÿã€</strong>ï¼Œæˆ–è¤‡è£½é€£çµè‡³ Chrome/Safari é–‹å•Ÿã€‚
      </div>
      
      <div class="warning-actions">
          <button class="btn-warning btn-copy" onclick="copyCurrentUrl()">
              ğŸ“‹ Copy Link / è¤‡è£½é€£çµ
          </button>
          <button class="btn-warning btn-close-warning" onclick="closeWarning()">
              Cancel & Stay as Visitor<br>æš«ä¸ç™»å…¥ï¼Œç¹¼çºŒåƒè§€
          </button>
      </div>
  </div>

  <canvas id="particle-canvas"></canvas>

  <audio id="themeSong" src="https://ducj-creator.github.io/Teacher-Shirley/assets/theme%20song.mp3" preload="auto"></audio>
  <audio id="windchime" src="https://ducj-creator.github.io/Teacher-Shirley/assets/windchime.mp3" preload="auto"></audio>

  <div class="top-bar">
      <div id="themeToggle" class="control-btn" title="Toggle Theme">ğŸŒ“</div>
      <div id="musicToggle" class="control-btn" title="Music">ğŸµ</div>
      <div id="logoutBtn" class="control-btn" title="Logout" style="display:none;">ğŸšª</div>
  </div>

  <header>
    <div class="title-container">
        <h1 class="main-title">Teacher Shirleyâ€™s<br>ET Platform</h1>
        <div class="title-underline"></div>
    </div>
  </header>

  <div id="intro-overlay">
      <div class="envelope-container" onclick="openLetter()">
          <div class="envelope-body"></div>
          <div class="envelope-txt">
              <div class="env-title">Welcome Message</div>
              <div class="env-subtitle">from Teacher Shirley</div>
              <div class="env-highlight">Welcome to my ET Platform<br>Ready for launch! ğŸš€</div>
              <div class="env-cn">æ­¡è¿ä¾†åˆ°æˆ‘çš„ ET æœˆå°ï¼Œæº–å‚™å‡ºç™¼å›‰ï¼</div>
          </div>
          <div class="envelope-pocket"></div>
          <div class="envelope-flap"><div class="heart-seal">ğŸ’—</div></div>
      </div>

      <div class="letter-paper" id="letter-view">
          <div class="sparkle-overlay">
              <div class="sparkle"></div><div class="sparkle"></div><div class="sparkle"></div><div class="sparkle"></div><div class="sparkle"></div>
          </div>
          <div class="letter-content">
              <div class="letter-p"><strong>Hi there! ğŸ‘‹</strong> Iâ€™m Shirleyâ€”an English teacher who believes learning should be joyful, interactive, and full of â€œaha!â€ moments. <span class="cn-text">æˆ‘æ˜¯ Shirleyâ€”â€”ä¸€ä½ç›¸ä¿¡å­¸ç¿’æ‡‰è©²å……æ»¿æ¨‚è¶£ã€äº’å‹•ï¼Œä¸¦æ™‚å¸¸è¿¸ç™¼ã€Œå•Šå“ˆï¼ã€éˆæ„Ÿçš„è‹±æ–‡è€å¸«ã€‚</span></div>
              <div class="letter-p">This teaching-and-learning platform is your free, ad-free toolkitâ€”carefully crafted from years of real classroom experience and student feedback. <span class="cn-text">é€™å€‹æ•™èˆ‡å­¸å¹³å°æ˜¯æ‚¨å…è²»ã€ç„¡å»£å‘Šçš„å­¸ç¿’å·¥å…·ç®±â€”â€”æºè‡ªå¤šå¹´çœŸå¯¦èª²å ‚ç¶“é©—èˆ‡å­¸ç”Ÿå›é¥‹ã€‚</span></div>
              <div class="letter-p">Whether youâ€™re a teacher looking for ready-to-use activities or an English learner eager to practice anytime, anywhere, youâ€™re welcome to explore all tools and content freely as a visitor. <span class="cn-text">ä¸è«–æ‚¨æ˜¯å°‹æ‰¾ç¾æˆæ•™å­¸æ´»å‹•çš„è€å¸«ï¼Œé‚„æ˜¯æƒ³éš¨æ™‚éš¨åœ°ç·´ç¿’è‹±æ–‡çš„å­¸ç¿’è€…ï¼Œéƒ½æ­¡è¿ä»¥è¨ªå®¢èº«ä»½è‡ªç”±ä½¿ç”¨æ‰€æœ‰è³‡æºã€‚</span></div>
              
              <div class="letter-p" style="background:rgba(212, 175, 55, 0.1); padding:15px; border-radius:10px; margin-top:10px;">
                If you log in, each day youâ€™ll receive: âœ¨â€œWord of the Dayâ€, â€œBilingual Quoteâ€, and unlock your 
                <br>
                <span class="highlight-box">Shirley's Moon Base Card</span> 
                <br>
                to <span style="text-decoration:underline;">track daily check-ins</span>, <span style="text-decoration:underline;">build streaks</span>, and map your journey.
                
                <div class="cn-text" style="color:#5d4037; margin-top:8px; line-height:1.8;">
                    è‹¥æ‚¨é¸æ“‡ç™»å…¥ï¼Œæ¯å¤©èƒ½ç²å¾—âœ¨ã€Œæ¯æ—¥å–®å­—ã€èˆ‡ã€Œæ¯æ—¥ä½³å¥ã€ï¼Œæ›´å¯å•Ÿç”¨ 
                    <span class="highlight-box">
                        <span class="key-term">Shirley è€å¸«å°ˆå±¬çš„ã€ŒæœˆçƒåŸºåœ°å¡ã€</span>
                    </span>
                    â€”â€”<span style="border-bottom:1px solid #5d4037;">è¨˜éŒ„æ‰“å¡</span>ã€<span style="border-bottom:1px solid #5d4037;">ç´¯ç©å¤©æ•¸</span>èˆ‡<span style="border-bottom:1px solid #5d4037;">æ¢ç´¢è»Œè·¡</span>ã€‚
                </div>
              </div>

              <div class="letter-p">I highly encourage you to check in every dayâ€”consistency turns small efforts into big results, and learning is a journey of steady persistence and joyful discovery. <span class="cn-text">æˆ‘èª æ‘¯é¼“å‹µæ‚¨æ¯æ—¥æ‰“å¡â€”â€”æŒä¹‹ä»¥æ†ï¼Œå¾®å°çš„åŠªåŠ›çµ‚å°‡é–‹èŠ±çµæœï¼›å­¸ç¿’æ˜¯ä¸€å ´éœ€è¦å …æŒï¼Œä¹Ÿå……æ»¿æ¨‚è¶£èˆ‡é©šå–œçš„æ—…ç¨‹ã€‚</span></div>
              <div class="signature">â€” Teacher Shirley</div>
              <div class="choice-area" id="choice-buttons">
                  <button class="btn-letter btn-visitor" onclick="enterVisitorMode()"><span>ğŸ›¸ Visitor Mode</span><span style="font-size:0.7rem; font-weight:normal;">è¨ªå®¢åƒè§€ (ç„¡ç´€éŒ„)</span></button>
                  <button class="btn-letter btn-login" onclick="showAuthForm()"><span>ğŸš€ Log In</span><span style="font-size:0.7rem; font-weight:normal;">ç™»å…¥ / è¨»å†Š</span></button>
              </div>
              <div id="auth-form-container">
                  <h4 style="margin-bottom:10px; text-align:center; color:var(--text);">Log In / ç™»å…¥</h4>
                  <button id="google-login-btn" class="google-btn"><svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.715H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.159 6.656 3.58 9 3.58z"/></svg> Google Login</button>
                  <div style="text-align:center; font-size:0.8rem; margin:5px 0;">â€” OR â€”</div>
                  <div class="input-group"><input type="email" id="email-input" placeholder="Email"><input type="password" id="pass-input" placeholder="Password"></div>
                  <button class="email-btn" id="email-login-btn">Log In</button>
                  <div style="margin-top:8px; text-align:center; font-size:0.8rem; cursor:pointer; text-decoration:underline;" onclick="hideAuthForm()">Cancel</div>
              </div>
          </div>
      </div>
  </div>

  <div id="visitor-view">
      <div style="text-align:center; margin-bottom:2rem; color:var(--text-light); background: rgba(255,255,255,0.5); padding: 10px; border-radius: 20px; display: inline-block; position:relative; left:50%; transform:translateX(-50%);">
          Currently in <strong>Visitor Mode</strong>. 
          <button onclick="reopenAuth()" style="margin-left: 10px; background: var(--accent); color: white; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-weight: bold; font-family: 'Exo 2';">
              Log in? ğŸš€
          </button>
      </div>
      <div class="categories">
        <a href="/Teacher-Shirley/teaching-tools/" class="category-card"><span class="icon">ğŸ</span><h2>Teaching Tools</h2><div class="subtitle">å¸«å¸«ç™¾å¯¶ç®±</div></a>
        <a href="https://ducj-creator.github.io/Teacher-Shirley/study-tools/index.html" class="category-card"><span class="icon">ğŸª</span><h2>Study Tools</h2><div class="subtitle">å­¸å­¸æ™ºè¶£é–£</div></a>
        <a href="/Teacher-Shirley/amusement-park/" class="category-card"><span class="icon">ğŸª</span><h2>Amusement Park</h2><div class="subtitle">æ¨‚æ¨‚å¬‰éŠè°·</div></a>
        <a href="/Teacher-Shirley/external-resources/" class="category-card"><span class="icon">ğŸ”—</span><h2>External Resources</h2><div class="subtitle">æºæºé€£çµåº«</div></a>
      </div>
  </div>

  <div id="universe-view">
      <div class="solar-system">
          <div class="orbit orbit-1"></div>
          <div class="orbit orbit-2"></div>
          <div class="orbit orbit-3"></div>
          <div class="mars-container"><div class="mars-wrapper" onclick="visitPlanet('Mars', '/Teacher-Shirley/teaching-tools/')"><div class="planet-visual p-mars"></div><div class="planet-info"><span class="p-name">Mars ğŸ”´</span><div class="p-poem-cn">åœ¨ç«æ˜Ÿç‡ƒèµ·æ˜Ÿç«<br>æ–¼è¬›å°åŒ–ä½œæ™¨å…‰</div><div class="p-poem-en">Upon Mars, kindle starlight; on the lectern, dawnlight blooms.</div></div></div></div>
          <div class="static-planet-wrapper pos-mercury" onclick="visitPlanet('Mercury', '/Teacher-Shirley/external-resources/')"><div class="planet-visual p-mercury"></div><div class="planet-info"><span class="p-name">Mercury âšª</span><div class="p-poem-cn">åœ¨æ°´æ˜Ÿæ”¬ç›¡æ˜Ÿèª<br>æ–¼å¾®å…‰çµæˆæ©‹æ¨‘</div><div class="p-poem-en">Upon Mercury, catch star-words; in glimmers, weave a bridge.</div></div></div>
          <div class="static-planet-wrapper pos-jupiter" onclick="visitPlanet('Jupiter', 'https://ducj-creator.github.io/Teacher-Shirley/study-tools/index.html')"><div class="planet-visual p-jupiter"></div><div class="planet-info"><span class="p-name">Jupiter ğŸŸ¡</span><div class="p-poem-cn">åœ¨æœ¨æ˜Ÿæ¶µç´æ˜Ÿæ²³<br>æ–¼æ›¸é é•·å‡ºæ–°èŠ½</div><div class="p-poem-en">Upon Jupiter, gather star-rivers; in pages, sprouts unfold.</div></div></div>
          <div class="static-planet-wrapper pos-saturn" onclick="visitPlanet('Saturn', '/Teacher-Shirley/amusement-park/')"><div class="planet-visual p-saturn"></div><div class="planet-info"><span class="p-name">Saturn ğŸŸ </span><div class="p-poem-cn">åœ¨åœŸæ˜Ÿæ—‹èˆå…‰ç’°<br>æ–¼ç¬‘èªæ‹¾å¾—ç ç’£</div><div class="p-poem-en">Upon Saturn, spin the rings; in laughter, catch bright pearls.</div></div></div>
          <div class="moon-wrapper" onclick="openMemberTerminal()"><div class="planet-moon"></div><div class="planet-info moon-info"><span class="p-name">Moon ğŸŒ•</span><div class="p-poem-cn">åœ¨æœˆä¹‹æš—é¢æ²‰æ€<br>æ–¼æœˆä¹‹æ˜é¢æˆé•·</div><div class="p-poem-en">In the moonâ€™s shadow, ponder. In its light, grow.</div><span class="checkin-tag">Tap to Check-in: ğŸŒ•åŸºåœ°æ‰“å¡</span></div></div>
      </div>
      <div style="position:absolute; bottom:20px; width:100%; text-align:center; color:var(--text-light); font-size:0.75rem; font-style:italic;">Explore the galaxy to find your learning path.</div>
  </div>

  <div id="member-terminal">
      <div class="close-terminal" onclick="closeMemberTerminal()">âœ•</div>
      <h3 id="greeting-name" style="font-family:'Cinzel Decorative'; color:var(--accent); text-align:center; margin-bottom:1rem;">Welcome to Moon Base</h3>
      <div class="member-dashboard">
          <div class="profile-panel">
              <div class="streak-ring"><div class="streak-num" id="streak-days">0</div><div style="font-size:0.7rem;">Days Streak</div></div>
              <div style="margin-bottom:1rem; font-size:0.9rem;">Total Check-ins: <strong id="total-days">0</strong></div>
              <div id="calendar-grid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:3px; font-size:0.7rem; margin-bottom:10px;"></div>

              <!-- âœ…ã€æœ€å°è£œä¸ã€‘å¡è¢‹å€ï¼ˆä¸æ”¹ä½ åŸæ’ç‰ˆï¼Œåªæ˜¯æ¥åœ¨æ—¥æ›†ä¸‹é¢ï¼‰ -->
              <div style="margin-top:12px; text-align:left;">
                <div style="font-size:0.8rem; font-weight:bold; margin-bottom:6px; color:var(--text-light);">
                  ğŸƒ Card Bag / å¡è¢‹æ”¶è—
                </div>
                <div id="card-bag-list"></div>
              </div>

              <button id="checkin-btn" class="checkin-btn" onclick="handleCheckIn()">Daily Check-in</button>
              <div style="margin-top:1rem; cursor:pointer; text-decoration:underline; font-size:0.8rem; color:var(--text-light);" onclick="openPrintSelection()">ğŸ–¨ï¸ Print Learning Log</div>
          </div>
          <div class="content-panel">
              <div class="data-card word-card">
                  <span style="font-size:0.7rem; text-transform:uppercase; color:var(--text-light); letter-spacing:1px;">Word of the Day <span id="word-date"></span></span>
                  <div style="display:flex; gap:10px; align-items:baseline; margin-top:5px;"><span class="the-word" id="wotd-word">Wait...</span><span style="background:var(--accent); color:white; padding:1px 6px; border-radius:4px; font-size:0.75rem;" id="wotd-pos"></span></div>
                  <div style="font-family:'Noto Sans TC'; font-weight:bold; color:var(--accent); margin:5px 0; font-size:1.1rem;" id="wotd-meaning"></div>
                  <div style="font-style:italic; color:var(--text-light); font-size:0.9rem; margin-bottom:10px;" id="wotd-ipa"></div>
                  <div style="background:rgba(0,0,0,0.03); padding:10px; border-radius:8px;"><div id="wotd-sentence-e" style="font-style:italic; margin-bottom:4px;"></div><div id="wotd-sentence-c" style="font-size:0.9rem; color:var(--text-light);"></div></div>
              </div>
              <div class="data-card quote-card">
                  <span style="font-size:0.7rem; text-transform:uppercase; color:var(--text-light); letter-spacing:1px;">Daily Quote</span>
                  <div style="font-family:'Playfair Display'; font-size:1.3rem; margin:15px 0; line-height:1.4;" id="qotd-text"></div>
                  <div style="font-size:0.95rem; color:var(--text-light);" id="qotd-trans"></div>
                  <div style="text-align:right; font-weight:bold; color:var(--accent); margin-top:10px;" id="qotd-author"></div>
              </div>
          </div>
      </div>
  </div>

  <div id="card-modal">
      <div class="card-overlay-bg" onclick="closeCardModal()"></div>
      <div class="card-display-container">
          <div id="collectible-card" class="moon-card">
              <div class="card-decoration-top"></div>
              
              <div class="card-header">
                  <div class="card-title">MOON BASE CLEARANCE</div>
                  <div class="card-serial">NO. <span id="card-date-serial"></span></div>
              </div>

              <div class="card-body">
                  <div class="card-greeting">
                      Welcome, <span id="card-user-name">Traveler</span>
                  </div>
                  <div class="card-subtitle">
                      This is your Shirley's Moon Base Card for <span id="card-display-date"></span>
                  </div>

                  <div class="card-divider">âœ¦ âœ¦ âœ¦</div>

                  <div class="card-content-box">
                      <div class="card-label">Word of the Day</div>
                      <div class="card-wotd" id="card-wotd"></div>
                      <div class="card-pos" id="card-pos"></div>
                      <div class="card-def" id="card-def"></div>
                      <div class="card-sentence-container">
                          <div id="card-sent-en" class="card-sent-en"></div>
                          <div id="card-sent-cn" class="card-sent-cn"></div>
                      </div>
                  </div>

                  <div class="card-quote-box">
                      <div class="card-quote-text" id="card-quote"></div>
                      <div class="card-quote-trans" id="card-quote-trans"></div>
                      <div class="card-quote-author" id="card-author"></div>
                  </div>
              </div>

              <div class="card-footer">
                  <div class="card-streak-badge">
                      <span class="badge-icon">ğŸ”¥</span> Streak: <span id="card-streak"></span>
                  </div>
                  <div class="card-signature">Teacher Shirley</div>
              </div>
              
              <div class="card-watermark">MOON BASE</div>
              <div class="card-shine"></div>
          </div>

          <div class="card-actions">
              <button class="btn-card-action btn-download" onclick="downloadCardImage()">
                  ğŸ“¥ Download Image (æ”¶è—)
              </button>
              <button class="btn-card-action btn-close" onclick="closeCardModal()">
                  âœ• Close (æ”¾å…¥å¡è¢‹)
              </button>
          </div>
      </div>
  </div>

  <div id="print-selection-modal">
    <div class="print-modal-content">
        <div class="print-modal-header">Select Records to Print</div>
        <div class="print-controls">
            <button onclick="toggleAllLogs(true)" style="background:none; border:none; cursor:pointer; color:var(--accent); font-weight:bold;">â˜‘ Select All</button>
            <button onclick="toggleAllLogs(false)" style="background:none; border:none; cursor:pointer; color:#7f8c8d; font-weight:bold;">â˜ Clear All</button>
        </div>
        <div class="selection-list" id="log-selection-list"></div>
        <div class="print-actions">
            <button class="action-btn btn-cancel" onclick="closePrintSelection()">Cancel</button>
            <button class="action-btn btn-confirm" onclick="confirmPrint()">ğŸ–¨ï¸ Print / Save PDF</button>
        </div>
    </div>
  </div>

  <div id="print-area" class="print-only">
      <div class="print-header" style="text-align:center; border-bottom:2px solid black; margin-bottom:20px; padding-bottom:10px;">
          <h1>My Learning Journey</h1>
          <p>Student: <span id="print-name"></span> | Date: <span id="print-date"></span></p>
      </div>
      <table id="print-table">
          <thead><tr><th style="width:25%">Time / Duration</th><th style="width:20%">Activity Type</th><th>Details</th></tr></thead>
          <tbody id="print-body"></tbody>
      </table>
      <div style="margin-top:20px; font-size:0.8rem; text-align:center;">Generated from Teacher Shirley's ET Platform</div>
  </div>

  <footer class="page-footer" style="margin-top:3rem; padding:2rem; text-align:center; font-size:0.8rem; color:var(--text-light); opacity:0.6;">
    <div>Â©ï¸ Teacher Shirleyâ€˜s ET Platform 2025</div>
    <span id="busuanzi_container_site_pv">Total Visits: <span id="busuanzi_value_site_pv"></span></span>
  </footer>

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

 <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCta1_RddjhYBA437cl8Wg1kGW_bsVimK8",
      authDomain: "teacher-shirley.firebaseapp.com",
      databaseURL: "https://teacher-shirley-default-rtdb.firebaseio.com",
      projectId: "teacher-shirley",
      storageBucket: "teacher-shirley.firebasestorage.app",
      messagingSenderId: "534843195436",
      appId: "1:534843195436:web:f1f873e6f6e8c257ce9189"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null;
    let csvData = { words: [], quotes: [] };
    let checkinHistory = [];
    let activityLog = [];

    // --- In-App Browser Detection Helpers ---
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isInApp = (ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1) || (ua.indexOf("Instagram") > -1) || (ua.indexOf("Line") > -1) || (ua.indexOf("MicroMessenger") > -1);

    window.closeWarning = () => {
        document.getElementById('in-app-browser-warning').style.display = 'none';
    };

    window.copyCurrentUrl = () => {
        navigator.clipboard.writeText(window.location.href).then(() => {
            alert("Link copied! Open Chrome/Safari and paste it.");
        }).catch(() => {
            alert("Failed to copy. Please copy the URL manually.");
        });
    };

    // --- HELPER: GET LOCAL DATE STRING ---
    function getLocalISODate() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    // --- ENVELOPE LOGIC ---
    window.openLetter = () => {
        const windchime = document.getElementById('windchime');
        windchime.volume = 0.5;
        windchime.play().catch(e => console.log("Audio play failed"));
        const container = document.querySelector('.envelope-container');
        container.classList.add('open');
        setTimeout(() => {
            const letterView = document.getElementById('letter-view');
            letterView.classList.add('show');
            const paragraphs = document.querySelectorAll('.letter-p');
            paragraphs.forEach((p, index) => { setTimeout(() => { p.classList.add('visible'); }, index * 800); });
            setTimeout(() => { document.getElementById('choice-buttons').classList.add('visible'); }, paragraphs.length * 800 + 400);
        }, 800);
    };

    window.enterVisitorMode = () => {
        document.getElementById('intro-overlay').style.opacity = '0';
        setTimeout(() => { document.getElementById('intro-overlay').style.display = 'none'; }, 1000);
        document.getElementById('visitor-view').classList.add('active');
    };

    window.reopenAuth = () => {
        document.getElementById('visitor-view').classList.remove('active');
        const overlay = document.getElementById('intro-overlay');
        overlay.style.display = 'flex';
        void overlay.offsetWidth; 
        overlay.style.opacity = '1';
        const container = document.querySelector('.envelope-container');
        const letterView = document.getElementById('letter-view');
        if(!container.classList.contains('open')) {
             container.classList.add('open');
             letterView.classList.add('show');
        }
        showAuthForm();
    };

    window.showAuthForm = () => { document.getElementById('choice-buttons').style.display = 'none'; document.getElementById('auth-form-container').style.display = 'block'; };
    window.hideAuthForm = () => { document.getElementById('choice-buttons').style.display = 'flex'; document.getElementById('auth-form-container').style.display = 'none'; };
    window.openMemberTerminal = () => { document.getElementById('member-terminal').classList.add('show'); };
    window.closeMemberTerminal = () => { document.getElementById('member-terminal').classList.remove('show'); };

    // --- UPDATED GOOGLE LOGIN LOGIC ---
    document.getElementById('google-login-btn').addEventListener('click', () => { 
        if(isInApp) {
            document.getElementById('in-app-browser-warning').style.display = 'flex';
            return;
        }
        signInWithPopup(auth, provider).catch(e => alert("Login Error: " + e.message)); 
    });

    document.getElementById('email-login-btn').addEventListener('click', () => {
        const email = document.getElementById('email-input').value;
        const pass = document.getElementById('pass-input').value;
        if (!email || !pass) return alert("Please fill in fields");
        signInWithEmailAndPassword(auth, email, pass).catch(error => {
            if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                if(confirm("Create account?")) createUserWithEmailAndPassword(auth, email, pass);
            } else alert(error.message);
        });
    });
    document.getElementById('logoutBtn').addEventListener('click', () => { signOut(auth).then(() => location.reload()); });

   // âœ…ã€ä½ åˆªæ‰çš„æ ¸å¿ƒã€‘ç™»å…¥ç‹€æ…‹ç›£è½ + é€²å…¥æ˜Ÿçƒ
onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;

        // 1) UI åˆ‡æ›ï¼šé€²å…¥å®‡å®™
        document.getElementById('intro-overlay').style.display = 'none';
        document.getElementById('visitor-view').classList.remove('active');
        document.getElementById('universe-view').classList.add('active');

        // 2) é¡¯ç¤ºç™»å‡ºéµ
        document.getElementById('logoutBtn').style.display = 'flex';

        // 3) æ›´æ–°æ­¡è¿å­—
        const name =
            user.displayName ||
            (user.email ? user.email.split('@')[0] : "Traveler");
        const greet = document.getElementById('greeting-name');
        if (greet) greet.innerText = `Welcome, ${name}`;

        // 4) è¼‰å…¥æ¯æ—¥å…§å®¹ + ä½¿ç”¨è€…è³‡æ–™
        await loadCSVData();
        renderDailyContent(getTodayMMDD());
        await loadUserData(user.uid);

        // optionalï¼šè¨˜éŒ„ç™»å…¥è¡Œç‚º
        trackActivity("Login", "User logged in");

    } else {
        currentUser = null;

        // ç™»å‡ºå¾Œ UI é‚„åŸï¼ˆå¯ä¾ä½ éœ€æ±‚è¦å›ä¿¡å°æˆ–ç•™åœ¨ visitorï¼‰
        document.getElementById('logoutBtn').style.display = 'none';
        document.getElementById('universe-view').classList.remove('active');

        // å¦‚æœä½ å¸Œæœ›ç™»å‡ºå›åˆ°ä¿¡å°
        document.getElementById('intro-overlay').style.display = 'flex';
        document.getElementById('intro-overlay').style.opacity = '1';
    }
});

    window.visitPlanet = (planetName, url) => {
        if (currentUser) trackActivity("Exploration", `Departed Moon for ${planetName}`);
        setTimeout(() => { window.location.href = url; }, 300);
    };

    async function trackActivity(type, detail) {
        if (!currentUser) return;
        const userRef = doc(db, "users", currentUser.uid);
        try { await updateDoc(userRef, { activityLogs: arrayUnion({ date: new Date().toISOString(), type, detail }) }); } catch (e) { console.log(e); }
    }

    async function loadUserData(uid) {
        const userRef = doc(db, "users", uid);
        const docSnap = await getDoc(userRef);
        const fullDate = getLocalISODate();
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            checkinHistory = data.history || [];
            activityLog = data.activityLogs || [];
            document.getElementById('total-days').innerText = checkinHistory.length;
            document.getElementById('streak-days').innerText = data.streak || 0;
            if (checkinHistory.includes(fullDate)) document.getElementById('checkin-btn').disabled = true;
        } else {
            await setDoc(userRef, { email: currentUser.email, history: [], streak: 0, activityLogs: [] }, { merge: true });
        }
        renderCalendar();
        renderCardBagList(); // âœ…ã€æœ€å°è£œä¸ã€‘ç™»å…¥æ™‚åŒæ­¥æ¸²æŸ“å¡è¢‹
    }

    // --- REWRITTEN CHECK-IN & CALENDAR LOGIC WITH CARDS ---

   // ç›²ç›’å¡ç‰‡é¸æ“‡å™¨ (88å¼µæ“´å……ç‰ˆ)
    function getTemplateIdByDate(dateStr) {
        if(!dateStr) return 1;

        // å˜—è©¦ç²å–ä½¿ç”¨è€… UIDï¼Œè®“æ¯å€‹äººçš„é‹æ°£ä¸åŒ
        let uid = 'visitor';
        try {
            if (typeof currentUser !== 'undefined' && currentUser && currentUser.uid) {
                uid = currentUser.uid;
            }
        } catch(e) { console.log("User ID retrieval failed for card seed"); }

        const parts = dateStr.split('-');
        const y = parseInt(parts[0]);
        const m = parseInt(parts[1]);
        const d = parseInt(parts[2]);

        // ç”¢ç”Ÿé‹æ°£é›œæ¹Šå€¼
        const seedStr = `${y}${m}${d}-${uid}`;
        let hash = 0;
        for (let i = 0; i < seedStr.length; i++) {
            const char = seedStr.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; 
        }
        hash = Math.abs(hash);

        const luck = hash % 100; // 0 ~ 99

        // --- ç›²ç›’æ©Ÿç‡è¨­å®š (ç¸½å…± 88 å¼µ) ---
        
        // 1% æ©Ÿç‡ç²å¾— SP éš±è—æ¬¾ (Theme 88 - è™›ç©ºå¥‡é»)
        if (luck === 99) return 88;
        
        // 2% æ©Ÿç‡ç²å¾— UR éš±è—æ¬¾ (Theme 87 - å¹»å½©æ¥µå…‰)
        if (luck >= 97) return 87;

        // 3% æ©Ÿç‡ç²å¾— SSR éš±è—æ¬¾ (Theme 86 - ç‹è€…é‡‘)
        if (luck >= 94) return 86;

        // å‰©ä¸‹ 94% æ©Ÿç‡ï¼Œåœ¨ 1 - 85 è™Ÿæ™®é€šå¡ä¸­éš¨æ©Ÿåˆ†é…
        // ä½¿ç”¨ (hash % 85) + 1 ç¢ºä¿ç¯„åœæ˜¯ 1~85
        return (hash % 85) + 1; 
    }

    // é¡¯ç¤ºå¡ç‰‡ (åŠ å…¥ä¾‹å¥èˆ‡ä½³å¥ç¿»è­¯)
    window.openCard = (dateStr) => {
        const userName = (currentUser && (currentUser.displayName || currentUser.email.split('@')[0])) || "Traveler";
        
        // å‡è¨­ CSV date æ˜¯ "MM-DD"
        let wotd = "Mystery", wotdPos = "n.", wotdDef = "To explore the unknown.";
        let quote = "The stars are calling.", author = "Universe";
        let sentEn = "Keep looking up."; 
        let sentCn = "ä¿æŒä»°æœ›æ˜Ÿç©ºã€‚";
        let quoteTrans = "ç¾¤æ˜Ÿåœ¨å¬å–šã€‚";

        if (csvData && csvData.words) {
            const queryDate = dateStr.slice(5); // remove YYYY-
            const wordObj = csvData.words.find(r => r.date === queryDate);
            const quoteObj = csvData.quotes.find(r => r.date === queryDate);

            if (wordObj) {
                wotd = wordObj.word || wotd;
                wotdPos = wordObj.pos || wotdPos;
                wotdDef = wordObj.meaning || wotdDef;
                sentEn = wordObj['sentence e'] || sentEn;
                sentCn = wordObj['sentence c'] || sentCn;
            }
            if (quoteObj) {
                quote = quoteObj['quote e'] || quote;
                quoteTrans = quoteObj['quote c'] || quoteTrans;
                author = quoteObj.author || author;
            }
        }

        const streakDisplay = document.getElementById('streak-days') ? document.getElementById('streak-days').innerText : "0";

        // å¡«å……è³‡æ–™
        document.getElementById('card-user-name').innerText = userName;
        document.getElementById('card-display-date').innerText = dateStr;
        document.getElementById('card-date-serial').innerText = dateStr.replace(/-/g, '');
        document.getElementById('card-wotd').innerText = wotd;
        document.getElementById('card-pos').innerText = wotdPos;
        document.getElementById('card-def').innerText = wotdDef;
        // å¡«å……ä¾‹å¥
        document.getElementById('card-sent-en').innerText = sentEn;
        document.getElementById('card-sent-cn').innerText = sentCn;
        // å¡«å……ä½³å¥
        document.getElementById('card-quote').innerText = `â€œ${quote}â€`;
        document.getElementById('card-quote-trans').innerText = quoteTrans;
        document.getElementById('card-author').innerText = author;
        document.getElementById('card-streak').innerText = streakDisplay;

        // âœ…ã€æœ€å°è£œä¸ã€‘è¨­å®šæ¨¡æ¿ï¼šç§»é™¤ 1~88 å…¨éƒ¨ classï¼Œé¿å…æ®˜ç•™ç–ŠåŠ é€ æˆâ€œè®Šå‹•â€
        const cardEl = document.getElementById('collectible-card');
        for(let i=1; i<=88; i++) cardEl.classList.remove(`theme-${i}`);
        const themeId = getTemplateIdByDate(dateStr);
        cardEl.classList.add(`theme-${themeId}`);

        document.getElementById('card-modal').classList.add('active');
    };

    window.closeCardModal = () => {
        document.getElementById('card-modal').classList.remove('active');
    };

    window.downloadCardImage = () => {
        const cardElement = document.getElementById('collectible-card');
        const btn = document.querySelector('.btn-download');
        const originalText = btn.innerText;
        btn.innerText = "Capturing... ğŸ“¸";
        
        if (typeof html2canvas === 'undefined') {
            alert("Snapshot library not loaded.");
            btn.innerText = originalText;
            return;
        }

        html2canvas(cardElement, {
            scale: 2,
            backgroundColor: null,
            useCORS: true
        }).then(canvas => {
            const link = document.createElement('a');
            const dateText = document.getElementById('card-display-date').innerText;
            link.download = `Shirley_MoonBase_Card_${dateText}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            btn.innerText = originalText;
        }).catch(err => {
            console.error(err);
            alert("Image capture failed.");
            btn.innerText = originalText;
        });
    };

    // é‡æ–°å®šç¾© handleCheckInï¼ŒåŠ å…¥é–‹å¡ç‰‡é‚è¼¯
    window.handleCheckIn = async () => {
        if (!currentUser) return;
        const fullDate = getLocalISODate();
        if (checkinHistory.includes(fullDate)) return;

        const btn = document.getElementById('checkin-btn');
        btn.disabled = true; 
        btn.innerText = "Transmitting...";
        
        try {
            let currentStreak = parseInt(document.getElementById('streak-days').innerText) || 0;
            const lastCheckIn = checkinHistory.length > 0 ? checkinHistory[checkinHistory.length - 1] : null;
            
            const yesterday = new Date(); 
            yesterday.setDate(yesterday.getDate() - 1);
            const yYear = yesterday.getFullYear();
            const yMonth = String(yesterday.getMonth() + 1).padStart(2, '0');
            const yDay = String(yesterday.getDate()).padStart(2, '0');
            const yesterdayStr = `${yYear}-${yMonth}-${yDay}`;
            
            if (lastCheckIn === yesterdayStr) { currentStreak++; } else { currentStreak = 1; }

            const userRef = doc(db, "users", currentUser.uid);
            const logEntry = { date: new Date().toISOString(), type: "Check-in", detail: "Daily Check-in" };

            await updateDoc(userRef, { 
                streak: currentStreak, 
                history: arrayUnion(fullDate),
                activityLogs: arrayUnion(logEntry)
            });

            checkinHistory.push(fullDate);
            activityLog.push(logEntry);
            
            document.getElementById('streak-days').innerText = currentStreak;
            document.getElementById('total-days').innerText = checkinHistory.length;
            btn.innerText = "Moon Check-in Success! ğŸŒ•";
            
            // é‡æ–°æ¸²æŸ“æ—¥æ›† (ä»¥ä¾¿æ›´æ–°é»æ“Šäº‹ä»¶)
            renderCalendar();
            renderCardBagList(); // âœ…ã€æœ€å°è£œä¸ã€‘æ‰“å¡å¾Œå¡è¢‹ç«‹å³æ›´æ–°

            // â˜…â˜…â˜… è‡ªå‹•å½ˆå‡ºå¡ç‰‡ â˜…â˜…â˜…
            setTimeout(() => {
                window.openCard(fullDate);
            }, 800);

        } catch (e) {
            console.error("Check-in error:", e);
            btn.innerText = "Check-in Failed";
            btn.disabled = false;
        }
    };

    // é‡æ–°å®šç¾© renderCalendarï¼ŒåŠ å…¥å¡è¢‹é»æ“ŠåŠŸèƒ½
    window.renderCalendar = function() {
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';
        const now = new Date();
        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        const currentYearMonth = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; 
        
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.innerText = i;
            dayEl.style.cssText = "aspect-ratio:1; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.05); border-radius:4px; transition:all 0.2s; color: var(--text);";
            
            const thisDateStr = `${currentYearMonth}-${String(i).padStart(2, '0')}`;
            
            if (checkinHistory.includes(thisDateStr)) { 
                dayEl.style.background = "var(--accent)"; 
                dayEl.style.color="white"; 
                dayEl.style.borderRadius="50%"; 
                dayEl.style.fontWeight = "bold";

                // â˜… åŠ å…¥å¯é»æ“Šé–‹å¡çš„æç¤º
                dayEl.classList.add('calendar-day-checked');
                dayEl.title = "Tap to open Card Pocket";
                dayEl.onclick = () => window.openCard(thisDateStr);
            }
            grid.appendChild(dayEl);
        }
    };

    // âœ…ã€æœ€å°è£œä¸ã€‘renderCardBagListï¼šå¡è¢‹æŒ‰æœˆä»½åˆ†å€
    function renderCardBagList() {
        const bag = document.getElementById("card-bag-list");
        if (!bag) return;
        bag.innerHTML = "";

        if (!checkinHistory || checkinHistory.length === 0) {
            bag.innerHTML = `<div style="font-size:0.75rem; color:var(--text-light);">No cards yet.</div>`;
            return;
        }

        // ä¾æ—¥æœŸæ’åºï¼ˆæ–°åˆ°èˆŠï¼‰
        const sorted = [...checkinHistory].sort().reverse();

        // åˆ†çµ„ï¼šYYYY-MM -> [dates...]
        const groups = {};
        sorted.forEach(d => {
            const ym = d.slice(0,7); // YYYY-MM
            if (!groups[ym]) groups[ym] = [];
            groups[ym].push(d);
        });

        // æ¸²æŸ“æ¯å€‹æœˆä»½å€å¡Šï¼ˆæ–°åˆ°èˆŠï¼‰
        Object.keys(groups).sort().reverse().forEach(ym => {
            const section = document.createElement("div");
            section.style.cssText = "margin-bottom:10px; padding:8px; border:1px dashed var(--border); border-radius:10px; background:rgba(0,0,0,0.02);";

            const title = document.createElement("div");
            title.innerText = ym;
            title.style.cssText = "font-size:0.75rem; font-weight:bold; color:var(--text-light); margin-bottom:6px; letter-spacing:0.5px;";
            section.appendChild(title);

            const row = document.createElement("div");
            row.style.cssText = "display:flex; flex-wrap:wrap; gap:6px;";

            groups[ym].forEach(dateStr => {
                const btn = document.createElement("button");
                btn.innerText = dateStr.slice(8); // DD
                btn.style.cssText = `
                  padding:4px 8px; border-radius:999px; border:1px solid var(--border);
                  background:var(--surface); color:var(--text); font-size:0.75rem;
                  cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.1);
                `;
                btn.title = dateStr;
                btn.onclick = () => window.openCard(dateStr);
                row.appendChild(btn);
            });

            section.appendChild(row);
            bag.appendChild(section);
        });
    }

    // --- End of new logic ---

    async function loadCSVData() {
        try {
            const [resWords, resQuotes] = await Promise.all([
                fetch('https://ducj-creator.github.io/Teacher-Shirley/assets/word%20of%20the%20day.csv'),
                fetch('https://ducj-creator.github.io/Teacher-Shirley/assets/quote%20of%20the%20day.csv')
            ]);
            csvData.words = parseCSV(await resWords.text());
            csvData.quotes = parseCSV(await resQuotes.text());
        } catch (e) {}
    }

    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        return lines.slice(1).map(line => {
            const row = {}; 
            const regex = /(?:,|\n|^)("(?:(?:"")*[^"]*)*"|[^",\n]*|(?:\n|$))/g;
            const matches = []; let match;
            while ((match = regex.exec(line)) !== null) { if (match.index === regex.lastIndex) regex.lastIndex++; if (match[1] !== undefined) matches.push(match[1].replace(/^"|"$/g, '').replace(/""/g, '"')); }
            headers.forEach((h, i) => row[h] = matches[i] ? matches[i].trim() : '');
            return row;
        });
    }

    function getTodayMMDD() { const now = new Date(); return String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0'); }

    function renderDailyContent(dateStr) {
        const wordObj = csvData.words.find(r => r.date === dateStr);
        if (wordObj) {
            document.getElementById('wotd-word').innerText = wordObj.word;
            document.getElementById('wotd-ipa').innerText = wordObj.ipa;
            document.getElementById('wotd-pos').innerText = wordObj.pos;
            document.getElementById('wotd-meaning').innerText = wordObj.meaning;
            document.getElementById('wotd-sentence-e').innerText = wordObj['sentence e'];
            document.getElementById('wotd-sentence-c').innerText = wordObj['sentence c'];
            document.getElementById('word-date').innerText = `(${dateStr})`;
        }
        const quoteObj = csvData.quotes.find(r => r.date === dateStr);
        if (quoteObj) {
            document.getElementById('qotd-text').innerText = quoteObj['quote e'];
            document.getElementById('qotd-trans').innerText = quoteObj['quote c'];
            document.getElementById('qotd-author').innerText = "â€” " + quoteObj.author;
        }
    }

    // renderCalendar is overwritten above, so we don't need the old one here.

    let processedLogs = [];

    function processActivityLogs(logs) {
        if (!logs || logs.length === 0) return [];
        const sortedLogs = [...logs].sort((a, b) => new Date(a.date) - new Date(b.date));
        const grouped = [];
        for (let i = 0; i < sortedLogs.length; i++) {
            const current = sortedLogs[i];
            const next = sortedLogs[i+1];
            const startTime = new Date(current.date);
            let endTime = next ? new Date(next.date) : new Date();
            let j = i + 1;
            while(j < sortedLogs.length && sortedLogs[j].detail === current.detail) {
                endTime = (j + 1 < sortedLogs.length) ? new Date(sortedLogs[j+1].date) : new Date();
                j++;
            }
            const durationMs = endTime - startTime;
            const minutes = Math.floor(durationMs / 60000);
            const durationStr = minutes < 1 ? "< 1 min" : `${minutes} mins`;
            grouped.push({ start: startTime, end: endTime, type: current.type, detail: current.detail, durationStr: durationStr });
            i = j - 1;
        }
        return grouped.reverse();
    }

    window.openPrintSelection = () => {
        if (!currentUser) return;
        processedLogs = processActivityLogs(activityLog);
        const listContainer = document.getElementById('log-selection-list');
        listContainer.innerHTML = '';
        if(processedLogs.length === 0) {
            listContainer.innerHTML = '<div style="padding:20px; text-align:center;">No records found.</div>';
            return;
        }
        processedLogs.forEach((log, index) => {
            const dateStr = log.start.toLocaleString([], {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute:'2-digit'});
            const row = document.createElement('div');
            row.className = 'log-item-row';
            row.innerHTML = `<input type="checkbox" id="log-check-${index}" class="log-checkbox"><div class="log-details"><span class="log-action">${log.type}: ${log.detail}</span><span class="log-time">${dateStr} (${log.durationStr})</span></div>`;
            listContainer.appendChild(row);
        });
        document.getElementById('print-selection-modal').style.display = 'flex';
    };

    window.closePrintSelection = () => { document.getElementById('print-selection-modal').style.display = 'none'; };
    window.toggleAllLogs = (checkStatus) => { document.querySelectorAll('.log-checkbox').forEach(cb => cb.checked = checkStatus); };

    window.confirmPrint = () => {
        const printBody = document.getElementById('print-body');
        printBody.innerHTML = '';
        document.getElementById('print-name').innerText = currentUser.displayName || currentUser.email;
        document.getElementById('print-date').innerText = new Date().toLocaleDateString();
        let hasSelection = false;
        processedLogs.forEach((log, index) => {
            const checkbox = document.getElementById(`log-check-${index}`);
            if(checkbox && checkbox.checked) {
                hasSelection = true;
                const tr = document.createElement('tr');
                const dateStr = log.start.toLocaleString([], {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute:'2-digit'});
                tr.innerHTML = `<td>${dateStr}<br><span style="font-size:0.8em; color:#666;">Duration: ${log.durationStr}</span></td><td>${log.type}</td><td>${log.detail}</td>`;
                printBody.appendChild(tr);
            }
        });
        if(!hasSelection) return alert("Please select at least one record to print.");
        document.getElementById('print-selection-modal').style.display = 'none';
        setTimeout(() => window.print(), 500);
    };

    const canvas = document.getElementById('particle-canvas');
    const ctx = canvas.getContext('2d');
    let particlesArray;
    function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', () => { resizeCanvas(); initParticles(); });
    resizeCanvas();
    class Particle {
        constructor() { this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height; this.size = Math.random() * 2; this.speedX = (Math.random() * 0.2 - 0.1); this.speedY = (Math.random() * 0.2 - 0.1); this.opacity = Math.random() * 0.5; }
        update() { this.x += this.speedX; this.y += this.speedY; if(this.x>canvas.width)this.x=0; if(this.x<0)this.x=canvas.width; if(this.y>canvas.height)this.y=0; if(this.y<0)this.y=canvas.height; }
        draw(isDark) { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fillStyle = isDark ? `rgba(255, 255, 255, ${this.opacity})` : `rgba(44, 62, 80, ${this.opacity * 0.5})`; ctx.fill(); }
    }
    function initParticles() { particlesArray = []; for (let i = 0; i < 80; i++) particlesArray.push(new Particle()); }
    function animateParticles() { requestAnimationFrame(animateParticles); ctx.clearRect(0, 0, canvas.width, canvas.height); const isDark = document.getElementById('htmlRoot').classList.contains('dark'); particlesArray.forEach(p => { p.update(); p.draw(isDark); }); }
    initParticles(); animateParticles();

    const html = document.getElementById('htmlRoot');
    document.getElementById('themeToggle').addEventListener('click', () => html.classList.toggle('dark'));
    const musicToggle = document.getElementById('musicToggle');
    const themeSong = document.getElementById('themeSong');
    let isPlaying = false;
    musicToggle.addEventListener('click', () => {
        if(isPlaying) { themeSong.pause(); musicToggle.style.color="var(--text)"; }
        else { themeSong.currentTime=0; themeSong.play(); musicToggle.style.color="var(--accent)"; }
        isPlaying = !isPlaying;
    });
<!-- ğŸŒ™ Moonlight Box Module START -->
<section id="moonlight-box" class="mlb-panel">
  <header class="mlb-header">
    <h2 class="mlb-title">ğŸŒ™ æœˆå…‰å¯¶ç›’</h2>
    <div class="mlb-subtitle">Lunar Glow Cache â€” å®Œæˆä»»å‹™è‡ªå‹•ç´¯ç©æœˆå…‰</div>
  </header>

  <!-- æœˆç›¸ / é»æ•¸ç¸½è¦½ -->
  <div class="mlb-card mlb-moon-ui">
    <div class="mlb-moon-emoji" id="mlb-moon-emoji">ğŸŒ‘</div>
    <div class="mlb-moon-stats">
      <div class="mlb-stat">ç›®å‰æœˆå…‰é»æ•¸ï¼š<b id="mlb-total">0</b> pts</div>
      <div class="mlb-stat">æœ¬è¼ªæ»¿æœˆé€²åº¦ï¼š<b id="mlb-cycle">0</b> / 300</div>
      <div class="mlb-progress-wrap">
        <div class="mlb-progress-bar" id="mlb-progress"></div>
      </div>
      <div class="mlb-stat">æœˆç›¸éšæ®µï¼š<b id="mlb-phase-text">New Moon</b></div>
    </div>
  </div>

  <div class="mlb-row">
    <!-- ä»»å‹™å…¥å£ -->
    <div class="mlb-col mlb-card">
      <h3 class="mlb-card-title">ğŸš€ Lunar Missionsï¼ˆæœˆå…‰ä»»å‹™ï¼‰</h3>

      <div class="mlb-task-list">
        <a class="mlb-task" href="https://ducj-creator.github.io/Teacher-Shirley/study-tools/GSAT%20Vocab.html"
           target="_blank" rel="noopener"
           data-mission="GSAT çœŸé¡Œ">
          <span>Mission 1ï¼šGSAT çœŸé¡Œ</span>
          <span class="mlb-task-tag">é–‹å§‹</span>
        </a>

        <a class="mlb-task" href="https://ivocab-quiz.vercel.app/"
           target="_blank" rel="noopener"
           data-mission="iVocab è€ƒé¡Œ">
          <span>Mission 2ï¼šiVocab è€ƒé¡Œ</span>
          <span class="mlb-task-tag">é–‹å§‹</span>
        </a>

        <!-- Mission 3: TBAï¼ˆå…ˆç•™è‘—ï¼Œé¡¯ç¤ºã€Œå³å°‡é–‹æ”¾ã€ï¼‰ -->
        <div class="mlb-task mlb-task-disabled">
          <span>Mission 3ï¼šTBA</span>
          <span class="mlb-task-tag">å³å°‡é–‹æ”¾</span>
        </div>

        <!-- Mission 4ï¼šä»¥å¾Œä½ è¦æ–°å¢ï¼Œåªè¦ç…§ Mission 1/2 å½¢å¼å†åŠ ä¸€æ¢ a -->
      </div>

      <div class="mlb-hint">
        ä»»å‹™å®Œæˆå¾Œï¼Œç³»çµ±æœƒè‡ªå‹•æŠŠã€Œæ­£ç¢ºé¡Œæ•¸ã€å›å‚³åˆ°ä¸»ç«™ä¸¦æ›´æ–°æœˆå…‰ã€‚<br/>
        ï¼ˆä¸éœ€ç­‰å¾…ã€ä¸éœ€æ‰‹å¡«ï¼‰
      </div>
    </div>

    <!-- è‡ªå‹•æ”¶é›†ç‹€æ…‹ -->
    <div class="mlb-col mlb-card">
      <h3 class="mlb-card-title">ğŸ§ª Auto Collectionï¼ˆè‡ªå‹•æ”¶é›†ï¼‰</h3>

      <div class="mlb-auto-box">
        <div class="mlb-stat">
          æœ€è¿‘æ”¶åˆ°çš„ä»»å‹™æˆç¸¾ï¼š
          <b id="mlb-last-result">å°šæœªæ”¶åˆ°</b>
        </div>

        <button class="mlb-btn mlb-btn-ghost" id="mlb-recheck">
          ğŸ”„ æª¢æŸ¥æ˜¯å¦æœ‰æ–°æˆç¸¾
        </button>

        <div class="mlb-hint">
          è‹¥ä»»å‹™é é¢å›å‚³æˆåŠŸï¼Œé€™è£¡æœƒé¡¯ç¤ºæ­£ç¢ºé¡Œæ•¸ï¼Œä¸¦ç«‹å³ç´¯ç©æœˆå…‰ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- æœ€è¿‘æ”¶é›†ç´€éŒ„ -->
  <div class="mlb-card">
    <h3 class="mlb-card-title">ğŸ“œ Recent Lunar Logsï¼ˆæœ€è¿‘æ”¶é›†ï¼‰</h3>
    <div class="mlb-log-box" id="mlb-log-box"></div>

    <div class="mlb-hint" id="mlb-login-hint" style="display:none;">
      ä½ ç›®å‰å°šæœªç™»å…¥ï¼Œæœˆå…‰å¯¶ç›’åªæœƒå°ç™»å…¥å¸³è™Ÿè¨˜éŒ„ã€‚è«‹å…ˆç™»å…¥ä¸»ç«™ã€‚
    </div>
  </div>
</section>

<style>
  /* ===== Moonlight Box Module Styles (scoped) ===== */
  #moonlight-box{
    --bg: rgba(255,255,255,0.06);
    --bg2: rgba(255,255,255,0.10);
    --border: rgba(255,255,255,0.15);
    --text: #ecf0f1;
    --dim: #b2bec3;
    --accent: #f1c40f;
    --accent2: #7ed6ff;
    font-family: "Exo 2","Noto Sans TC",sans-serif;
    color: var(--text);
  }
  .mlb-panel{
    width:100%; max-width:980px; margin:0 auto 16px auto;
    background: var(--bg); border:1px solid var(--border);
    border-radius:18px; padding:18px;
    backdrop-filter: blur(8px);
    box-shadow:0 15px 40px rgba(0,0,0,0.35);
  }
  .mlb-header{text-align:center; margin-bottom:12px;}
  .mlb-title{margin:0; font-size:1.6rem; letter-spacing:1px;}
  .mlb-subtitle{color:var(--dim); font-size:0.95rem;}

  .mlb-row{display:flex; gap:12px; flex-wrap:wrap;}
  .mlb-col{flex:1; min-width:280px;}

  .mlb-card{
    background:var(--bg2);
    border:1px dashed var(--border);
    border-radius:14px; padding:14px; margin-bottom:12px;
  }
  .mlb-card-title{
    margin:0 0 8px 0; font-size:1.05rem; letter-spacing:0.5px;
    color:var(--accent);
  }

  .mlb-moon-ui{display:flex; align-items:center; gap:14px;}
  .mlb-moon-emoji{font-size:2.6rem; width:52px; text-align:center;}
  .mlb-moon-stats{display:flex; flex-direction:column; gap:6px; width:100%;}
  .mlb-stat{font-size:0.92rem; color:var(--dim);}
  .mlb-stat b{color:var(--text); font-size:1.05rem;}

  .mlb-progress-wrap{
    background:rgba(255,255,255,0.08);
    border-radius:999px; overflow:hidden; height:12px;
    border:1px solid var(--border);
  }
  .mlb-progress-bar{
    height:100%; width:0%;
    background:linear-gradient(90deg, var(--accent), var(--accent2));
    transition:width 0.6s ease;
    box-shadow:0 0 12px rgba(241,196,15,0.6);
  }

  .mlb-task-list{display:flex; flex-direction:column; gap:8px;}
  .mlb-task{
    display:flex; justify-content:space-between; align-items:center;
    padding:10px 12px; border-radius:10px;
    background:rgba(0,0,0,0.25);
    border:1px solid var(--border);
    text-decoration:none; color:var(--text);
    transition:0.2s;
  }
  .mlb-task:hover{
    transform:translateY(-2px);
    border-color:var(--accent);
    box-shadow:0 4px 14px rgba(0,0,0,0.35);
  }
  .mlb-task-tag{font-size:0.8rem; color:var(--dim);}
  .mlb-task-disabled{
    opacity:0.6; cursor:not-allowed;
  }

  .mlb-btn{
    width:100%; padding:10px 12px; border-radius:999px;
    font-weight:700; font-size:1rem; cursor:pointer; border:none;
    margin-top:10px; transition:0.2s;
  }
  .mlb-btn-ghost{
    background:transparent; border:1px solid var(--border); color:var(--text);
  }
  .mlb-btn-ghost:hover{border-color:var(--accent); transform:translateY(-1px);}

  .mlb-hint{font-size:0.85rem; color:var(--dim); line-height:1.6; margin-top:6px;}

  .mlb-log-box{max-height:240px; overflow:auto; padding-right:6px;}
  .mlb-log-item{
    padding:8px 10px; border-radius:8px;
    background:rgba(0,0,0,0.25); border:1px solid var(--border);
    margin-bottom:6px; font-size:0.9rem;
    display:flex; justify-content:space-between; gap:8px;
  }
  .mlb-log-time{color:var(--dim); font-size:0.8rem;}
</style>
<!-- ğŸŒ™ Moonlight Box Module END -->

<script>
(function() {
    let missionInterval = null;

    // åˆå§‹åŒ–ï¼šæ›´æ–°ä»‹é¢é¡¯ç¤ºèˆŠæ•¸æ“š
    window.addEventListener('load', function() {
        updateInterface();
    });

    // 1. é–‹å§‹ä»»å‹™ï¼šè·³è½‰èˆ‡å€’æ•¸
    window.startLunarMission = function() {
        const inputs = ['moon-level', 'moon-unit', 'moon-correct', 'moon-wrong'];
        const timerDisplay = document.getElementById('mission-timer');
        
        // é–å®šè¼¸å…¥
        inputs.forEach(id => {
            const el = document.getElementById(id);
            if(el) { el.value = ''; el.disabled = true; el.placeholder = "ç­‰å¾…å†·å»..."; }
        });

        // ç¢ºä¿åŒ£å­éš±è—
        document.getElementById('glass-box-container').style.display = 'none';

        // å€’æ•¸æ–‡å­—
        if(timerDisplay) {
            timerDisplay.innerText = "â³ ä»»å‹™å•Ÿå‹•ä¸­...";
            timerDisplay.style.color = '#ff6b6b';
        }

        // --- æ ¸å¿ƒéœ€æ±‚ï¼šè·³è½‰åˆ°å­¸ç¿’ç¶²å€ ---
        setTimeout(() => {
            if(confirm("å³å°‡å‰å¾€ iVocab Quiz é€²è¡Œç·´ç¿’ï¼Œæº–å‚™å¥½äº†å—ï¼Ÿ")) {
                window.open('https://ivocab-quiz.vercel.app/', '_blank');
            }
        }, 500);

        // é–‹å§‹ 60 ç§’å€’æ•¸
        let timeLeft = 60; 
        if(missionInterval) clearInterval(missionInterval);

        missionInterval = setInterval(() => {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            const timeStr = `${m}:${s < 10 ? '0'+s : s}`;
            
            if(timerDisplay) timerDisplay.innerText = `â³ å†·å»ä¸­ (Wait): ${timeStr}`;
            
            if (timeLeft <= 0) {
                clearInterval(missionInterval);
                enableMissionInputs();
            }
            timeLeft--;
        }, 1000);
    };

    // 2. è§£é–è¼¸å…¥
    function enableMissionInputs() {
        ['moon-level', 'moon-unit', 'moon-correct', 'moon-wrong'].forEach(id => {
            const el = document.getElementById(id);
            if(el) { 
                el.disabled = false; 
                el.placeholder = "";
                if(id === 'moon-correct') el.focus();
            }
        });
        const timer = document.getElementById('mission-timer');
        if(timer) {
            timer.innerText = "ğŸš€ ç·´ç¿’å®Œæˆï¼è«‹è¼¸å…¥æ•¸æ“š (Ready)";
            timer.style.color = "#2ecc71";
        }
    }

    // 3. æ”¶é›†æœˆå…‰ï¼šé¡¯ç¤ºåŒ£å­ -> é£› -> æ›´æ–°
    window.collectMoonlight = function() {
        const correctEl = document.getElementById('moon-correct');
        const boxContainer = document.getElementById('glass-box-container');
        const box = document.getElementById('myGlassBox');
        const valDisplay = document.getElementById('glass-box-value');

        if (!correctEl || correctEl.disabled) {
            alert("âš ï¸ è«‹å…ˆ Start Mission ä¸¦å®Œæˆç·´ç¿’ï¼");
            return;
        }

        let val = parseInt(correctEl.value);
        if (isNaN(val) || val < 0) { alert("âŒ è«‹è¼¸å…¥æœ‰æ•ˆæ•¸å­—"); return; }
        if (val > 30) { alert("âŒ Correct ä¸èƒ½è¶…é 30"); return; }

        // [Phase 1] é¡¯ç¤ºç»ç’ƒåŒ£å­ (åœ¨å·¦å´é¢æ¿æ­£ä¸­å¤®)
        boxContainer.style.display = 'block'; // è®“å®¹å™¨é¡¯ç¤º
        valDisplay.innerText = val;
        
        // é‡ç½®å‹•ç•« classï¼Œè®“å®ƒå…ˆå‘ˆç¾å‡ºç¾ç‹€æ…‹
        box.className = 'glass-box'; 
        // å¼·åˆ¶é‡ç¹ª (Reflow)
        void box.offsetWidth;
        box.classList.add('visible'); // è§¸ç™¼å½ˆå‡ºç‰¹æ•ˆ

        // é–å®šè¼¸å…¥
        ['moon-level', 'moon-unit', 'moon-correct', 'moon-wrong'].forEach(id => {
            document.getElementById(id).disabled = true;
        });
        document.getElementById('mission-timer').innerText = "âœ¨ æœˆå…‰æ”¶é›†...";

        // [Phase 2] 1.5ç§’å¾Œï¼Œå¾€å³é£›
        setTimeout(() => {
            box.classList.remove('visible'); // ç§»é™¤éœæ­¢é¡¯ç¤ºç‹€æ…‹
            box.classList.add('flying');     // åŠ å…¥é£›è¡Œç‹€æ…‹

            // [Phase 3] å‹•ç•«çµæŸå¾Œï¼Œæ›´æ–°çœŸæ­£çš„æ•¸æ“š
            setTimeout(() => {
                performDataTransfer(val);
                boxContainer.style.display = 'none'; // éš±è—åŒ£å­
            }, 1000);

        }, 1500);
    };

    // 4. æ•¸æ“šé‚è¼¯
    function performDataTransfer(newThreads) {
        let currentTotal = parseInt(localStorage.getItem('shirley_total_moonlight') || 0);
        let storageCount = parseInt(localStorage.getItem('shirley_moon_storage') || 0);

        currentTotal += newThreads;
        let isFullMoon = false;

        // æ»¿æœˆé€²ä½é‚è¼¯
        if (currentTotal >= 300) {
            const moons = Math.floor(currentTotal / 300);
            storageCount += moons;
            currentTotal = currentTotal % 300;
            isFullMoon = true;
        }

        localStorage.setItem('shirley_total_moonlight', currentTotal);
        localStorage.setItem('shirley_moon_storage', storageCount);

        updateInterface();

        const timer = document.getElementById('mission-timer');
        if(timer) {
            timer.innerText = "âœ… å‚³è¼¸å®Œæˆã€‚è«‹æº–å‚™ä¸‹ä¸€è¼ªã€‚";
            timer.style.color = "#ffd700";
        }

        if(isFullMoon) {
            alert(`ğŸŒ• æ­å–œï¼æœˆå…‰èƒ½é‡æ»¿æº¢ï¼ç²å¾— ${storageCount} å€‹æ»¿æœˆå„²å­˜ï¼`);
            updateInterface();
        }
    }

    // 5. æ›´æ–° UI æ•¸å­—
    function updateInterface() {
        const total = localStorage.getItem('shirley_total_moonlight') || 0;
        const storage = localStorage.getItem('shirley_moon_storage') || 0;

        const stEl = document.getElementById('moon-storage-count');
        const phEl = document.getElementById('current-moonlight-display');

        if(stEl) stEl.innerText = storage;
        if(phEl) phEl.innerText = total;
    }
})();
</script>
  <script type="module">
  // ====== å–ç”¨ä¸»ç«™ Firebase ======
  function getAuthDB(){
    // å…¼å®¹å¤šç¨®ä¸»ç«™å¯«æ³•
    const auth = window.__AUTH__ || window.auth || window.firebaseAuth;
    const db   = window.__DB__   || window.db   || window.firestoreDB;
    if (!auth || !db) {
      console.error("[MoonlightBox] Firebase auth/db not found on main site.");
    }
    return {auth, db};
  }

  // å¾ firebase sdkï¼ˆä¸»ç«™æ‡‰è©²å·²è¼‰å…¥ï¼›è‹¥æ²’è¼‰å…¥å°±ä¸æœƒè·‘åˆ°é€™ï¼‰
  import {
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

  import {
    doc, getDoc, setDoc, updateDoc, arrayUnion, increment
  } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

  const {auth, db} = getAuthDB();

  // ====== å¸¸æ•¸ ======
  const MOON_CYCLE = 300;

  let currentUser = null;
  let moonData = { totalGlow:0, cycleGlow:0, logs:[] };

  // ====== æœˆç›¸ UI ======
  function phaseByPercent(p){
    if (p < 0.12) return {emoji:"ğŸŒ‘", text:"New Moon / æ–°æœˆ"};
    if (p < 0.25) return {emoji:"ğŸŒ’", text:"Waxing Crescent / è›¾çœ‰æœˆ"};
    if (p < 0.38) return {emoji:"ğŸŒ“", text:"First Quarter / ä¸Šå¼¦æœˆ"};
    if (p < 0.50) return {emoji:"ğŸŒ”", text:"Waxing Gibbous / ç›ˆå‡¸æœˆ"};
    if (p < 0.62) return {emoji:"ğŸŒ•", text:"Full Moon / æ»¿æœˆ"};
    if (p < 0.75) return {emoji:"ğŸŒ–", text:"Waning Gibbous / è™§å‡¸æœˆ"};
    if (p < 0.88) return {emoji:"ğŸŒ—", text:"Last Quarter / ä¸‹å¼¦æœˆ"};
    return {emoji:"ğŸŒ˜", text:"Waning Crescent / æ®˜æœˆ"};
  }

  function renderMoonUI(){
    const totalEl = document.getElementById("mlb-total");
    const cycleEl = document.getElementById("mlb-cycle");
    const barEl   = document.getElementById("mlb-progress");
    const emojiEl = document.getElementById("mlb-moon-emoji");
    const phaseEl = document.getElementById("mlb-phase-text");

    if (!totalEl) return; // æ¨¡çµ„ä¸åœ¨é é¢ä¸Šå°±è·³é

    totalEl.innerText = moonData.totalGlow || 0;
    cycleEl.innerText = moonData.cycleGlow || 0;

    const percent = Math.min((moonData.cycleGlow || 0)/MOON_CYCLE, 1);
    barEl.style.width = `${percent*100}%`;

    const phase = phaseByPercent(percent);
    emojiEl.innerText = phase.emoji;
    phaseEl.innerText = phase.text;

    renderLogs();
  }

  function renderLogs(){
    const box = document.getElementById("mlb-log-box");
    if (!box) return;

    box.innerHTML = "";
    const logs = moonData.logs || [];
    if (logs.length===0){
      box.innerHTML = `<div class="mlb-hint">ç›®å‰é‚„æ²’æœ‰æœˆå…‰ç´€éŒ„ã€‚</div>`;
      return;
    }

    logs.slice().reverse().slice(0,30).forEach(l=>{
      const div = document.createElement("div");
      div.className="mlb-log-item";
      const time = new Date(l.time).toLocaleString();
      div.innerHTML = `
        <div>
          +<b>${l.glow}</b> pts
          <span style="color:#aaa;">(âœ…${l.correct})</span>
          <span style="color:#bbb;">${l.mission? " Â· "+l.mission:""}</span>
        </div>
        <div class="mlb-log-time">${time}</div>
      `;
      box.appendChild(div);
    });
  }

  // ====== è®€ Firestoreï¼ˆåªç”¨ uidï¼‰ ======
  async function loadMoonData(uid){
    const userRef = doc(db, "users", uid);
    const snap = await getDoc(userRef);

    if (!snap.exists()){
      await setDoc(userRef, {
        moonGlowTotal:0,
        moonGlowCycle:0,
        moonGlowLogs:[]
      }, {merge:true});
      moonData = {totalGlow:0, cycleGlow:0, logs:[]};
      renderMoonUI();
      return;
    }
    const d = snap.data();
    moonData.totalGlow = d.moonGlowTotal || 0;
    moonData.cycleGlow = d.moonGlowCycle || 0;
    moonData.logs = d.moonGlowLogs || [];
    renderMoonUI();
  }

  // ====== âœ… æ–°è¨ˆåˆ†é‚è¼¯ï¼ˆç³»çµ±æ ¹æ“š correctCount è‡ªå‹•ç´¯ç©ï¼‰=====
  // ä½ å¯è‡ªç”±æ”¹å€ç‡
  function calcGlow(correctCount){
    // æœˆå…‰ = æ­£ç¢ºé¡Œæ•¸ Ã— 5
    return Math.max(0, (correctCount||0) * 5);
  }

  async function applyResult({correctCount, mission}){
    if (!currentUser) {
      document.getElementById("mlb-login-hint").style.display="block";
      return;
    }

    const correct = parseInt(correctCount)||0;
    if (correct<=0) return;

    const glow = calcGlow(correct);

    // cycleæº¢å‡º
    let newCycle = (moonData.cycleGlow||0) + glow;
    if (newCycle >= MOON_CYCLE) newCycle = newCycle % MOON_CYCLE;

    const logEntry = {
      time: new Date().toISOString(),
      correct,
      glow,
      mission: mission || null
    };

    const userRef = doc(db,"users",currentUser.uid);
    await updateDoc(userRef,{
      moonGlowTotal: increment(glow),
      moonGlowCycle: newCycle,
      moonGlowLogs: arrayUnion(logEntry),
      activityLogs: arrayUnion({
        date: new Date().toISOString(),
        type: "Lunar Glow",
        detail: `Collected ${glow} pts (âœ…${correct}) ${mission? "["+mission+"]":""}`
      })
    });

    // æœ¬åœ°åŒæ­¥
    moonData.totalGlow += glow;
    moonData.cycleGlow = newCycle;
    moonData.logs.push(logEntry);

    renderMoonUI();
    showLastResult(correct, mission, glow);

    // ç”¨å®Œå°±æ¸…æ‰æš«å­˜é¿å…é‡è¤‡åŠ åˆ†
    localStorage.removeItem("lunar_pending_result");
  }

  function showLastResult(correct, mission, glow){
    const el = document.getElementById("mlb-last-result");
    if (!el) return;
    el.innerHTML = `âœ…${correct} é¡Œ â†’ +${glow} pts ${mission? " Â· "+mission:""}`;
  }

  // ====== æ¥æ”¶ä»»å‹™é é¢å›å‚³æˆç¸¾ï¼ˆå…©ç¨®æ–¹å¼éƒ½æ”¯æ´ï¼‰=====
  // A) postMessage
  window.addEventListener("message", (e)=>{
    // ä½ è‡ªå·±çš„ä»»å‹™ç«™éƒ½å¯åŠ é€™å€‹ï¼Œä¸é™åˆ¶ domain ä¹Ÿå¯
    const data = e.data;
    if (!data || data.type!=="LUNAR_RESULT") return;

    // data = {type:"LUNAR_RESULT", correctCount:xx, mission:"GSAT çœŸé¡Œ"}
    localStorage.setItem("lunar_pending_result", JSON.stringify(data));
    applyResult(data);
  });

  // B) localStorageï¼ˆåŒæºä»»å‹™é ï¼‰
  function checkPending(){
    const raw = localStorage.getItem("lunar_pending_result");
    if (!raw) return;
    try{
      const data = JSON.parse(raw);
      if (data && data.correctCount) applyResult(data);
    }catch(err){
      console.warn("[MoonlightBox] pending_result parse failed", err);
    }
  }

  document.getElementById("mlb-recheck")?.addEventListener("click", checkPending);

  // ====== Auth ç¶å®šï¼ˆåªçœ‹ç™»å…¥å¸³è™Ÿï¼‰=====
  onAuthStateChanged(auth, async (user)=>{
    currentUser = user || null;

    const hint = document.getElementById("mlb-login-hint");
    if (!currentUser){
      if (hint) hint.style.display="block";
      moonData={totalGlow:0, cycleGlow:0, logs:[]};
      renderMoonUI();
      return;
    }

    if (hint) hint.style.display="none";
    await loadMoonData(currentUser.uid);
    checkPending();
  });

  // åˆå§‹æ¸²æŸ“
  document.addEventListener("DOMContentLoaded", renderMoonUI);
</script>
</body>
</html>
