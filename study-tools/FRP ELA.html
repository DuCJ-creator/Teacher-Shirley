<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ELA Vocab Champion / å–®å­—å†’éšªç‹</title>
  <style>
    body {
      font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #e6e9f0, #f8f6f2);
      margin: 0;
      padding: 15px;
      text-align: center;
      color: #2c3e50;
      overflow-x: hidden;
      position: relative;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 24px rgba(44, 62, 80, 0.12);
      position: relative;
      z-index: 1;
    }
    h1 {
      color: #2c3e50;
      font-size: 24px;
      margin-bottom: 12px;
      font-weight: 600;
      line-height: 1.4;
    }
    .lang-switch {
      font-size: 14px;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    .zh { color: #2c3e50; font-weight: 500; }
    .en { color: #7f8c8d; font-size: 0.9em; }
    .separator { margin: 0 4px; color: #bdc3c7; }

    .screen { display: none; }
    .active { display: block; }

    button {
      background: #e0e5ec;
      border: 1px solid #cbd2d9;
      border-radius: 50px;
      padding: 12px 20px;
      margin: 8px;
      font-size: 16px;
      font-weight: 500;
      color: #2c3e50;
      cursor: pointer;
      transition: all 0.25s ease;
      box-shadow: 0 3px 8px rgba(0,0,0,0.06);
    }
    button:hover {
      background: #d1d8e0;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .word-display {
      font-size: 26px;
      margin: 22px 0;
      font-weight: 700;
      color: #2c3e50;
      cursor: pointer;
    }
    .pos {
      font-size: 16px;
      color: #7f8c8d;
      margin-bottom: 8px;
      font-style: italic;
    }
    .source {
      font-size: 14px;
      color: #95a5a6;
      margin-top: -4px;
      font-weight: 500;
    }

    .options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin: 22px 0;
    }
    .option-btn {
      /* ç§»é™¤é è¨­èƒŒæ™¯ï¼Œæ”¹ç”±ä¸‹æ–¹ nth-child è¨­å®š */
      color: #34495e;
      text-align: left; /* æ”¹ç‚ºé å·¦å°é½Šï¼Œè®“ ABCD æ¯”è¼ƒæ•´é½Š */
      padding: 14px;
      border-radius: 14px;
      border: 1px solid #eaecee;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
    }
    
    /* === æ–°å¢ï¼šABCD é¸é …çš„ä¸åŒèƒŒæ™¯è‰² (é¿é–‹æ­£è§£çš„ç¶ è‰²å’ŒéŒ¯èª¤çš„ç´…è‰²) === */
    /* é¸é … A: æ·¡è—è‰² */
    .option-btn:nth-child(1) {
      background-color: #E3F2FD;
      border-color: #BBDEFB;
    }
    /* é¸é … B: æ·¡é»ƒè‰² */
    .option-btn:nth-child(2) {
      background-color: #FFF9C4;
      border-color: #FFF59D;
    }
    /* é¸é … C: æ·¡ç´«è‰² */
    .option-btn:nth-child(3) {
      background-color: #F3E5F5;
      border-color: #E1BEE7;
    }
    /* é¸é … D: æ·¡æ©˜è‰² */
    .option-btn:nth-child(4) {
      background-color: #FFE0B2;
      border-color: #FFCC80;
    }

    .option-btn:hover:not(:disabled) {
      transform: translateY(-1px);
      filter: brightness(0.95); /* hover æ™‚ç¨å¾®è®Šæš—ä¸€é»é» */
    }
    
    .option-btn:disabled {
      opacity: 0.85;
      cursor: not-allowed;
    }

    /* ä½¿ç”¨ !important ç¢ºä¿ç­”å°ç­”éŒ¯çš„é¡è‰²æœƒè“‹éåŸæœ¬çš„é¸é …é¡è‰² */
    .option-btn.correct {
      background: #d4edda !important;
      color: #155724 !important;
      border-color: #c3e6cb !important;
    }
    .option-btn.wrong {
      background: #f8d7da !important;
      color: #721c24 !important;
      border-color: #f1b0b7 !important;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: #e9ecef;
      border-radius: 6px;
      margin: 18px 0;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(to right, #2c7d6d, #34988e);
      transition: width 0.1s linear;
    }

    .score, .timer {
      font-size: 19px;
      margin: 12px 0;
      font-weight: 600;
      color: #2c3e50;
    }

    .explosion {
      font-size: 50px;
      animation: explode 0.8s ease-out forwards;
      margin: 20px 0;
      opacity: 0;
    }
    @keyframes explode {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(0); opacity: 0; }
    }

    .result {
      font-size: 20px;
      margin: 18px 0;
      min-height: 28px;
      color: #e74c3c;
    }
    .final-score {
      font-size: 28px;
      color: #2c3e50;
      margin: 15px 0;
      font-weight: 700;
    }
    .stats {
      text-align: left;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
      font-size: 16px;
      line-height: 1.6;
    }
    .wrong-list {
      max-height: 200px;
      overflow-y: auto;
      padding: 10px 0;
      font-family: monospace;
    }

    /* === é£„å‹•çµ²å¸¶ === */
    .ribbon {
      position: absolute;
      top: -20px;
      font-size: 24px;
      opacity: 0.8;
      animation: floatDown 8s infinite ease-in;
      z-index: 998;
      pointer-events: none;
    }
    @keyframes floatDown {
      0% { transform: translateY(0) rotate(0deg); opacity: 0; }
      10% { opacity: 0.9; }
      90% { opacity: 0.7; }
      100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }

    /* === ç…™ç«ç‰¹æ•ˆ === */
    .firework {
      position: absolute;
      pointer-events: none;
      z-index: 1000;
      font-size: 28px;
      animation: fireworkBurst 1.2s ease-out forwards;
      opacity: 0;
    }
    @keyframes fireworkBurst {
      0% { transform: scale(0.2); opacity: 0; }
      20% { opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }

    /* é£›èˆç¨è§’ç¸ */
    .floating-unicorn {
      position: fixed;
      top: 12vh;
      right: 6vw;
      font-size: 24px;
      animation: float 3s ease-in-out infinite;
      z-index: 999;
      pointer-events: none;
    }
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-12px); }
      100% { transform: translateY(0px); }
    }
  </style>
</head>
<body>
  <div class="floating-unicorn">ğŸ¦„</div>

  <div id="ribbons"></div>
  <div id="fireworks"></div>

  <div class="container">
    <div id="select-screen" class="screen active">
      <div class="unicorn">ğŸ¦„âœ¨ğŸ‘¸</div>
      <h1>
        <div class="zh">FRP ELA å–®å­—å†’éšªç‹æŒ‘æˆ°</div>
        <div class="en">FRP ELA Vocab Challenge</div>
      </h1>
      <p>
        <span class="zh">è«‹é¸æ“‡å­¸æœŸèˆ‡å–®å…ƒï¼š</span>
        <span class="separator">/</span>
        <span class="en">Select Semester & Units:</span>
      </p>

      <div style="margin: 15px 0;">
        <strong class="zh">å­¸æœŸï¼š</strong><strong class="en">Semester:</strong><br/>
        <label><input type="radio" name="semester" value="SI" checked> SI</label>
        <label><input type="radio" name="semester" value="SII"> SII</label>
        <label><input type="radio" name="semester" value="SIII"> SIII</label>
        <label><input type="radio" name="semester" value="SIV"> SIV</label>
      </div>

      <div style="margin: 15px 0;">
        <strong class="zh">å–®å…ƒï¼ˆå¯è¤‡é¸ï¼‰ï¼š</strong><strong class="en">Units (multi-select):</strong><br/>
        <label><input type="checkbox" value="1"> 1</label>
        <label><input type="checkbox" value="2"> 2</label>
        <label><input type="checkbox" value="3"> 3</label>
        <label><input type="checkbox" value="4"> 4</label>
        <label><input type="checkbox" value="5"> 5</label>
        <label><input type="checkbox" value="6"> 6</label>
        <label><input type="checkbox" value="7"> 7</label>
        <label><input type="checkbox" value="8"> 8</label>
      </div>

      <button onclick="loadAndStart()">
        <span class="zh">é–‹å§‹éŠæˆ²</span>
        <span class="separator">/</span>
        <span class="en">Start Game</span>
      </button>
    </div>

    <div id="start-screen" class="screen">
      <div class="unicorn">ğŸ¦„âœ¨ğŸ‘¸</div>
      <h1>
        <div class="zh">æº–å‚™å¥½å°±é–‹å§‹å§ï¼</div>
        <div class="en">Ready to Play!</div>
      </h1>
      <p>
        <span class="zh">é¸æ“‡ä½ çš„å†’éšªæ™‚é–“ï¼š</span>
        <span class="separator">/</span>
        <span class="en">Choose your time:</span>
      </p>
      <button onclick="initAndStart(60)">1 åˆ†é˜ / 1 min</button>
      <button onclick="initAndStart(180)">3 åˆ†é˜ / 3 min</button>
      <button onclick="initAndStart(300)">5 åˆ†é˜ / 5 min</button>
      <button onclick="initAndStart(600)">10 åˆ†é˜ / 10 min</button>
    </div>

    <div id="game-screen" class="screen">
      <div class="score">
        <span class="zh">å¾—åˆ†ï¼š</span>
        <span class="en">Score: </span>
        <span id="score">0</span>
      </div>
      <div class="timer">
        <span class="zh">å‰©é¤˜æ™‚é–“ï¼š</span>
        <span class="en">Time Left: </span>
        <span id="time-left">0</span>
        <span class="zh">ç§’</span>
        <span class="en">seconds</span>
      </div>
      <div class="word-display" id="word">Loading...</div>
      <div class="pos" id="pos"></div>
      <div class="source" id="source"></div>
      <div class="progress-bar"><div class="progress-fill" id="progress"></div></div>
      <div class="options" id="options"></div>
      <div class="result" id="result"></div>
    </div>

    <div id="end-screen" class="screen">
      <div class="unicorn">ğŸ‰ğŸ‘‘ğŸ¦„</div>
      <h1>
        <div class="zh">å†’éšªçµæŸï¼</div>
        <div class="en">Game Over!</div>
      </h1>
      <div class="final-score">
        <span class="zh">ä½ çš„ç¸½åˆ†ï¼š</span>
        <span class="en">Your Score: </span>
        <span id="final-score">0</span>
      </div>
      
      <div class="stats">
        <div>
          <span class="zh">ç­”å°é¡Œæ•¸ï¼š</span>
          <span class="en">Correct: </span>
          <span id="correct-count">0</span>
        </div>
        <div>
          <span class="zh">ç­”éŒ¯é¡Œæ•¸ï¼š</span>
          <span class="en">Wrong: </span>
          <span id="wrong-count">0</span>
        </div>
        <div>
          <span class="zh">æ­£ç¢ºç‡ï¼š</span>
          <span class="en">Accuracy: </span>
          <span id="accuracy">0</span>%
        </div>
      </div>

      <div id="wrong-words-section" style="display:none;">
        <h3>
          <span class="zh">ç­”éŒ¯çš„å–®å­—ï¼š</span>
          <span class="en">Words You Missed:</span>
        </h3>
        <div class="wrong-list" id="wrong-words-list"></div>
      </div>

      <button onclick="restartGame()">
        <span class="zh">å†ç©ä¸€æ¬¡</span>
        <span class="separator">/</span>
        <span class="en">Play Again</span>
      </button>
    </div>
  </div>

  <script>
    // ====== å…¨åŸŸè®Šæ•¸ ======
    let audioContext = null;
    let isAudioReady = false;
    let selectedSemester = "SI";
    let selectedUnits = [];
    let wordList = [];
    let filteredWords = [];
    let originalFilteredWords = [];
    let remainingWords = [];
    let wrongWords = [];
    let score = 0;
    let streak = 0;
    let totalGameTime = 0;
    let timeLeft = 0;
    let gameTimer = null;
    let progressInterval = null;
    let correctCount = 0;
    let wrongCount = 0;

    // ====== èªéŸ³æœ—è®€ ======
    function speakWord(text) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        speechSynthesis.cancel();
        speechSynthesis.speak(utterance);
      }
    }

    // ====== éŸ³æ•ˆç³»çµ±ï¼ˆä¿æŒä¸è®Šï¼‰======
    function initAudio() {
      if (audioContext) return;
      try {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();
        isAudioReady = true;
      } catch (e) {
        console.warn("Audio not supported");
        isAudioReady = false;
      }
    }

    function playTone(frequency, duration, type = 'sine', gain = 0.2) {
      if (!isAudioReady) return;
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      oscillator.type = type;
      oscillator.frequency.value = frequency;
      gainNode.gain.value = gain;
      gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      oscillator.start();
      oscillator.stop(audioContext.currentTime + duration);
    }

    function playCorrectSound() {
      playTone(880, 0.2, 'sine', 0.15);
      setTimeout(() => playTone(1320, 0.2, 'sine', 0.15), 100);
    }

    function playWrongSound() {
      playTone(220, 0.3, 'sawtooth', 0.1);
      setTimeout(() => playTone(165, 0.3, 'sawtooth', 0.1), 150);
    }

    function playExplosionSound() {
      playTone(80, 0.4, 'square', 0.2);
      setTimeout(() => {
        if (!isAudioReady) return;
        const noise = audioContext.createBufferSource();
        const buffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.3, audioContext.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < data.length; i++) {
          data[i] = Math.random() * 2 - 1;
        }
        noise.buffer = buffer;
        const noiseGain = audioContext.createGain();
        noiseGain.gain.value = 0.1;
        noiseGain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
        noise.connect(noiseGain);
        noiseGain.connect(audioContext.destination);
        noise.start();
      }, 100);
    }

    // ====== å–œæ…¶è¦–è¦ºç‰¹æ•ˆ ======
    function createFirework(x, y) {
      const emoji = ['ğŸ‰', 'ğŸŠ', 'ğŸ†', 'ğŸ‡', 'âœ¨'][Math.floor(Math.random() * 5)];
      const firework = document.createElement('div');
      firework.className = 'firework';
      firework.textContent = emoji;
      firework.style.left = `${x}px`;
      firework.style.top = `${y}px`;
      document.getElementById('fireworks').appendChild(firework);
      setTimeout(() => firework.remove(), 1200);
    }

    function createRibbon() {
      const emoji = ['ğŸ€', 'ğŸ', 'ğŸˆ', 'ğŸŠ'][Math.floor(Math.random() * 4)];
      const ribbon = document.createElement('div');
      ribbon.className = 'ribbon';
      ribbon.textContent = emoji;
      ribbon.style.left = `${Math.random() * 90 + 5}%`;
      ribbon.style.animationDelay = `${Math.random() * 2}s`;
      document.getElementById('ribbons').appendChild(ribbon);
      setTimeout(() => ribbon.remove(), 8500);
    }

    // è‡ªå‹•ç”Ÿæˆé£„å‹•çµ²å¸¶
    setInterval(() => {
      if (document.getElementById('game-screen').classList.contains('active')) {
        createRibbon();
      }
    }, 2500);

    // ====== CSV è¼‰å…¥ï¼ˆä¸è®Šï¼‰======
    async function loadCSV() {
      const url = 'https://ducj-creator.github.io/Teacher-Shirley/study-tools/FRP%20ELA%20Vocab.csv';
      try {
        const response = await fetch(url);
        const text = await response.text();
        parseCSV(text);
      } catch (error) {
        alert('ç„¡æ³•å¾ GitHub è¼‰å…¥å–®å­—è³‡æ–™ã€‚\nPlease check your internet connection.');
        console.error('CSV Load Error:', error);
      }
    }

    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim() !== '');
      const headers = lines[0].split(',').map(h => h.trim());
      wordList = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const row = {};
        headers.forEach((header, idx) => {
          row[header] = values[idx] || '';
        });
        wordList.push({
          semester: row['Semester'],
          unit: row['Unit'],
          no: row['No.'],
          word: row['Word'],
          pos: row['POS'],
          meaning: row['Chinese Meaning'],
          source: `${row['Semester']}-${row['Unit']}-${row['No.']}`
        });
      }
    }

    function filterWords() {
      filteredWords = wordList.filter(word => {
        return word.semester === selectedSemester && selectedUnits.includes(word.unit);
      });

      const seen = new Set();
      filteredWords = filteredWords.filter(item => {
        const key = item.word + '|' + item.meaning;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });

      if (filteredWords.length === 0) {
        alert('æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å–®å­—ï¼\nNo words match your selection.');
        return false;
      }
      return true;
    }

    // ====== éŠæˆ²é‚è¼¯ï¼ˆæ›´æ–°ï¼šåŠ å…¥ A,B,C,D æ¨™ç±¤ï¼‰======
    function getRandomMeanings(correct, count = 3) {
      let options = [correct];
      let pool = [...new Set(wordList.map(w => w.meaning))].filter(m => m !== correct);
      for (let i = 0; i < count && pool.length > 0; i++) {
        let idx = Math.floor(Math.random() * pool.length);
        options.push(pool[idx]);
        pool.splice(idx, 1);
      }
      return options.sort(() => Math.random() - 0.5);
    }

    function showQuestion() {
      let wordObj = null;

      if (wrongWords.length > 0) {
        let idx = Math.floor(Math.random() * wrongWords.length);
        wordObj = wrongWords[idx];
      } else if (remainingWords.length > 0) {
        let idx = Math.floor(Math.random() * remainingWords.length);
        wordObj = remainingWords[idx];
        remainingWords.splice(idx, 1);
      } else {
        remainingWords = [...originalFilteredWords];
        if (remainingWords.length > 0) {
          let idx = Math.floor(Math.random() * remainingWords.length);
          wordObj = remainingWords[idx];
          remainingWords.splice(idx, 1);
        } else {
          wordObj = originalFilteredWords[0];
        }
      }

      document.getElementById('word').textContent = wordObj.word;
      document.getElementById('pos').textContent = wordObj.pos;
      document.getElementById('source').textContent = `Source: ${wordObj.source}`;

      document.getElementById('word').onclick = () => speakWord(wordObj.word);

      const options = getRandomMeanings(wordObj.meaning);
      const optionsDiv = document.getElementById('options');
      optionsDiv.innerHTML = '';
      
      // === ä¿®æ”¹è™•ï¼šåŠ å…¥æ¨™ç±¤é™£åˆ— ===
      const labels = ['A', 'B', 'C', 'D'];

      options.forEach((opt, index) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        
        // === ä¿®æ”¹è™•ï¼šæ’å…¥ A. B. C. D. æ¨™ç±¤ ===
        // ä½¿ç”¨ innerHTML ä¾†åŒ…å«ç²—é«”çš„æ¨™ç±¤
        // å¦‚æœ index è¶…é 3 (é›–ç„¶é€™è£¡è¨­å›ºå®š4å€‹é¸é …)ï¼Œé¿å… undefined
        const labelText = labels[index] ? labels[index] : ''; 
        btn.innerHTML = `<strong style="font-size:1.1em; margin-right:8px;">${labelText}.</strong> ${opt}`;
        
        // æ³¨æ„ï¼šé€™è£¡ checkAnswer å‚³å…¥çš„ opt æ˜¯ç´”æ–‡å­—ï¼Œä¸åŒ…å« HTML æ¨™ç±¤
        btn.onclick = () => checkAnswer(opt, wordObj.meaning, wordObj);
        optionsDiv.appendChild(btn);
      });

      let time = 8;
      const progressBar = document.getElementById('progress');
      progressBar.style.width = '100%';
      clearInterval(progressInterval);
      progressInterval = setInterval(() => {
        time -= 0.1;
        const percent = (time / 8) * 100;
        progressBar.style.width = percent + '%';
        if (time <= 0) {
          clearInterval(progressInterval);
          timeUp(wordObj.meaning, wordObj);
        }
      }, 100);
    }

    function checkAnswer(selected, correct, wordObj) {
      clearInterval(progressInterval);
      const buttons = document.querySelectorAll('.option-btn');
      
      // é€™è£¡çš„é‚è¼¯éœ€è¦å¾®èª¿ï¼Œå› ç‚º btn.textContent ç¾åœ¨åŒ…å«äº† "A. é¸é …å…§å®¹"
      // æ‰€ä»¥æ¯”å°æ™‚è¦çœ‹æŒ‰éˆ•æ˜¯å¦ã€ŒåŒ…å«ã€æ­£ç¢ºç­”æ¡ˆï¼Œæˆ–è€…æˆ‘å€‘æ¯”å°é»æ“Šæ™‚å‚³å…¥çš„ raw text
      
      buttons.forEach(btn => {
        // ç”±æ–¼ innerHTML æ”¹è®Šäº†ï¼Œbtn.textContent æœƒè®Šæˆ "A. ç­”æ¡ˆ"ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥å…¨ç­‰æ¯”å°
        // æˆ‘å€‘æ”¹ç”¨ textContent æ˜¯å¦åŒ…å«è©²å«æ„
        // ä½†æœ€å®‰å…¨çš„æ–¹å¼æ˜¯æª¢æŸ¥ btn çš„ innerHTML æˆ–é»æ“Šæ™‚çš„é‚è¼¯
        // é€™è£¡ç°¡å–®è™•ç†ï¼šå› ç‚ºæˆ‘å€‘å‚³å…¥çš„ selected æ˜¯åŸå§‹æ–‡å­—
        
        // ç‚ºäº†ç¢ºä¿æ¨£å¼æ­£ç¢ºï¼Œæˆ‘å€‘æª¢æŸ¥æŒ‰éˆ•æ–‡å­—çµå°¾æ˜¯å¦åŒ…å«è©²é¸é …
        // æˆ–è€…æ›´ç°¡å–®ï¼šæˆ‘å€‘åœ¨ç”ŸæˆæŒ‰éˆ•æ™‚å…¶å¯¦å¯ä»¥æŠŠç­”æ¡ˆå­˜åœ¨ data-attributeï¼Œä½†é€™è£¡ä¸å‹•å¤§æ¶æ§‹
        // æˆ‘å€‘ç”¨ "includes" ä¾†åˆ¤æ–·
        
        if (btn.innerText.includes(correct)) {
          btn.classList.add('correct');
        } else if (btn.innerText.includes(selected)) {
          // åªæœ‰ç•¶é€™å€‹æŒ‰éˆ•æ˜¯ä½¿ç”¨è€…é¸çš„é‚£å€‹éŒ¯èª¤ç­”æ¡ˆæ™‚æ‰è®Šç´…
          // é€™è£¡å› ç‚º forEach æœƒè·‘éæ‰€æœ‰æŒ‰éˆ•ï¼Œç„¡æ³•å¾—çŸ¥å“ªå€‹æ˜¯è¢«é»çš„
          // ä½†å› ç‚º selected åƒæ•¸æ˜¯ã€Œè¢«é»é¸çš„é‚£å€‹æŒ‰éˆ•çš„åŸå§‹æ–‡å­—ã€
          // æ‰€ä»¥åªè¦æŒ‰éˆ•æ–‡å­—åŒ…å« selectedï¼Œä¸”å®ƒä¸æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Œå°±æ¨™è¨˜ç‚ºéŒ¯
           btn.classList.add('wrong');
        }
        btn.disabled = true;
      });

      if (selected === correct) {
        playCorrectSound();
        createFirework(window.innerWidth * 0.5, window.innerHeight * 0.3);
        streak++;
        const points = streak * 5;
        score += points;
        correctCount++;
        wrongWords = wrongWords.filter(w => !(w.word === wordObj.word && w.meaning === wordObj.meaning));
        document.getElementById('score').textContent = score;
        document.getElementById('result').innerHTML = 
          `<span class="zh">âœ… ç­”å°ï¼+${points} åˆ†</span><br/>` +
          `<span class="en">âœ… Correct! +${points} pts</span>`;
        setTimeout(() => {
          if (timeLeft > 0) nextQuestion();
        }, 1200);
      } else {
        playWrongSound();
        const exists = wrongWords.some(w => w.word === wordObj.word && w.meaning === wordObj.meaning);
        if (!exists) {
          wrongWords.push({ ...wordObj, correctMeaning: correct });
        }
        wrongCount++;
        streak = 0;
        document.getElementById('result').innerHTML = 
          `<span class="zh">âŒ ç­”éŒ¯ï¼æ­£ç¢ºç­”æ¡ˆï¼š${correct}</span><br/>` +
          `<span class="en">âŒ Wrong! Correct: ${correct}</span>`;
        setTimeout(() => {
          if (timeLeft > 0) nextQuestion();
        }, 1500);
      }
    }

    function timeUp(correct, wordObj) {
      playExplosionSound();
      document.getElementById('result').innerHTML = 
        `<div class="explosion">ğŸ’¥</div>` +
        `<span class="zh">æ™‚é–“åˆ°ï¼æ­£ç¢ºç­”æ¡ˆï¼š${correct}</span><br/>` +
        `<span class="en">Time's up! Correct: ${correct}</span>`;
      const exists = wrongWords.some(w => w.word === wordObj.word && w.meaning === wordObj.meaning);
      if (!exists) {
        wrongWords.push({ ...wordObj, correctMeaning: correct });
      }
      wrongCount++;
      streak = 0;
      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach(btn => {
        if (btn.innerText.includes(correct)) {
          btn.classList.add('correct');
        }
        btn.disabled = true;
      });
      setTimeout(() => {
        if (timeLeft > 0) nextQuestion();
      }, 1500);
    }

    function nextQuestion() {
      document.getElementById('result').textContent = '';
      document.querySelectorAll('.option-btn').forEach(btn => btn.remove());
      if (timeLeft > 0) showQuestion();
    }

    function initAndStart(duration) {
      initAudio();
      startGame(duration);
    }

    function startGame(duration) {
      totalGameTime = duration;
      timeLeft = duration;
      score = 0;
      streak = 0;
      correctCount = 0;
      wrongCount = 0;

      originalFilteredWords = [...filteredWords];
      remainingWords = [...filteredWords];
      wrongWords = [];

      document.getElementById('score').textContent = '0';
      document.getElementById('time-left').textContent = timeLeft;

      document.getElementById('select-screen').classList.remove('active');
      document.getElementById('start-screen').classList.remove('active');
      document.getElementById('game-screen').classList.add('active');
      document.getElementById('end-screen').classList.remove('active');

      clearInterval(gameTimer);
      gameTimer = setInterval(() => {
        timeLeft--;
        document.getElementById('time-left').textContent = timeLeft;
        if (timeLeft <= 0) {
          endGame();
        }
      }, 1000);

      showQuestion();
    }

    function endGame() {
      clearInterval(gameTimer);
      clearInterval(progressInterval);

      const totalAnswered = correctCount + wrongCount;
      const accuracy = totalAnswered > 0 ? Math.round((correctCount / totalAnswered) * 100) : 0;

      document.getElementById('final-score').textContent = score;
      document.getElementById('correct-count').textContent = correctCount;
      document.getElementById('wrong-count').textContent = wrongCount;
      document.getElementById('accuracy').textContent = accuracy;

      const wrongListEl = document.getElementById('wrong-words-list');
      const sectionEl = document.getElementById('wrong-words-section');
      if (wrongWords.length > 0) {
        sectionEl.style.display = 'block';
        wrongListEl.innerHTML = wrongWords.map(w => 
          `<div><strong>${w.word}</strong> (${w.pos}) ã€${w.source}ã€‘ï¼š${w.correctMeaning}</div>`
        ).join('');
      } else {
        sectionEl.style.display = 'none';
      }

      document.getElementById('game-screen').classList.remove('active');
      document.getElementById('end-screen').classList.add('active');
    }

    function restartGame() {
      document.getElementById('end-screen').classList.remove('active');
      document.getElementById('select-screen').classList.add('active');
      clearInterval(gameTimer);
      clearInterval(progressInterval);
    }

    async function loadAndStart() {
      selectedSemester = document.querySelector('input[name="semester"]:checked').value;
      selectedUnits = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      
      if (selectedUnits.length === 0) {
        alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å–®å…ƒï¼\nPlease select at least one unit.');
        return;
      }

      if (wordList.length === 0) {
        await loadCSV();
      }

      if (filterWords()) {
        document.getElementById('select-screen').classList.remove('active');
        document.getElementById('start-screen').classList.add('active');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadCSV();
    });
  </script>
</body>
</html>
