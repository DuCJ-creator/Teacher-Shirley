<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley's GSAT Vocab Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tsparticles-slim@2.12.0/tsparticles.slim.bundle.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* New brighter, deeper gradient background */
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0891b2 100%);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Particle container fixed behind everything */
        #tsparticles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; /* Behind the main app card */
            pointer-events: none; /* Let clicks pass through except for hover interaction */
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Lighter, cleaner Glassmorphism Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.12); /* More transparent and lighter */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            z-index: 10; /* Ensure it sits on top of particles */
        }

        /* New accent color gradient for buttons/bars */
        .accent-gradient {
            background: linear-gradient(90deg, #22d3ee, #3b82f6); /* Cyan to Blue */
        }
        
        .accent-text {
            background: linear-gradient(90deg, #67e8f9, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .option-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .option-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 15px rgba(34, 211, 238, 0.15); /* Cyan shadow hover */
        }

        .option-btn.selected {
            background: linear-gradient(90deg, #22d3ee, #3b82f6); /* New accent */
            border-color: transparent;
            font-weight: 600;
            color: #0f172a; /* Dark text on bright button for contrast */
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.4);
        }
        
        /* Ensure the A/B/C/D circle contrasts well when selected */
        .option-btn.selected .option-letter {
            border-color: rgba(0,0,0,0.3);
            color: #0f172a;
        }

        /* Custom Scrollbar for feedback list */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        .timer-bar { transition: width 1s linear; }
        .fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* --- Print Styles (Optimized for Result List) --- */
        @media print {
            body {
                background: white !important;
                color: black !important;
                animation: none !important;
                height: auto !important;
                overflow: visible !important;
            }

            /* Hide decorative and interactive elements */
            #tsparticles, 
            .no-print, 
            button {
                display: none !important;
            }

            /* Reset container for print */
            #app-container {
                position: static !important;
                transform: none !important;
                width: 100% !important;
                max-width: 100% !important;
                background: white !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
                min-height: auto !important;
            }

            /* Result header adjustments */
            #results-screen .text-center {
                margin-bottom: 20px !important;
                color: black !important;
                border-bottom: 2px solid #eee;
                padding-bottom: 10px;
            }
            #results-screen h2, 
            #score-display, 
            .text-blue-200,
            .text-white {
                color: black !important;
                text-shadow: none !important;
            }

            /* Expand the feedback list */
            #feedback-list {
                max-height: none !important;
                overflow: visible !important;
                padding-right: 0 !important;
                display: block !important;
            }

            /* Style individual question items for print */
            #feedback-list > div {
                break-inside: avoid; /* Prevent splitting a question across pages */
                background: white !important;
                border: 1px solid #ccc !important;
                color: black !important;
                margin-bottom: 15px !important;
                box-shadow: none !important;
                padding: 10px !important;
            }

            /* Text colors force black */
            #feedback-list p, 
            #feedback-list span,
            #feedback-list div {
                color: black !important;
            }

            /* Highlighting logic for print */
            .bg-emerald-500 {
                border: 1px solid #000;
                color: #000 !important;
                background: transparent !important;
                font-weight: bold;
                box-shadow: none !important;
            }
            .bg-rose-500 {
                border: 1px solid #000;
                color: #000 !important;
                background: transparent !important;
                font-weight: bold;
                text-decoration: line-through;
                box-shadow: none !important;
            }
            
            /* Hide audio buttons in print */
            #feedback-list button {
                display: none !important;
            }
            
            /* Highlight the answer word clearly */
            .text-emerald-300 {
                color: black !important;
                text-decoration: underline;
                font-weight: bold;
                border: none !important;
            }
        }
    </style>
</head>
<body class="flex items-center justify-center p-4 relative">

    <div id="tsparticles"></div>

    <div id="app-container" class="w-full max-w-3xl glass-card rounded-3xl p-8 md:p-10 relative min-h-[550px] flex flex-col justify-center border-t-white/40">
        
        <div id="loading-screen" class="text-center no-print">
            <div class="animate-spin rounded-full h-14 w-14 border-b-4 border-cyan-400 mx-auto mb-6"></div>
            <p class="text-xl tracking-widest text-cyan-200 font-light uppercase">Initializing System...</p>
        </div>

        <div id="start-screen" class="text-center hidden fade-in no-print">
            <div class="mb-6 inline-block p-3 rounded-full bg-white/10 backdrop-blur-md shadow-inner-white">
                <i class="fas fa-brain text-4xl accent-text"></i>
            </div>
            <h1 class="text-5xl md:text-6xl font-extrabold mb-4 tracking-tight text-white drop-shadow-lg">
                Shirley's <span class="accent-text">GSAT Vocab Practice</span>
            </h1>
            <p class="text-blue-100 mb-10 text-lg font-light tracking-wide">Advanced Interactive Practice Engine (with acknowledgement of CEEC)</p>
            
            <div class="flex justify-center gap-4 mb-10 text-sm font-medium text-blue-200/80">
                <div class="flex items-center bg-blue-950/30 px-4 py-2 rounded-full border border-blue-400/20">
                    <i class="fas fa-bolt text-cyan-400 mr-2"></i> 10 Questions
                </div>
                <div class="flex items-center bg-blue-950/30 px-4 py-2 rounded-full border border-blue-400/20">
                    <i class="fas fa-stopwatch text-blue-400 mr-2"></i> 30s Timer
                </div>
            </div>

            <button onclick="startQuiz()" class="group relative px-10 py-4 rounded-full overflow-hidden transition-all hover:scale-105 active:scale-95 shadow-xl shadow-cyan-500/30 bg-white/10 backdrop-blur-lg border border-white/30">
                 <div class="absolute inset-0 w-full h-full accent-gradient opacity-80 group-hover:opacity-100 transition-opacity"></div>
                 <span class="relative text-white font-bold text-xl tracking-wider flex items-center justify-center">
                    START MODULE <i class="fas fa-chevron-right ml-3 text-sm group-hover:translate-x-1 transition-transform"></i>
                 </span>
            </button>
        </div>

        <div id="quiz-screen" class="hidden fade-in w-full no-print">
            <div class="flex justify-between items-end mb-4">
                <div>
                     <span class="text-xs font-mono text-blue-300 tracking-widest uppercase mb-1 block opacity-70">Progress</span>
                     <span class="text-2xl font-bold text-white">Q<span id="q-current">1</span><span class="text-lg text-blue-300/70 font-medium">/10</span></span>
                </div>
                 <div class="text-right">
                    <span class="text-xs font-mono text-blue-300 tracking-widest uppercase mb-1 block opacity-70">Time Left</span>
                    <span id="timer-text" class="font-mono text-3xl font-bold accent-text drop-shadow">30s</span>
                 </div>
            </div>
            
            <div class="w-full h-2 bg-blue-950/50 rounded-full mb-8 overflow-hidden p-[2px] border border-white/10">
                <div id="timer-bar" class="h-full rounded-full accent-gradient w-full timer-bar shadow-[0_0_10px_rgba(34,211,238,0.5)]"></div>
            </div>

            <div class="mb-8 relative z-10">
                <span id="q-code" class="inline-block px-3 py-1 bg-blue-500/20 border border-blue-400/30 rounded-lg text-xs text-blue-200 mb-4 tracking-wider font-mono">CODE: LOADING</span>
                <h2 id="q-text" class="text-2xl md:text-3xl font-medium leading-relaxed text-white drop-shadow-md">Loading question...</h2>
            </div>

            <div id="options-container" class="grid grid-cols-1 gap-4 relative z-10">
                </div>
        </div>

        <div id="results-screen" class="hidden fade-in w-full">
             <div class="text-center mb-8">
                <div class="inline-block p-3 rounded-full bg-white/10 backdrop-blur-md shadow-inner-white mb-4 no-print">
                    <i class="fas fa-clipboard-check text-4xl accent-text"></i>
                </div>
                <h2 class="text-3xl font-bold mb-2 text-white">Session Analysis</h2>
                
                <div class="flex items-center justify-center gap-4 mt-6">
                     <div class="text-6xl font-extrabold accent-text drop-shadow-xl">
                        <span id="score-display">0</span><span class="text-4xl align-super">%</span>
                    </div>
                    <div class="text-left text-sm text-blue-200 uppercase tracking-wider leading-tight opacity-80">
                        Correct<br>Rate
                    </div>
                </div>
            </div>

            <div id="feedback-list" class="space-y-4 mb-8 max-h-[350px] overflow-y-auto pr-3 custom-scrollbar">
                </div>

            <div class="flex flex-col md:flex-row gap-4 justify-center mt-8 no-print">
                <button onclick="startQuiz(true)" class="px-8 py-4 rounded-2xl accent-gradient text-blue-950 font-extrabold shadow-lg shadow-cyan-500/25 transition-all hover:-translate-y-1 hover:shadow-cyan-500/40 flex items-center justify-center">
                    <i class="fas fa-redo-alt mr-3"></i> Next Challenge
                </button>
                
                <button onclick="window.print()" class="px-8 py-4 rounded-2xl bg-blue-500/20 hover:bg-blue-500/30 text-blue-200 font-bold transition-all border border-blue-400/30 flex items-center justify-center backdrop-blur-md">
                    <i class="fas fa-print mr-3"></i> Print Results
                </button>

                <button onclick="exitApp()" class="px-8 py-4 rounded-2xl bg-white/10 hover:bg-white/15 text-white font-bold transition-colors border border-white/20 flex items-center justify-center backdrop-blur-md">
                    <i class="fas fa-power-off mr-3 text-red-400"></i> Exit
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- Particle System Initialization ---
        async function initParticles() {
            await tsParticles.load("tsparticles", {
                particles: {
                    number: { value: 60, density: { enable: true, value_area: 800 } },
                    color: { value: ["#67e8f9", "#ffffff", "#3b82f6"] }, // Cyan, White, Blue dots
                    shape: { type: "circle" },
                    opacity: { value: 0.4, random: true },
                    size: { value: 2, random: true },
                    // Connecting lines
                    links: {
                        enable: true,
                        distance: 150,
                        color: "#ffffff",
                        opacity: 0.15,
                        width: 1
                    },
                    // Movement style: slow floating
                    move: {
                        enable: true,
                        speed: 0.8, 
                        direction: "none",
                        random: true,
                        straight: false,
                        out_mode: "out",
                        bounce: false,
                    }
                },
                // Interactive effects on mouse hover
                interactivity: {
                    detect_on: "canvas",
                    events: {
                        onhover: { enable: true, mode: "grab" }, // grab connections nearby
                        onclick: { enable: true, mode: "push" }, // push more particles on click
                        resize: true
                    },
                    modes: {
                        grab: { distance: 180, line_linked: { opacity: 0.3 } },
                        push: { particles_nb: 3 }
                    }
                },
                retina_detect: true,
                background: { color: "transparent" } // Transparent to let CSS gradient show
            });
        }


        // --- Configuration & State (Same as before) ---
        const CSV_URL = 'https://ducj-creator.github.io/GSAT%20vocab%20fixed%20option%20quiz.csv';
        const QUESTION_LIMIT = 10;
        const TIME_LIMIT = 30;

        let allQuestions = [];
        let wrongHistory = new Set();
        let seenHistory = new Set();
        
        let currentSession = {
            questions: [],
            userAnswers: [],
            currentIndex: 0,
            timer: null,
            timeLeft: TIME_LIMIT
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initParticles(); // Start particles
            loadData();      // Start loading data
        });

        function loadData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    allQuestions = results.data.filter(row => row.length >= 7).map((row, index) => ({
                        originalIndex: index,
                        code: row[0],
                        text: row[1],
                        options: [row[2], row[3], row[4], row[5]],
                        correctAnswer: row[6].trim()
                    }));
                    
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('start-screen').classList.remove('hidden');
                },
                error: function(err) {
                    alert("Failed to connect to data source.");
                    console.error(err);
                }
            });
        }

        // --- Quiz Logic (Same structure, updated UI classes) ---

        function startQuiz(isNextChallenge = false) {
            let pool = [];
            if (isNextChallenge) {
                const priorityIndices = allQuestions.filter(q => 
                    wrongHistory.has(q.originalIndex) || !seenHistory.has(q.originalIndex)
                );
                shuffleArray(priorityIndices);
                pool = [...priorityIndices];
                if (pool.length < QUESTION_LIMIT) {
                    const mastered = allQuestions.filter(q => 
                        !wrongHistory.has(q.originalIndex) && seenHistory.has(q.originalIndex)
                    );
                    shuffleArray(mastered);
                    pool = pool.concat(mastered);
                }
            } else {
                pool = [...allQuestions];
                shuffleArray(pool);
            }

            currentSession.questions = pool.slice(0, QUESTION_LIMIT);
            currentSession.userAnswers = new Array(currentSession.questions.length).fill(null);
            currentSession.currentIndex = 0;
            currentSession.questions.forEach(q => seenHistory.add(q.originalIndex));

            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            loadQuestion(0);
        }

        function loadQuestion(index) {
            clearInterval(currentSession.timer);
            currentSession.currentIndex = index;
            currentSession.timeLeft = TIME_LIMIT;
            
            const qData = currentSession.questions[index];
            
            document.getElementById('q-current').innerText = index + 1;
            document.getElementById('q-code').innerText = `CODE: ${qData.code}`;
            document.getElementById('q-text').innerText = qData.text;
            
            document.getElementById('timer-text').innerText = `${TIME_LIMIT}s`;
            const timerBar = document.getElementById('timer-bar');
            timerBar.style.transition = 'none';
            timerBar.style.width = '100%';
            
            const optsContainer = document.getElementById('options-container');
            optsContainer.innerHTML = '';

            qData.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                // Updated classes for new theme
                btn.className = `option-btn w-full text-left p-5 rounded-2xl text-gray-100 text-lg font-medium flex items-center group`;
                btn.innerHTML = `<span class="option-letter inline-flex items-center justify-center w-8 h-8 rounded-full border-2 border-white/30 text-sm font-bold mr-4 text-blue-200 group-hover:border-cyan-400 group-hover:text-cyan-400 transition-colors">${String.fromCharCode(65+idx)}</span> ${opt}`;
                btn.onclick = () => selectOption(idx, btn);
                optsContainer.appendChild(btn);
            });

            setTimeout(() => {
                timerBar.style.transition = `width ${TIME_LIMIT}s linear`;
                timerBar.style.width = '0%';
            }, 50);

            currentSession.timer = setInterval(() => {
                currentSession.timeLeft--;
                const timerText = document.getElementById('timer-text');
                timerText.innerText = `${currentSession.timeLeft}s`;
                
                // Optional: make timer turn red near end
                if(currentSession.timeLeft <= 5) {
                    timerText.classList.remove('accent-text');
                    timerText.classList.add('text-red-400');
                } else {
                    timerText.classList.add('accent-text');
                    timerText.classList.remove('text-red-400');
                }
                
                if (currentSession.timeLeft <= 0) {
                    clearInterval(currentSession.timer);
                    handleNext();
                }
            }, 1000);
        }

        function selectOption(optIndex, btnElement) {
            const allBtns = document.querySelectorAll('.option-btn');
            allBtns.forEach(b => b.classList.remove('selected'));
            btnElement.classList.add('selected');
            
            currentSession.userAnswers[currentSession.currentIndex] = optIndex;
            
            clearInterval(currentSession.timer);
            setTimeout(handleNext, 300); // Slightly faster transition
        }

        function handleNext() {
            if (currentSession.currentIndex < QUESTION_LIMIT - 1) {
                loadQuestion(currentSession.currentIndex + 1);
            } else {
                finishQuiz();
            }
        }

        // --- Results & Feedback (UI updated for new theme) ---

        function finishQuiz() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('results-screen').classList.remove('hidden');

            const listContainer = document.getElementById('feedback-list');
            listContainer.innerHTML = '';
            
            let correctCount = 0;

            currentSession.questions.forEach((q, idx) => {
                const userChoiceIndex = currentSession.userAnswers[idx];
                const userChoiceText = userChoiceIndex !== null ? q.options[userChoiceIndex] : "Time Out / No Answer";
                const isCorrect = userChoiceIndex !== null && q.options[userChoiceIndex] === q.correctAnswer;
                
                if (isCorrect) {
                    correctCount++;
                    wrongHistory.delete(q.originalIndex);
                } else {
                    wrongHistory.add(q.originalIndex);
                }

                // Brighter highlight colors for the new dark/blue theme
                const completedSentence = q.text.replace(/_{2,}/g, `<span class="text-emerald-300 font-bold border-b-2 border-emerald-300/50 px-1">${q.correctAnswer}</span>`);
                const plainSentence = q.text.replace(/_{2,}/g, q.correctAnswer);

                const item = document.createElement('div');
                // Updated feedback card styling
                item.className = `p-5 rounded-2xl border backdrop-blur-sm ${isCorrect ? 'border-emerald-400/30 bg-emerald-900/20' : 'border-rose-400/30 bg-rose-900/20'} transition-all hover:bg-white/5`;
                
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-xs font-mono text-blue-200/60 bg-blue-950/50 px-2 py-1 rounded">${q.code}</span>
                        <span class="text-xs font-extrabold px-3 py-1 rounded-full tracking-wider ${isCorrect ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20' : 'bg-rose-500 text-white shadow-lg shadow-rose-500/20'}">
                            ${isCorrect ? '<i class="fas fa-check mr-1"></i> CORRECT' : '<i class="fas fa-times mr-1"></i> WRONG'}
                        </span>
                    </div>
                    <p class="text-lg mb-4 leading-relaxed text-white/90 font-medium">${completedSentence}</p>
                    ${!isCorrect ? `<div class="text-sm text-rose-300 mb-3 bg-rose-950/30 p-2 rounded-lg"><i class="fas fa-arrow-right mr-2"></i>You chose: <span class="font-bold">${userChoiceText}</span></div>` : ''}
                    <button onclick="speakText(this, '${plainSentence.replace(/'/g, "\\'")}')" class="text-sm px-4 py-2 rounded-xl bg-blue-500/10 hover:bg-blue-500/20 text-blue-300 transition-colors flex items-center gap-2 border border-blue-400/20 hover:border-blue-400/50">
                        <i class="fas fa-volume-high"></i> Play Audio
                    </button>
                `;
                listContainer.appendChild(item);
            });

            const score = Math.round((correctCount / QUESTION_LIMIT) * 100);
            const scoreDisplay = document.getElementById('score-display');
            animateValue(scoreDisplay, 0, score, 1200);
        }

        // --- Utilities (Same as before) ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function speakText(btn, text) {
            const originalIcon = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-wave-square animate-pulse text-cyan-400"></i> Speaking...`;
            btn.classList.add('border-cyan-400/50', 'text-cyan-300');

            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                
                utterance.onend = () => {
                    btn.innerHTML = originalIcon;
                    btn.classList.remove('border-cyan-400/50', 'text-cyan-300');
                };
                
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            } else {
                alert("TTS not supported.");
                btn.innerHTML = originalIcon;
            }
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        function exitApp() {
            location.reload();
        }
    </script>
</body>
</html>
