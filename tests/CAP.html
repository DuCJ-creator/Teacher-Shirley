<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Shirley's CAP Practice</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tsparticles-slim@2.12.0/tsparticles.slim.bundle.min.js"></script>

  <style>
    /* --- Fresh Tech 配色方案 --- */
    :root {
      --bg-color: #F0F4F8;
      --text-main: #334155;
      --primary-color: #00B4D8;
      --primary-dark: #0096C7;
      --accent-pop: #FCA311;
      --card-bg: #ffffff;
      --success: #10b981;
      --error: #ef4444;
    }

    body {
      font-family: 'Nunito', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      overscroll-behavior: none;
    }

    h1, h2, h3 { font-family: 'Quicksand', sans-serif; }

    #tsparticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; }

    .clean-card {
      background: var(--card-bg);
      border-radius: 24px;
      box-shadow: 0 10px 40px rgba(0, 180, 216, 0.1);
      z-index: 10;
      border: 1px solid rgba(255,255,255,0.8);
      width: 92%; max-width: 48rem; margin: 20px auto;
    }

    .highlight-text { color: var(--primary-color); font-weight: 800; }

    /* 按鈕樣式 */
    .option-btn {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      color: var(--text-main);
      border-radius: 12px;
      font-weight: 600;
      min-height: 3.5rem;
      font-size: 1rem;
    }

    @media (hover: hover) {
      .option-btn:hover {
        background: #e0f2fe; border-color: var(--primary-color);
        transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 180, 216, 0.15);
      }
    }

    .option-btn.selected { border-color: var(--primary-color); background: #e0f2fe; }
    .option-btn.correct { background-color: #d1fae5 !important; border-color: var(--success) !important; color: #065f46 !important; }
    .option-btn.incorrect { background-color: #fee2e2 !important; border-color: var(--error) !important; color: #991b1b !important; }

    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    
    .timer-line { transition: width 1s linear; }
    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .loader {
      border: 3px solid #e2e8f0; border-left-color: var(--primary-color);
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    .btn-primary {
      background-color: var(--primary-color); color: white;
      border-radius: 50px; box-shadow: 0 4px 15px rgba(0, 180, 216, 0.3); border: none;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-primary:active { transform: scale(0.95); }
    
    .tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
    .tag-blue { background: #e0f2fe; color: #0284c7; }
    .tag-orange { background: #ffedd5; color: #c2410c; }
  </style>
</head>

<body class="flex items-center justify-center p-0 md:p-4 min-h-[100vh] w-full">
  <div id="tsparticles"></div>

  <div id="app-container" class="clean-card p-6 md:p-12 relative flex flex-col justify-center min-h-[500px] md:min-h-[600px]">

    <div id="start-screen" class="text-center fade-in px-2 md:px-4">
      <div class="mb-6">
        <div class="inline-flex items-center justify-center w-14 h-14 md:w-16 md:h-16 rounded-full bg-blue-50 text-[#00B4D8] mb-2">
            <i class="fas fa-rocket text-2xl md:text-3xl"></i>
        </div>
      </div>
      
      <h1 class="text-3xl md:text-5xl font-bold mb-3 tracking-tight text-gray-800">
        Shirley's <span class="highlight-text">CAP Practice</span>
      </h1>
      <p class="text-gray-500 mb-6 font-medium text-sm md:text-base">Ready to challenge yourself?</p>
      
      <div class="flex justify-center gap-3 mb-8">
          <span class="tag tag-blue"><i class="fas fa-list-ul mr-1"></i>10 Qs</span>
          <span class="tag tag-orange"><i class="fas fa-stopwatch mr-1"></i>30s</span>
      </div>

      <p class="text-[10px] text-gray-400 mb-8 font-mono bg-gray-50 inline-block px-3 py-1 rounded-lg">
        SOURCE: CAP RCPET
      </p>

      <button onclick="loadData()" class="btn-primary w-full md:w-auto px-10 py-3 md:py-4 text-sm md:text-base font-bold tracking-wider uppercase">
        Start Quiz
      </button>
    </div>

    <div id="loading-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center z-20 bg-white/95 backdrop-blur-sm rounded-[24px]">
      <div class="loader mb-4"></div>
      <p class="text-base font-bold text-gray-700">Loading System...</p>
      <p id="loading-sub" class="text-sm text-gray-400 mt-2">Connecting...</p>
    </div>

    <div id="quiz-screen" class="hidden fade-in w-full">
      <div class="flex justify-between items-center mb-4 md:mb-6">
        <div>
          <span class="text-[10px] md:text-xs font-bold text-gray-400 uppercase tracking-wider block mb-1">Question</span>
          <span class="text-xl md:text-2xl font-bold text-gray-800">
            <span id="q-current" class="text-[#00B4D8]">1</span><span class="text-gray-300 mx-1">/</span>10
          </span>
        </div>
        <div class="text-right">
          <span class="text-[10px] md:text-xs font-bold text-gray-400 uppercase tracking-wider block mb-1">Time</span>
          <div class="flex items-center justify-end text-[#FCA311] font-bold text-lg md:text-xl font-mono">
            <i class="far fa-clock mr-2"></i> <span id="timer-text">30</span>
          </div>
        </div>
      </div>

      <div class="w-full h-1.5 md:h-2 bg-gray-100 rounded-full mb-6 md:mb-8 overflow-hidden">
        <div id="timer-bar" class="h-full bg-[#FCA311] w-full timer-line rounded-full"></div>
      </div>

      <div class="mb-6 md:mb-8">
        <span id="q-code" class="inline-block mb-2 md:mb-3 text-[10px] text-gray-400 font-bold bg-gray-100 px-2 py-1 rounded">CODE: --</span>
        <h2 id="q-text" class="text-lg md:text-2xl font-bold leading-relaxed text-gray-700">Initializing...</h2>
      </div>

      <div id="options-container" class="grid grid-cols-1 gap-2 md:gap-3">
      </div>
    </div>

    <div id="results-screen" class="hidden fade-in w-full">
        <div class="text-center mb-6">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 text-[#00B4D8] mb-4">
                <i class="fas fa-trophy text-3xl"></i>
            </div>
            <h2 class="text-2xl md:text-3xl font-bold mb-1 text-gray-800">Completed!</h2>
            
            <div class="my-4">
                <span id="score-display" class="text-5xl md:text-6xl font-extrabold text-[#00B4D8]">--/10</span>
            </div>
            <p id="score-message" class="text-xs md:text-sm font-bold text-gray-500 uppercase tracking-wide bg-gray-100 py-1.5 px-3 rounded-full inline-block"></p>
            
            <div class="mt-6">
                <button onclick="startQuiz()" class="btn-primary w-full md:w-auto px-8 py-3 text-sm font-bold uppercase tracking-wide">
                   Try Again
                </button>
            </div>
        </div>

        <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 pb-2 border-b border-gray-100">
            Review (Detailed Analysis)
        </div>
        
        <div id="feedback-list" class="custom-scrollbar max-h-[350px] overflow-y-auto pr-2 space-y-3">
        </div>
    </div>
    
  </div>

  <script>
    // --- 粒子設定 ---
    async function initParticles() {
      const isMobile = window.innerWidth < 768;
      try {
        await tsParticles.load("tsparticles", {
          particles: {
            number: { value: isMobile ? 30 : 60, density: { enable: true, value_area: 800 } },
            color: { value: "#00B4D8" },
            shape: { type: "circle" },
            opacity: { value: 0.6 },
            size: { value: 4, random: true },
            line_linked: { enable: true, distance: 150, color: "#90e0ef", opacity: 0.4, width: 1 },
            move: { enable: true, speed: 2.5, direction: "none", out_mode: "out" }
          },
          interactivity: {
            detect_on: "canvas",
            events: {
              onhover: { enable: !isMobile, mode: "repulse" },
              onclick: { enable: true, mode: "push" },
              resize: true
            },
            modes: { repulse: { distance: 100, duration: 0.4 } }
          },
          retina_detect: true,
          background: { color: "transparent" }
        });
      } catch(e){}
    }
    document.addEventListener('DOMContentLoaded', initParticles);

    // --- 核心邏輯 ---
    const CSV_URL = 'https://ducj-creator.github.io/Teacher-Shirley/tests/CAP%20PP.csv';
    const QUESTION_LIMIT = 10;
    const TIME_LIMIT = 30; 
    
    let allQuestions = [];
    let currentSession = {
      questions: [],
      userAnswers: [],
      currentIndex: 0,
      timer: null,
      timeLeft: TIME_LIMIT
    };

    async function loadData() {
        const startScreen = document.getElementById('start-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const loadingSub = document.getElementById('loading-sub');

        startScreen.classList.add('hidden');
        loadingScreen.classList.remove('hidden');

        const url = CSV_URL + "?v=" + Date.now(); 

        try {
            loadingSub.textContent = "Fetching data...";
            const response = await fetch(url, { cache: "no-store" });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            
            loadingSub.textContent = "Parsing CSV...";
            const csvText = await response.text();
            const results = Papa.parse(csvText, { header: true, skipEmptyLines: true });

            allQuestions = results.data.map((row, index) => {
                const getVal = (key) => {
                    const foundKey = Object.keys(row).find(k => k.trim() === key);
                    return foundKey ? row[foundKey] : "";
                };

                const qText = getVal('Question');
                const qAns = getVal('Correct Answer');

                if (!qText || !qAns) return null;

                return {
                    originalIndex: index,
                    code: (getVal('Year') && getVal('No.')) ? `${getVal('Year')}-${getVal('No.')}` : `Q${index+1}`,
                    text: qText,
                    options: [getVal('Option A'), getVal('Option B'), getVal('Option C'), getVal('Option D')],
                    correctAnswer: qAns.trim().toUpperCase()
                };
            }).filter(q => q !== null);

            if (allQuestions.length === 0) throw new Error("Parsed data is empty.");

            loadingScreen.classList.add('hidden');
            startQuiz();

        } catch (err) {
            console.error("Load failed:", err);
            loadingScreen.innerHTML = `
                <div class="text-center p-4">
                    <p class="text-lg font-bold text-gray-700">Data Load Error</p>
                    <p class="text-sm text-gray-500 mt-2">${err.message}</p>
                    <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-gray-200 rounded">Reload</button>
                </div>
            `;
        }
    }

    function startQuiz() {
      let pool = [...allQuestions];
      shuffleArray(pool);
      const limit = Math.min(pool.length, QUESTION_LIMIT);
      currentSession.questions = pool.slice(0, limit);
      currentSession.userAnswers = new Array(currentSession.questions.length).fill(null);
      currentSession.currentIndex = 0;

      document.getElementById('results-screen').classList.add('hidden');
      document.getElementById('quiz-screen').classList.remove('hidden');
      loadQuestion(0);
    }

    function loadQuestion(index) {
      clearInterval(currentSession.timer);
      currentSession.currentIndex = index;
      currentSession.timeLeft = TIME_LIMIT;

      const qData = currentSession.questions[index];
      
      document.getElementById('q-current').innerText = index + 1;
      document.getElementById('q-code').innerText = qData.code;
      document.getElementById('q-text').innerText = qData.text;

      const timerBar = document.getElementById('timer-bar');
      document.getElementById('timer-text').innerText = `${TIME_LIMIT}`;
      timerBar.style.transition = 'none';
      timerBar.style.width = '100%';
      void timerBar.offsetWidth; 
      
      setTimeout(() => {
          timerBar.style.transition = `width ${TIME_LIMIT}s linear`;
          timerBar.style.width = '0%';
      }, 50);
      
      const optsContainer = document.getElementById('options-container');
      optsContainer.innerHTML = '';
      const letters = ['A', 'B', 'C', 'D'];
      
      qData.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = `option-btn w-full text-left p-3 md:p-4 flex items-center group relative overflow-hidden touch-manipulation`;
        const safeOpt = opt || ""; 
        
        btn.innerHTML = `
          <span class="font-bold text-xs md:text-sm text-[#00B4D8] bg-blue-50 w-6 h-6 md:w-8 md:h-8 flex shrink-0 items-center justify-center rounded-full mr-3 md:mr-4 group-hover:bg-[#00B4D8] group-hover:text-white transition-colors">${letters[idx]}</span>
          <span class="flex-1 text-sm md:text-base font-medium text-gray-600 group-hover:text-gray-800 leading-snug">${safeOpt}</span>
        `;
        btn.onclick = () => handleAnswer(idx);
        optsContainer.appendChild(btn);
      });
      
      startTimer();
    }
    
    function startTimer() {
      const timerText = document.getElementById('timer-text');
      currentSession.timer = setInterval(() => {
        currentSession.timeLeft--;
        timerText.innerText = `${currentSession.timeLeft}`;
        if (currentSession.timeLeft <= 0) {
          clearInterval(currentSession.timer);
          handleAnswer(null); 
        }
      }, 1000);
    }
    
    function handleAnswer(choiceIdx) {
      clearInterval(currentSession.timer);
      const qIndex = currentSession.currentIndex;
      const qData = currentSession.questions[qIndex];
      const letters = ['A', 'B', 'C', 'D'];
      const userLetter = choiceIdx !== null ? letters[choiceIdx] : 'TIME OUT';
      
      currentSession.userAnswers[qIndex] = userLetter;

      const buttons = document.getElementById('options-container').children;
      Array.from(buttons).forEach((btn, idx) => {
        btn.onclick = null;
        const letter = letters[idx];
        if (letter === qData.correctAnswer) btn.classList.add('correct');
        else if (idx === choiceIdx) btn.classList.add('incorrect');
      });

      setTimeout(() => {
          if (qIndex + 1 < currentSession.questions.length) {
              loadQuestion(qIndex + 1);
          } else {
              showResults();
          }
      }, 1200);
    }

    // --- 關鍵修改：Results 顯示所有選項 ---
    function showResults() {
      document.getElementById('quiz-screen').classList.add('hidden');
      document.getElementById('results-screen').classList.remove('hidden');

      let correct = 0;
      const list = document.getElementById('feedback-list');
      list.innerHTML = '';

      currentSession.questions.forEach((q, i) => {
        const ans = currentSession.userAnswers[i]; // 使用者選的 A, B, C, D
        const isOk = ans === q.correctAnswer;
        if (isOk) correct++;

        const div = document.createElement('div');
        div.className = `p-4 mb-3 rounded-xl border-l-4 ${isOk ? 'border-emerald-400 bg-emerald-50' : 'border-rose-400 bg-rose-50'}`;
        
        // 題目文字，正確答案填空
        const highlightedText = q.text.replace(/_{2,}/g, `<span class="text-[#00B4D8] font-bold border-b-2 border-[#00B4D8] px-1">${q.correctAnswer}</span>`);

        // 生成選項列表 HTML
        const optionsHtml = q.options.map((opt, optIdx) => {
            const letter = ['A', 'B', 'C', 'D'][optIdx];
            const isCorrectOption = letter === q.correctAnswer;
            const isSelectedOption = letter === ans;

            // 預設樣式
            let itemClass = "bg-white/60 border-transparent text-gray-400"; 
            let icon = `<span class="w-5 h-5 flex items-center justify-center rounded-full bg-gray-100 text-xs mr-2">${letter}</span>`;

            // 樣式判斷邏輯
            if (isCorrectOption) {
                // 這是正確答案：綠色，打勾
                itemClass = "bg-emerald-100/80 border-emerald-200 text-emerald-800 font-bold shadow-sm";
                icon = `<span class="w-5 h-5 flex items-center justify-center rounded-full bg-emerald-600 text-white text-xs mr-2"><i class="fas fa-check"></i></span>`;
            } else if (isSelectedOption && !isOk) {
                // 這是使用者選錯的：紅色，打叉
                itemClass = "bg-rose-100/80 border-rose-200 text-rose-800 shadow-sm";
                icon = `<span class="w-5 h-5 flex items-center justify-center rounded-full bg-rose-500 text-white text-xs mr-2"><i class="fas fa-times"></i></span>`;
            }

            return `<div class="p-2 rounded border ${itemClass} text-xs md:text-sm flex items-center transition-colors">
                        ${icon} ${opt || '(No text)'}
                    </div>`;
        }).join('');

        div.innerHTML = `
          <div class="flex justify-between text-[10px] md:text-[11px] font-bold mb-2 text-gray-400">
            <span>${q.code}</span>
            <span class="${isOk?'text-emerald-600':'text-rose-600'} bg-white px-2 py-0.5 rounded shadow-sm border border-gray-100">${isOk ? 'CORRECT' : 'YOUR ANSWER: ' + ans}</span>
          </div>
          <p class="text-sm font-medium text-gray-700 leading-relaxed mb-3">${highlightedText}</p>
          
          <div class="grid grid-cols-1 gap-1.5 pl-2 border-l-2 border-gray-200/50">
            ${optionsHtml}
          </div>
        `;
        list.appendChild(div);
      });

      const totalQ = currentSession.questions.length;
      document.getElementById('score-display').innerText = `${correct} / ${totalQ}`;
      const msg = correct === totalQ ? 'Perfect!' : (correct >= Math.ceil(totalQ*0.6) ? 'Great Job!' : 'Lets Review.');
      document.getElementById('score-message').innerText = msg;
    }
    
   // ↓↓↓ 只要加入這段，把分數傳給月光寶盒 ↓↓↓
      if (window.opener) {
          window.opener.postMessage({ type: "LUNAR_MISSION_RESULT", correct: correct }, "*");
      }
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }
  </script>
</body>
</html>
