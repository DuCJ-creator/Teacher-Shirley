<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shirley's CAP Practice</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tsparticles-slim@2.12.0/tsparticles.slim.bundle.min.js"></script>

  <style>
    /* --- 初中生活力風格定義 (Fresh Tech / Energetic) --- */
    :root {
      --bg-color: #F0F4F8;         /* 淺灰藍背景 */
      --text-main: #334155;        /* 深藍灰文字 */
      --text-light: #64748b;       /* 淺灰文字 */
      --primary-color: #00B4D8;    /* 主色調：天藍 */
      --primary-dark: #0096C7;     /* 主色調深色 (Hover用) */
      --accent-pop: #FCA311;       /* 點綴色：活力橙 */
      --card-bg: #ffffff;          /* 卡片背景：純白 */
      --success: #10b981;          /* 正確綠 */
      --error: #ef4444;            /* 錯誤紅 */
    }

    body {
      font-family: 'Nunito', sans-serif; /* 使用圓潤親切的字體 */
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    h1, h2, h3 {
      font-family: 'Quicksand', sans-serif; /* 標題字體 */
    }

    #tsparticles {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
      pointer-events: none; /* 讓點擊穿透 */
    }

    /* 現代懸浮卡片 (Modern Clean Card) */
    .clean-card {
      background: var(--card-bg);
      border-radius: 24px; /* 更圓潤的邊角 */
      box-shadow: 0 10px 40px rgba(0, 180, 216, 0.1); /* 帶有藍色調的輕柔陰影 */
      z-index: 10;
      border: 1px solid rgba(255,255,255,0.5);
    }

    /* 重點文字效果 */
    .highlight-text {
      color: var(--primary-color);
      font-weight: 800;
    }

    /* 選項按鈕樣式 - 活潑 */
    .option-btn {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      color: var(--text-main);
      border-radius: 12px; /* 圓角按鈕 */
      font-weight: 600;
    }

    .option-btn:hover {
      background: #e0f2fe; /* 淺藍背景 */
      border-color: var(--primary-color);
      transform: translateY(-3px); /* 向上浮動效果 */
      box-shadow: 0 4px 12px rgba(0, 180, 216, 0.15);
    }

    /* 選中與對錯樣式 */
    .option-btn.selected {
      border-color: var(--primary-color);
      background: #e0f2fe;
    }
    
    .option-btn.correct {
      background-color: #d1fae5 !important; /* 淺綠背景 */
      border-color: var(--success) !important;
      color: #065f46 !important;
    }
    
    .option-btn.incorrect {
      background-color: #fee2e2 !important; /* 淺紅背景 */
      border-color: var(--error) !important;
      color: #991b1b !important;
    }

    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    .timer-line { transition: width 1s linear; }
    
    /* 淡入動畫 */
    .fade-in { animation: fadeIn 0.6s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Loading Spinner 修改為藍色 */
    .loader {
      border: 3px solid #e2e8f0;
      border-left-color: var(--primary-color);
      border-radius: 50%;
      width: 48px; height: 48px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* 主要按鈕樣式 */
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0, 180, 216, 0.3);
      border: none;
      transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
    }
    .btn-primary:hover {
      background-color: var(--primary-dark);
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0, 180, 216, 0.4);
    }

    /* 標籤樣式 */
    .tag {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .tag-blue { background: #e0f2fe; color: #0284c7; }
    .tag-orange { background: #ffedd5; color: #c2410c; }
  </style>
</head>

<body class="flex items-center justify-center p-4">
  <div id="tsparticles"></div>

  <div id="app-container" class="w-full max-w-3xl clean-card p-8 md:p-12 relative min-h-[600px] flex flex-col justify-center">

    <div id="start-screen" class="text-center fade-in px-4">
      <div class="mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 text-[#00B4D8] mb-4">
            <i class="fas fa-rocket text-3xl"></i>
        </div>
      </div>
      
      <h1 class="text-4xl md:text-5xl font-bold mb-3 tracking-tight text-gray-800">
        Shirley's <span class="highlight-text">CAP Practice</span>
      </h1>
      <p class="text-gray-500 mb-8 font-medium">Ready to challenge yourself?</p>
      
      <div class="flex justify-center gap-4 mb-10">
          <span class="tag tag-blue"><i class="fas fa-list-ul mr-2"></i>10 Questions</span>
          <span class="tag tag-orange"><i class="fas fa-stopwatch mr-2"></i>30s Limit</span>
      </div>

      <p class="text-[11px] text-gray-400 mb-10 font-mono bg-gray-50 inline-block px-3 py-1 rounded-lg">
        SOURCE: CAP RCPET DATABASE
      </p>

      <button onclick="initiateQuizLoad()" class="btn-primary px-10 py-4 text-base font-bold tracking-wider uppercase">
        Start Quiz <i class="fas fa-arrow-right ml-2"></i>
      </button>
    </div>

    <div id="loading-screen" class="hidden absolute inset-0 flex flex-col items-center justify-center z-20 bg-white/95 backdrop-blur-sm rounded-[24px]">
      <div class="loader mb-6"></div>
      <p class="text-lg font-bold text-gray-700">Loading Questions</p>
      <p id="loading-sub" class="text-sm text-gray-400 mt-1">Getting things ready...</p>
    </div>

    <div id="quiz-screen" class="hidden fade-in w-full">
      <div class="flex justify-between items-center mb-6">
        <div>
          <span class="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-1">Question</span>
          <span class="text-2xl font-bold text-gray-800">
            <span id="q-current" class="text-[#00B4D8]">1</span><span class="text-gray-300 mx-1">/</span>10
          </span>
        </div>
        <div class="text-right">
          <span class="text-xs font-bold text-gray-400 uppercase tracking-wider block mb-1">Time</span>
          <div class="flex items-center justify-end text-[#FCA311] font-bold text-xl font-mono">
            <i class="far fa-clock mr-2"></i> <span id="timer-text">30</span>
          </div>
        </div>
      </div>

      <div class="w-full h-2 bg-gray-100 rounded-full mb-8 overflow-hidden">
        <div id="timer-bar" class="h-full bg-[#FCA311] w-full timer-line rounded-full"></div>
      </div>

      <div class="mb-8">
        <span id="q-code" class="inline-block mb-3 text-[11px] text-gray-400 font-bold bg-gray-100 px-2 py-1 rounded">CODE: --</span>
        <h2 id="q-text" class="text-xl md:text-2xl font-bold leading-relaxed text-gray-700">Initializing...</h2>
      </div>

      <div id="options-container" class="grid grid-cols-1 gap-3">
        </div>
    </div>

    <div id="results-screen" class="hidden fade-in w-full">
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-blue-50 text-[#00B4D8] mb-4 shadow-sm">
                <i class="fas fa-trophy text-4xl"></i>
            </div>
            <h2 class="text-3xl font-bold mb-2 text-gray-800">Quiz Completed!</h2>
            
            <div class="my-6">
                <span id="score-display" class="text-6xl font-extrabold text-[#00B4D8]">--/10</span>
            </div>
            <p id="score-message" class="text-sm font-bold text-gray-500 uppercase tracking-wide bg-gray-100 py-2 px-4 rounded-full inline-block"></p>
            
            <div class="mt-8">
                <button onclick="window.location.reload()" class="btn-primary px-8 py-3 text-sm font-bold uppercase tracking-wide">
                   <i class="fas fa-redo mr-2"></i> Try Again
                </button>
            </div>
        </div>

        <div class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 pb-2 border-b border-gray-100">
            Review Your Answers
        </div>
        
        <div id="feedback-list" class="custom-scrollbar max-h-[300px] overflow-y-auto pr-2 space-y-3">
            </div>
    </div>
    
  </div>

  <script>
    // --- 粒子設定：清新、互動、活力 (Fresh Tech) ---
    function initParticles() {
      try {
        tsParticles.load({
          id: "tsparticles",
          options: {
            background: { opacity: 0 }, // 背景透明，由 CSS body 控制顏色
            particles: {
                number: {
                    value: 60,
                    density: { enable: true, value_area: 800 }
                },
                color: { value: "#00B4D8" }, // 粒子顏色：主色調藍色
                shape: { type: "circle" },
                opacity: {
                    value: 0.6,
                    random: false
                },
                size: {
                    value: 4,
                    random: true
                },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: "#90e0ef", // 連線顏色：淺藍
                    opacity: 0.4,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 2.5, // 速度加快，更有活力
                    direction: "none",
                    random: false,
                    straight: false,
                    out_mode: "out",
                    bounce: false
                }
            },
            interactivity: {
                detect_on: "canvas",
                events: {
                    onhover: {
                        enable: true,
                        mode: "repulse" // 滑鼠互動：排斥效果
                    },
                    onclick: {
                        enable: true,
                        mode: "push"
                    },
                    resize: true
                },
                modes: {
                    repulse: {
                        distance: 100,
                        duration: 0.4
                    }
                }
            },
            retina_detect: true
          }
        });
      } catch(e){}
    }
    document.addEventListener('DOMContentLoaded', initParticles);

    // --- 邏輯核心 (完全保留原有邏輯) ---
    const CSV_URL = 'https://ducj-creator.github.io/Teacher-Shirley/tests/CAP%20PP.csv';
    const QUESTION_LIMIT = 10;
    const TIME_LIMIT = 30; 
    
    let allQuestions = [];
    let currentSession = {
      questions: [],
      userAnswers: [],
      currentIndex: 0,
      timer: null,
      timeLeft: TIME_LIMIT
    };

    function initiateQuizLoad() {
      const startScreen = document.getElementById('start-screen');
      const loadingScreen = document.getElementById('loading-screen');
      
      startScreen.classList.add('hidden');
      loadingScreen.classList.remove('hidden');

      const url = CSV_URL + "?v=" + Date.now();

      PapaParse.parse(url, {
        download: true, header: true, skipEmptyLines: true,
        complete: function(results) {
          if (!results.data || results.data.length === 0) {
            alert("No data found."); window.location.reload(); return;
          }
          allQuestions = results.data.map((row, index) => {
            return {
              originalIndex: index,
              code: `${row['Year']}-${row['No.']}`,
              text: row['Question'],
              options: [row['Option A'], row['Option B'], row['Option C'], row['Option D']],
              correctAnswer: row['Correct Answer'],
            };
          }).filter(q => q.text && q.correctAnswer);

          setTimeout(() => {
            loadingScreen.classList.add('hidden');
            startActualQuiz();
          }, 800);
        },
        error: function(err) {
          alert("Load Error: " + err.message); window.location.reload();
        }
      });
    }

    function startActualQuiz() {
      let pool = [...allQuestions];
      shuffleArray(pool);
      currentSession.questions = pool.slice(0, QUESTION_LIMIT);
      currentSession.userAnswers = new Array(currentSession.questions.length).fill(null);
      currentSession.currentIndex = 0;

      document.getElementById('quiz-screen').classList.remove('hidden');
      loadQuestion(0);
    }

    function loadQuestion(index) {
      clearInterval(currentSession.timer);
      currentSession.currentIndex = index;
      currentSession.timeLeft = TIME_LIMIT;

      if (index >= currentSession.questions.length) {
        showResults();
        return;
      }
      
      const qData = currentSession.questions[index];
      
      document.getElementById('q-current').innerText = index + 1;
      document.getElementById('q-code').innerText = qData.code;
      document.getElementById('q-text').innerText = qData.text;

      const timerBar = document.getElementById('timer-bar');
      document.getElementById('timer-text').innerText = `${TIME_LIMIT}`;
      timerBar.style.transition = 'none';
      timerBar.style.width = '100%';
      void timerBar.offsetWidth; 
      timerBar.style.transition = 'width 1s linear';
      
      const optsContainer = document.getElementById('options-container');
      optsContainer.innerHTML = '';
      const letters = ['A', 'B', 'C', 'D'];
      
      qData.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        // 選項按鈕結構
        btn.className = `option-btn w-full text-left p-4 flex items-center group relative overflow-hidden`;
        btn.innerHTML = `
          <span class="font-bold text-sm text-[#00B4D8] bg-blue-50 w-8 h-8 flex items-center justify-center rounded-full mr-4 group-hover:bg-[#00B4D8] group-hover:text-white transition-colors">${letters[idx]}</span>
          <span class="flex-1 text-base font-medium text-gray-600 group-hover:text-gray-800">${opt}</span>
        `;
        btn.onclick = () => handleAnswer(idx);
        optsContainer.appendChild(btn);
      });
      
      startTimer();
    }
    
    function startTimer() {
      const timerBar = document.getElementById('timer-bar');
      const timerText = document.getElementById('timer-text');
      const update = () => {
        currentSession.timeLeft--;
        timerText.innerText = `${currentSession.timeLeft}`;
        timerBar.style.width = `${(currentSession.timeLeft / TIME_LIMIT) * 100}%`;
        
        if (currentSession.timeLeft <= 0) {
          handleAnswer(null); 
        }
      };
      currentSession.timer = setInterval(update, 1000);
    }
    
    function handleAnswer(choiceIdx) {
      clearInterval(currentSession.timer);
      const qIndex = currentSession.currentIndex;
      const qData = currentSession.questions[qIndex];
      const letters = ['A', 'B', 'C', 'D'];
      const userLetter = choiceIdx !== null ? letters[choiceIdx] : 'TIME OUT';
      
      currentSession.userAnswers[qIndex] = userLetter;

      const buttons = document.getElementById('options-container').children;
      Array.from(buttons).forEach((btn, idx) => {
        btn.onclick = null;
        const letter = letters[idx];
        if (letter === qData.correctAnswer) btn.classList.add('correct');
        else if (idx === choiceIdx) btn.classList.add('incorrect');
        
        if (letter === qData.correctAnswer && choiceIdx === null) {
             btn.classList.add('correct');
        }
      });

      setTimeout(() => loadQuestion(qIndex + 1), 1200);
    }

    function showResults() {
      document.getElementById('quiz-screen').classList.add('hidden');
      document.getElementById('results-screen').classList.remove('hidden');

      let correct = 0;
      const list = document.getElementById('feedback-list');
      list.innerHTML = '';

      currentSession.questions.forEach((q, i) => {
        const ans = currentSession.userAnswers[i];
        const isOk = ans === q.correctAnswer;
        if (isOk) correct++;

        const div = document.createElement('div');
        // 檢討卡片樣式 - 清新版
        div.className = `p-4 mb-2 rounded-xl border-l-4 ${isOk ? 'border-emerald-400 bg-emerald-50' : 'border-rose-400 bg-rose-50'}`;
        
        const highlightedText = q.text.replace(/_{2,}/g, `<span class="text-[#00B4D8] font-bold border-b-2 border-[#00B4D8] px-1">${q.correctAnswer}</span>`);

        div.innerHTML = `
          <div class="flex justify-between text-[11px] font-bold mb-2 text-gray-400">
            <span>${q.code}</span>
            <span class="${isOk?'text-emerald-500':'text-rose-500'} bg-white px-2 py-0.5 rounded shadow-sm">${isOk?'CORRECT':ans}</span>
          </div>
          <p class="text-sm font-medium text-gray-700 leading-relaxed">${highlightedText}</p>
          ${!isOk ? `<p class="text-xs text-emerald-600 mt-2 font-bold bg-white inline-block px-2 py-1 rounded border border-emerald-100"><i class="fas fa-check mr-1"></i>Answer: ${q.correctAnswer}</p>` : ''}
        `;
        list.appendChild(div);
      });

      document.getElementById('score-display').innerText = `${correct} / ${QUESTION_LIMIT}`;
      const msg = correct === 10 ? 'Perfect Score! Amazing!' : (correct >= 6 ? 'Great Job! Keep it up!' : 'Good Effort! Lets Review.');
      document.getElementById('score-message').innerText = msg;
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }
  </script>
</body>
</html>
