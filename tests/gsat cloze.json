<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley's GSAT Cloze Practice</title>
    <style>
        :root {
            --primary-color: #34495e; 
            --secondary-color: #F4F7F9; 
            --text-color: #333333; 
            --light-blue: #4ac29a; 
            --border-color: #E0E6EB;
            --success-color: #28A745; 
            --error-color: #DC3545; 
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --dark-background: #2c3e50; 
            --header-light-color: #4ac29a; 
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* V15.0: ç¢ºä¿ HTML å’Œ Body å¯ä»¥æ­£å¸¸æ»¾å‹• */
        html, body {
            height: 100%;
            min-height: 100vh; /* ç¢ºä¿è‡³å°‘æœ‰ä¸€å€‹è¦–çª—é«˜åº¦ */
        }

        body {
            font-family: 'Times New Roman', serif, 'Noto Sans TC', sans-serif;
            line-height: 1.7;
            color: var(--text-color);
            background-color: var(--secondary-color);
            /* ç§»é™¤ min-height: 100vh; å› ç‚ºå·²ç¶“åœ¨ body/html è¨­ç½®äº† */
        }
        
        .header {
            background-color: var(--dark-background); 
            padding: 40px 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .header h1 {
            color: white;
            font-size: 2.8em;
            margin-bottom: 5px;
            font-weight: 800;
            text-shadow: 0 0 5px var(--header-light-color), 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .header h1 span {
             color: var(--header-light-color); 
        }

        .subtitle {
            font-size: 1em;
            color: #C0C0C0;
            margin-top: 10px;
        }
        
        .quiz-selector-bar {
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(8px); 
            border-radius: 8px;
            max-width: 1400px;
            margin: -30px auto 20px; 
            padding: 18px 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative; 
            z-index: 10;
            color: white; 
        }

        .quiz-selector-controls label {
            font-weight: bold;
            color: white; 
            margin-right: 15px;
            font-size: 1.1em;
        }
        
        #quiz-selector {
            padding: 8px 15px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background-color: rgba(255, 255, 255, 0.9); 
            color: var(--text-color); 
            font-size: 1em;
            cursor: pointer;
            min-width: 250px;
        }
        
        #score-display {
             font-weight: bold; 
             color: var(--header-light-color); 
             font-size: 1.2em;
        }

        .quiz-container {
            display: flex;
            max-width: 1400px;
            margin: 0px auto 20px;
            padding: 0 15px;
            gap: 20px;
            z-index: 5;
            position: relative; 
        }

        .pane {
            flex: 1; 
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow);
            
            /* å·¦å´æ¬„ä½çš„æ»¾å‹•è¨­å®š */
            overflow-y: auto; 
            max-height: calc(100vh - 180px); /* é™åˆ¶å·¦å´é«˜åº¦ï¼Œè®“å…¶å…§éƒ¨æ»¾å‹• */
        }
        
        .questions-pane {
             /* å³å´æ¬„ä½ï¼šå…è¨±å…¶å…§å®¹å»¶ä¼¸ï¼Œè§¸ç™¼é é¢æ»¾å‹• */
             max-height: none; 
             overflow-y: visible;
        }

        .reading-pane {
            /* V15.0: ç¢ºä¿å·¦å´å›ºå®šåœ¨æ»¾å‹•é é¢æ™‚ä¸æœƒç§»å‹• */
            position: sticky; 
            top: 20px;
        }
        
        .pane-title {
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        #passage-content {
            white-space: normal; 
            line-height: 1.7; 
            text-align: justify; 
            padding-bottom: 20px; 
        }
        
        #passage-content p {
            margin-bottom: 1.2em; 
            text-indent: 0;
            line-height: 1.7;
        }
        
        /* ç¨ç«‹é¸é …åˆ—è¡¨æ¨£å¼ (åˆ†å…©æ¬„ï¼Œç·Šæ¹Šé¡¯ç¤º) */
        .options-list-container {
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            background-color: var(--secondary-color);
        }
        .options-list {
            display: grid;
            grid-template-columns: 1fr 1fr; /* åˆ†æˆå…©æ¬„ */
            gap: 5px 15px; /* è¡Œé–“è·å’Œæ¬„é–“è· */
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.95em;
        }
        .options-list li {
            line-height: 1.3; /* ç·Šæ¹Šè¡Œé«˜ */
        }

        /* é¡Œç›®æ¨£å¼èª¿æ•´ï¼Œç§»é™¤å¤šé¤˜ç©ºé–“ */
        .question {
            margin-bottom: 15px; /* é¡Œç›®é–“è·ç¸®å° */
            padding: 12px;
            border: 1px solid #EEEEEE; 
            border-radius: 6px;
        }
        .question-options label {
            display: inline-block; 
            margin-right: 12px; /* é¸é …é–“è·ç¸®å° */
            font-size: 0.95em;
        }
        
        .submit-container {
            padding: 20px 0;
            border-top: 1px solid var(--border-color);
            margin-top: 20px; 
            text-align: right; 
        }

        .submit-btn {
            background-color: var(--light-blue); 
            color: var(--dark-background);
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .correct { background-color: #EBF7E5; border-left: 5px solid var(--success-color); }
        .incorrect { background-color: #FEE7E8; border-left: 5px solid var(--error-color); }
        .correct-answer-mark { color: var(--success-color); }
        .blank-link { 
             color: var(--light-blue); 
             font-weight: bold; 
             text-decoration: none;
        }
        
        @media (max-width: 992px) {
            .quiz-container { flex-direction: column; margin: 10px auto; }
            .pane { max-height: none; overflow-y: visible; position: static; padding: 15px; }
            .options-list { grid-template-columns: 1fr; }
            .quiz-selector-bar { 
                margin: 10px auto; 
                flex-direction: column; 
                align-items: flex-start; 
                border-radius: 8px;
                backdrop-filter: none; 
                background-color: white; 
                color: var(--text-color); 
            }
            .quiz-selector-controls label { color: var(--primary-color); } 
            #score-display { color: var(--primary-color); margin-top: 10px; }
            .submit-container { text-align: center; }
            .submit-btn { width: 100%; }
            .quiz-selector-controls { margin-bottom: 10px; }
            #quiz-selector { width: 100%; min-width: auto; }
        }
    </style>
</head>
<body>

    <header class="header">
        <h1>Shirley's GSAT <span style="font-weight: 300;">Cloze Practice</span></h1>
        <p class="subtitle">Advanced Interactive Practice Engine (with acknowledgement of CEEC)</p>
    </header>

    <div class="quiz-selector-bar">
        <div class="quiz-selector-controls">
            <label for="quiz-selector">é¸æ“‡é¡Œçµ„:</label>
            <select id="quiz-selector">
                <option value="">è«‹å…ˆè¼‰å…¥...</option>
            </select>
        </div>
        <span id="score-display">å¾—åˆ†: 0 / 0</span>
    </div>

    <main id="quiz-container" class="quiz-container">
        <div id="reading-pane" class="pane reading-pane">
            <h2 class="pane-title">ğŸ“ é–±è®€ç¯‡ç« </h2>
            <div id="passage-content">
                æ­£åœ¨è¼‰å…¥æ–‡ç« ...
            </div>
        </div>

        <div id="questions-pane" class="pane questions-pane">
            <h2 class="pane-title">ğŸ¯ é¡Œç›®åˆ—è¡¨</h2>
            
            <div id="options-list-container" class="options-list-container" style="display:none;">
                <p style="font-weight: bold; margin-bottom: 8px;">é¸é …åˆ—è¡¨ (A-J):</p>
                <ul id="options-list" class="options-list">
                    </ul>
            </div>
            
            <form id="quiz-form">
                è«‹å¾ä¸Šæ–¹é¸æ“‡ä¸€å€‹é¡Œçµ„é–‹å§‹ç·´ç¿’ã€‚
            </form>
            
            <div class="submit-container">
                <button id="submit-btn" class="submit-btn" disabled>æ‰¹æ”¹èˆ‡æŸ¥çœ‹ç­”æ¡ˆ</button>
            </div>
        </div>
    </main>

    <footer>
        <p style="text-align: center; margin-top: 20px; color: #6c757d; font-size: 0.85em;">&copy; Shirley's Study Tools</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const jsonUrl = 'https://ducj-creator.github.io/Teacher-Shirley/tests/gsat%20cloze.json'; 
            const passageContent = document.getElementById('passage-content');
            const quizForm = document.getElementById('quiz-form');
            const submitBtn = document.getElementById('submit-btn');
            const scoreDisplay = document.getElementById('score-display');
            const quizSelector = document.getElementById('quiz-selector');
            const optionsListContainer = document.getElementById('options-list-container');
            const optionsList = document.getElementById('options-list');
            
            let allQuizzes = {}; 
            let currentQuizId = null;
            let isGraded = false;
            
            const optionKeys = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J']; 

            // (æ•¸æ“šè™•ç†é‚è¼¯ï¼Œä¿æŒä¸è®Š) ...
            function organizeQuizData(rawArray) {
                const quizzes = {};
                let currentPassageId = null;
                let currentQuestions = [];
                let currentPassageText = ''; 

                if (!Array.isArray(rawArray) || rawArray.length === 0) return {};

                rawArray.forEach(item => {
                    const hasPassageId = item.passage_id && item.passage_id.trim() !== '';
                    const hasQuestionId = item.question_id !== undefined && item.question_id !== null;
                    const itemText = item.Text || item.text || ''; 

                    if (hasPassageId) {
                        if (currentPassageId && currentQuestions.length > 0) {
                            quizzes[currentPassageId] = {
                                passage: currentPassageText,
                                questions: currentQuestions,
                                options: optionKeys
                            };
                        }
                        
                        currentPassageId = item.passage_id;
                        currentPassageText = itemText; 
                        currentQuestions = [];
                    } 
                    
                    if (hasQuestionId && currentPassageId) {
                        const question = {
                            question_id: item.question_id,
                            stem: `${item.question_id}.`, 
                            correct_answer: item.correct_answer 
                        };
                        currentQuestions.push(question);
                    }
                });

                if (currentPassageId && currentQuestions.length > 0) {
                    quizzes[currentPassageId] = {
                        passage: currentPassageText,
                        questions: currentQuestions,
                        options: optionKeys
                    };
                }
                
                return quizzes;
            }

            // (è¼‰å…¥å’Œæ§åˆ¶é‚è¼¯ï¼Œä¿æŒä¸è®Š) ...

            async function loadQuizData() {
                try {
                    const response = await fetch(jsonUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} (è«‹æª¢æŸ¥æª”æ¡ˆè·¯å¾‘æ˜¯å¦æ­£ç¢ºæˆ–æª”æ¡ˆæ˜¯å¦å­˜åœ¨)`);
                    }
                    
                    const rawArray = await response.json(); 
                    
                    allQuizzes = organizeQuizData(rawArray);

                    const quizIds = Object.keys(allQuizzes);
                    if (quizIds.length > 0) {
                        populateSelector(quizIds);
                        loadQuiz(quizIds[0]);
                    } else {
                        throw new Error('JSON è³‡æ–™è§£æå¾Œæ²’æœ‰ç™¼ç¾å¯ç”¨çš„é¡Œçµ„ã€‚è«‹æª¢æŸ¥æ‚¨çš„ JSON æª”æ¡ˆçµæ§‹ã€‚');
                    }
                    
                } catch (error) {
                    passageContent.innerHTML = `
                        <p style="color: var(--error-color);">âŒ è¼‰å…¥æˆ–è§£ææ¸¬é©—è³‡æ–™å¤±æ•—ã€‚</p>
                        <p>é€™é€šå¸¸æ˜¯ JSON æª”æ¡ˆè·¯å¾‘éŒ¯èª¤æˆ–æ ¼å¼éŒ¯èª¤ã€‚</p>
                        <p>éŒ¯èª¤è©³æƒ…: ${error.message}</p>
                    `;
                    console.error('Error loading quiz data:', error);
                    quizSelector.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                    submitBtn.disabled = true;
                    quizForm.innerHTML = 'è«‹æª¢æŸ¥å·¦å´çš„éŒ¯èª¤è¨Šæ¯ã€‚';
                }
            }
            
            function populateSelector(quizIds) {
                quizSelector.innerHTML = ''; 
                quizIds.forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `é¡Œçµ„ ${id}`;
                    quizSelector.appendChild(option);
                });
            }

            function loadQuiz(quizId) {
                currentQuizId = quizId;
                const quizData = allQuizzes[quizId];
                
                isGraded = false;
                submitBtn.textContent = 'æ‰¹æ”¹èˆ‡æŸ¥çœ‹ç­”æ¡ˆ';
                clearSavedAnswers(); 

                const { passageText, optionsText } = extractOptions(quizData.passage);
                
                renderPassage(passageText);
                renderOptionsList(optionsText); 
                renderQuestions(quizData.questions, quizData.options); 
                updateScoreDisplay(0, quizData.questions.length);
                quizSelector.value = quizId;
                submitBtn.disabled = false;
            }

            quizSelector.addEventListener('change', (e) => {
                const newQuizId = e.target.value;
                if (newQuizId) {
                    loadQuiz(newQuizId);
                }
            });

            // V14.0 æå–é¸é …
            function extractOptions(fullText) {
                const optionRegex = /(\s*\([A-J]\)\s*.*)+$/i; 
                
                const match = fullText.match(optionRegex);
                
                if (match) {
                    const optionsText = match[0].trim();
                    const passageText = fullText.substring(0, fullText.length - match[0].length).trim();
                    return { passageText, optionsText };
                }
                
                return { passageText: fullText, optionsText: null };
            }

            // V14.0 æ¸²æŸ“æ–‡ç« 
            function renderPassage(passageText) {
                
                let formattedText = passageText.trim()
                    .replace(/\s+/g, ' '); 

                formattedText = formattedText.replace(/\\n\s*\\n+/g, '</p><p>'); 
                formattedText = formattedText.replace(/\\n/g, ' '); 

                formattedText = formattedText.replace(
                    /\[(\d{1,3})\]/g, 
                    (match, qid) => `<a href="#q${qid}" class="blank-link" data-qid="${qid}">[${qid}]</a>`
                );
                
                if (formattedText) {
                    if (!formattedText.startsWith('<p>')) {
                         formattedText = '<p>' + formattedText;
                    }
                    if (!formattedText.endsWith('</p>')) {
                         formattedText = formattedText + '</p>';
                    }
                } else {
                    formattedText = '<p>æ–‡ç« å…§å®¹è¼‰å…¥éŒ¯èª¤ã€‚</p>';
                }

                passageContent.innerHTML = formattedText;
            }

            // V14.0 æ¸²æŸ“é¸é …åˆ—è¡¨
            function renderOptionsList(optionsText) {
                optionsList.innerHTML = '';
                
                if (!optionsText) {
                    optionsListContainer.style.display = 'none';
                    return;
                }
                
                optionsListContainer.style.display = 'block';
                
                const optionItems = optionsText.match(/\([A-J]\)[^()]+/g);
                
                if (optionItems) {
                    optionItems.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item.trim().replace(/\s+/g, ' ');
                        optionsList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = optionsText.trim().replace(/\s+/g, ' ');
                    optionsList.appendChild(li);
                }
            }


            function renderQuestions(questions, availableOptionKeys) {
                if (!questions || questions.length === 0) {
                    quizForm.innerHTML = 'æ­¤é¡Œçµ„æ²’æœ‰é¡Œç›®ã€‚';
                    return;
                }
                
                let questionHTML = '';
                questions.forEach(q => {
                    const qid = q.question_id;
                    const savedAnswer = localStorage.getItem(`${currentQuizId}_q${qid}_answer`);
                    let gradedClass = '';
                    if (isGraded) {
                         gradedClass = savedAnswer === q.correct_answer ? 'correct' : 'incorrect';
                    }

                    questionHTML += `
                        <div class="question ${gradedClass}" id="q${qid}" data-correct-answer="${q.correct_answer}">
                            <p class="question-stem"><strong>${q.stem || qid}</strong>. è«‹é¸æ“‡ (A-${availableOptionKeys[availableOptionKeys.length-1]}):</p>
                            <div class="question-options">
                                ${availableOptionKeys.map(key => `
                                    <label>
                                        <input type="radio" name="q${qid}" value="${key}" 
                                               ${isGraded ? 'disabled' : ''} 
                                               ${(savedAnswer && key === savedAnswer) ? 'checked' : ''}
                                               >
                                        ${key}
                                    </label>
                                `).join('')}
                            </div>
                            <div class="feedback feedback-message" id="feedback-q${qid}">
                                ${isGraded ? renderFeedback(q, savedAnswer) : ''}
                            </div>
                        </div>
                    `;
                });
                quizForm.innerHTML = questionHTML;
                
                if (!isGraded) {
                    quizForm.querySelectorAll('input[type="radio"]').forEach(input => {
                        input.addEventListener('change', (e) => {
                            localStorage.setItem(`${currentQuizId}_${e.target.name}_answer`, e.target.value); 
                        });
                    });
                }
            }
            
            function renderFeedback(q, userAnswer) {
                if (userAnswer === q.correct_answer) {
                    return '<span class="correct-answer-mark">âœ… ç­”å°äº†ï¼</span>';
                } else if (userAnswer) {
                    return `<span style="color: var(--error-color);">âŒ ç­”éŒ¯äº†ã€‚</span> æ­£ç¢ºç­”æ¡ˆæ˜¯ <span class="correct-answer-mark">${q.correct_answer}</span>`;
                } else {
                    return `<span style="color: var(--error-color);">æœªä½œç­”ã€‚</span> æ­£ç¢ºç­”æ¡ˆæ˜¯ <span class="correct-answer-mark">${q.correct_answer}</span>`;
                }
            }

            function updateScoreDisplay(correctCount, totalCount) {
                scoreDisplay.textContent = `å¾—åˆ†: ${correctCount} / ${totalCount}`;
            }
            
            function clearSavedAnswers() {
                const quizData = allQuizzes[currentQuizId];
                if (quizData && quizData.questions) {
                    quizData.questions.forEach(q => {
                        localStorage.removeItem(`${currentQuizId}_q${q.question_id}_answer`);
                    });
                }
            }

            submitBtn.addEventListener('click', () => {
                if (!currentQuizId || submitBtn.disabled) return;
                
                if (isGraded) {
                    loadQuiz(currentQuizId); 
                } else {
                    gradeQuiz(true); 
                    isGraded = true;
                    submitBtn.textContent = 'é‡æ–°ä½œç­”';
                }
            });

            function gradeQuiz(updateUI) {
                const quizData = allQuizzes[currentQuizId];
                if (!quizData) return;
                
                let correctCount = 0;
                const totalCount = quizData.questions.length;

                quizData.questions.forEach(q => {
                    const userAnswer = localStorage.getItem(`${currentQuizId}_q${q.question_id}_answer`);
                    if (userAnswer === q.correct_answer) {
                        correctCount++;
                    }

                    if (updateUI) {
                        const questionElement = document.getElementById(`q${q.question_id}`);
                        const feedbackElement = document.getElementById(`feedback-q${q.question_id}`);
                        
                        document.querySelectorAll(`input[name="q${q.question_id}"]`).forEach(input => input.disabled = true);

                        questionElement.classList.remove('correct', 'incorrect');
                        questionElement.classList.add(userAnswer === q.correct_answer ? 'correct' : 'incorrect');
                        feedbackElement.innerHTML = renderFeedback(q, userAnswer);
                    }
                });

                updateScoreDisplay(correctCount, totalCount);
            }
            
            passageContent.addEventListener('click', (event) => {
                if (event.target.classList.contains('blank-link')) {
                    event.preventDefault(); 
                    const qid = event.target.dataset.qid;
                    const targetQuestion = document.getElementById(`q${qid}`);
                    
                    if (targetQuestion) {
                        targetQuestion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        targetQuestion.style.boxShadow = '0 0 10px rgba(74, 194, 154, 0.6)'; 
                        setTimeout(() => {
                            targetQuestion.style.boxShadow = 'var(--box-shadow)';
                        }, 500);
                    }
                }
            });
            
            loadQuizData();
        });
    </script>
</body>
</html>
