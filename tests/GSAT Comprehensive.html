<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shirley's GSAT Comprehensive Practice</title>
    <style>
        /* å­¸è¡“é«˜ç´šé…è‰²æ–¹æ¡ˆ */
        :root {
            --primary-color: #1A3760; /* æ·±è—è‰²ï¼Œå­¸è¡“ã€å°ˆæ¥­ */
            --secondary-color: #F4F7F9; /* æ·ºç°è‰²èƒŒæ™¯ */
            --text-color: #333333; /* æ¨™æº–é»‘æ–‡å­— */
            --light-blue: #007BFF; /* è¼”åŠ©äº®è—è‰² */
            --border-color: #E0E6EB;
            --success-color: #28A745; 
            --error-color: #DC3545; 
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --dark-background: #0D213F; /* æ¥µæ·±è—ç”¨æ–¼æ¨™é ­èƒŒæ™¯ */
            --header-light-color: #A0C2FF; /* æ¨™é ­æ–‡å­—é«˜äº®è‰² */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Times New Roman', serif, 'Noto Sans TC', sans-serif;
            line-height: 1.7;
            color: var(--text-color);
            background-color: var(--secondary-color);
            min-height: 100vh;
        }

        /* æ¨™é ­ï¼šç»ç’ƒæ“¬æ…‹èƒŒæ™¯ */
        .header {
            background-color: var(--dark-background); 
            padding: 40px 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .header h1 {
            color: white;
            font-size: 2.8em;
            margin-bottom: 5px;
            font-weight: 800;
            /* æ–‡å­—å‡¸é¡¯æ•ˆæœ */
            text-shadow: 0 0 5px var(--header-light-color), 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .header h1 span {
             color: var(--header-light-color); /* å‡¸é¡¯ Practice */
        }

        .subtitle {
            font-size: 1em;
            color: #C0C0C0;
            margin-top: 10px;
        }
        
        /* ç¸½å…¥å£/é¡Œçµ„é¸æ“‡å€åŸŸï¼šç»ç’ƒæ¡†æ•ˆæœ (Glassmorphism) */
        .quiz-selector-bar {
            background: rgba(255, 255, 255, 0.1); /* åŠé€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(8px); /* ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
            border-radius: 8px;
            max-width: 1400px;
            margin: -30px auto 20px; /* å‘ä¸Šç–ŠåŠ åˆ°æ¨™é ­ä¸‹æ–¹ */
            padding: 18px 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            
            /* å…§å®¹ä½ˆå±€ */
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative; /* ç¢ºä¿é™°å½±å’Œç–ŠåŠ æ•ˆæœæ­£ç¢º */
            z-index: 10;
            color: white; /* å…§éƒ¨æ–‡å­—ç‚ºç™½è‰² */
        }

        .quiz-selector-controls label {
            font-weight: bold;
            color: white; /* æ¨™ç±¤ç‚ºç™½è‰² */
            margin-right: 15px;
            font-size: 1.1em;
        }
        
        #quiz-selector {
            padding: 8px 15px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background-color: rgba(255, 255, 255, 0.2); /* é¸æ“‡æ¡†ä¹ŸåŠé€æ˜ */
            color: var(--text-color); /* é¸æ“‡æ¡†å…§æ–‡å­—æ·±è‰² */
            font-size: 1em;
            cursor: pointer;
            min-width: 250px;
        }
        
        #score-display {
             font-weight: bold; 
             color: var(--header-light-color); /* åˆ†æ•¸å‡¸é¡¯ */
             font-size: 1.2em;
        }


        /* æ ¸å¿ƒå®¹å™¨ - éŸ¿æ‡‰å¼ä½ˆå±€ */
        .quiz-container {
            display: flex;
            max-width: 1400px;
            margin: 0px auto 20px;
            padding: 0 15px;
            gap: 20px;
            z-index: 5;
            position: relative; 
        }

        /* å·¦å³åˆ†æ¬„æ¨£å¼ */
        .pane {
            flex: 1; 
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: var(--box-shadow);
            overflow-y: auto; 
            max-height: calc(100vh - 180px); 
        }
        
        .reading-pane {
            position: sticky; 
            top: 20px;
        }
        
        .pane-title {
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* é–±è®€ç¯‡ç« æ¨£å¼ */
        #passage-content p {
            margin-bottom: 1em;
            text-align: justify;
            line-height: 1.8;
            text-indent: 2em; 
        }

        /* é¡Œç›®å€åŸŸæ¨£å¼ */
        .header-tools {
            display: none; 
        }
        
        /* å–®å€‹é¡Œç›® */
        .question {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #EEEEEE; 
            border-radius: 6px;
            transition: all 0.3s;
        }

        .question-options label {
            font-size: 0.95em;
        }
        
        /* æ‰¹æ”¹æŒ‰éˆ• (åº•éƒ¨) */
        .submit-container {
            padding: 20px 0;
            border-top: 1px solid var(--border-color);
            margin-top: 30px;
            text-align: right; 
        }

        .submit-btn {
            background-color: var(--light-blue); 
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .submit-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .correct { background-color: #EBF7E5; border-left: 5px solid var(--success-color); }
        .incorrect { background-color: #FEE7E8; border-left: 5px solid var(--error-color); }
        .correct-answer-mark { color: var(--success-color); }
        .blank-link { color: var(--light-blue); }

        /* æ‰‹æ©Ÿé©æ‡‰æ€§ (RWD) */
        @media (max-width: 992px) {
            .quiz-container { flex-direction: column; margin: 10px auto; }
            .pane { max-height: none; overflow-y: visible; position: static; padding: 15px; }
            .quiz-selector-bar { 
                margin: 10px auto; 
                flex-direction: column; 
                align-items: flex-start; 
                border-radius: 8px;
                backdrop-filter: none; /* æ‰‹æ©Ÿä¸Šç§»é™¤ç»ç’ƒæ•ˆæœä»¥ç°¡åŒ–ä½ˆå±€ */
                background-color: white;
                color: var(--text-color);
            }
            .quiz-selector-controls label { color: var(--primary-color); }
            #score-display { color: var(--primary-color); margin-top: 10px; }
            .submit-container { text-align: center; }
            .submit-btn { width: 100%; }
            .quiz-selector-controls { margin-bottom: 10px; }
            #quiz-selector { width: 100%; min-width: auto; }
        }
    </style>
</head>
<body>

    <header class="header">
        <h1>Shirley's GSAT <span style="font-weight: 300;">Comprehensive Practice</span></h1>
        <p class="subtitle">Advanced Interactive Practice Engine (with acknowledgement of CEEC)</p>
    </header>

    <div class="quiz-selector-bar">
        <div class="quiz-selector-controls">
            <label for="quiz-selector">é¸æ“‡é¡Œçµ„:</label>
            <select id="quiz-selector">
                <option value="">è«‹å…ˆè¼‰å…¥...</option>
            </select>
        </div>
        <span id="score-display">å¾—åˆ†: 0 / 0</span>
    </div>

    <main id="quiz-container" class="quiz-container">
        <div id="reading-pane" class="pane reading-pane">
            <h2 class="pane-title">ğŸ“ é–±è®€ç¯‡ç« </h2>
            <div id="passage-content">
                <p>æ­£åœ¨è¼‰å…¥æ–‡ç« ...</p>
            </div>
        </div>

        <div id="questions-pane" class="pane questions-pane">
            <div class="header-tools">
            </div>
            <h2 class="pane-title">ğŸ¯ é¡Œç›®åˆ—è¡¨</h2>
            <form id="quiz-form">
                <p>è«‹å¾ä¸Šæ–¹é¸æ“‡ä¸€å€‹é¡Œçµ„é–‹å§‹ç·´ç¿’ã€‚</p>
            </form>
            
            <div class="submit-container">
                <button id="submit-btn" class="submit-btn" disabled>æ‰¹æ”¹èˆ‡æŸ¥çœ‹ç­”æ¡ˆ</button>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p style="text-align: center; margin-top: 20px; color: #6c757d; font-size: 0.85em;">&copy; Teacher Shirley's Study Tools</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const jsonUrl = 'https://ducj-creator.github.io/Teacher-Shirley/tests/gsat%20conprehensive.json';
            const passageContent = document.getElementById('passage-content');
            const quizForm = document.getElementById('quiz-form');
            const submitBtn = document.getElementById('submit-btn');
            const scoreDisplay = document.getElementById('score-display');
            const quizSelector = document.getElementById('quiz-selector');
            
            let allQuizzes = {}; 
            let currentQuizId = null;
            let isGraded = false;

            // --- æ ¸å¿ƒè³‡æ–™çµæ§‹è½‰æ›é‚è¼¯ï¼šå¾æ‚¨çš„å¹³é‹ªé™£åˆ—ä¸­åˆ†çµ„ ---
            function organizeQuizData(rawArray) {
                const quizzes = {};
                let currentPassageId = null;
                let currentPassageText = '';
                let currentQuestions = [];

                if (!Array.isArray(rawArray)) return {};

                rawArray.forEach(item => {
                    const hasPassageId = item.passage_id && item.passage_id.trim() !== '';
                    const hasQuestionId = item.question_id !== undefined && item.question_id !== null;

                    if (hasPassageId && item.Text) {
                        if (currentPassageId && currentQuestions.length > 0) {
                            quizzes[currentPassageId] = {
                                passage: currentPassageText,
                                questions: currentQuestions
                            };
                        }
                        
                        currentPassageId = item.passage_id;
                        currentPassageText = item.Text;
                        currentQuestions = [];
                    } 
                    
                    if (hasQuestionId) {
                        const options = {};
                        if (item.option_A) options.A = item.option_A;
                        if (item.option_B) options.B = item.option_B;
                        if (item.option_C) options.C = item.option_C;
                        if (item.option_D) options.D = item.option_D;

                        currentQuestions.push({
                            question_id: item.question_id,
                            stem: `${item.question_id}.`, 
                            options: options,
                            correct_answer: item.correct_answer 
                        });
                    }
                });

                if (currentPassageId && currentQuestions.length > 0) {
                    quizzes[currentPassageId] = {
                        passage: currentPassageText,
                        questions: currentQuestions
                    };
                }

                return quizzes;
            }

            // è¼‰å…¥ JSON è³‡æ–™
            async function loadQuizData() {
                try {
                    const response = await fetch(jsonUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const rawArray = await response.json(); 
                    
                    allQuizzes = organizeQuizData(rawArray);

                    const quizIds = Object.keys(allQuizzes);
                    if (quizIds.length > 0) {
                        populateSelector(quizIds);
                        loadQuiz(quizIds[0]);
                    } else {
                        throw new Error('JSON è³‡æ–™è§£æå¾Œæ²’æœ‰ç™¼ç¾å¯ç”¨çš„é¡Œçµ„ã€‚');
                    }
                    
                } catch (error) {
                    passageContent.innerHTML = `<p style="color: var(--error-color);">éŒ¯èª¤ï¼šè¼‰å…¥æˆ–è§£ææ¸¬é©—è³‡æ–™å¤±æ•—ã€‚</p><p>è«‹æª¢æŸ¥æ‚¨çš„ JSON æª”æ¡ˆçµæ§‹ã€‚éŒ¯èª¤è©³æƒ…: ${error.message}</p>`;
                    console.error('Error loading quiz data:', error);
                    quizSelector.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>';
                    submitBtn.disabled = true;
                }
            }
            
            // å¡«å……é¡Œçµ„é¸æ“‡å™¨
            function populateSelector(quizIds) {
                quizSelector.innerHTML = ''; 
                quizIds.forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `é¡Œçµ„ ${id}`;
                    quizSelector.appendChild(option);
                });
            }

            // è¼‰å…¥ç‰¹å®šçš„é¡Œçµ„
            function loadQuiz(quizId) {
                currentQuizId = quizId;
                const quizData = allQuizzes[quizId];
                
                isGraded = false;
                submitBtn.textContent = 'æ‰¹æ”¹èˆ‡æŸ¥çœ‹ç­”æ¡ˆ';
                clearSavedAnswers(); 

                renderPassage(quizData.passage);
                renderQuestions(quizData.questions);
                updateScoreDisplay(0, quizData.questions.length);
                quizSelector.value = quizId;
                submitBtn.disabled = false;
            }

            // ç¶å®šé¡Œçµ„é¸æ“‡äº‹ä»¶
            quizSelector.addEventListener('change', (e) => {
                const newQuizId = e.target.value;
                if (newQuizId) {
                    loadQuiz(newQuizId);
                }
            });


            // --- UI æ¸²æŸ“å’Œäº’å‹•é‚è¼¯ ---

            function renderPassage(passageText) {
                const formattedText = passageText.replace(
                    /\[(\d{1,3})\]/g, 
                    (match, qid) => `<a href="#q${qid}" class="blank-link" data-qid="${qid}">[${qid}]</a>`
                );
                passageContent.innerHTML = `<p>${formattedText.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>')}</p>`;
            }

            function renderQuestions(questions) {
                if (!questions || questions.length === 0) {
                    quizForm.innerHTML = '<p>æ­¤é¡Œçµ„æ²’æœ‰é¡Œç›®ã€‚</p>';
                    return;
                }
                
                let questionHTML = '';
                questions.forEach(q => {
                    const qid = q.question_id;
                    const savedAnswer = localStorage.getItem(`${currentQuizId}_q${qid}_answer`);
                    let gradedClass = '';
                    if (isGraded) {
                         gradedClass = savedAnswer === q.correct_answer ? 'correct' : 'incorrect';
                    }

                    questionHTML += `
                        <div class="question ${gradedClass}" id="q${qid}" data-correct-answer="${q.correct_answer}">
                            <p class="question-stem"><strong>${q.stem || qid}</strong></p>
                            <div class="question-options">
                                ${Object.entries(q.options || {}).map(([key, value]) => `
                                    <label>
                                        <input type="radio" name="q${qid}" value="${key}" 
                                               ${isGraded ? 'disabled' : ''} 
                                               ${(savedAnswer && key === savedAnswer) ? 'checked' : ''}
                                               >
                                        ${key}. ${value}
                                    </label>
                                `).join('')}
                            </div>
                            <div class="feedback feedback-message" id="feedback-q${qid}">
                                ${isGraded ? renderFeedback(q, savedAnswer) : ''}
                            </div>
                        </div>
                    `;
                });
                quizForm.innerHTML = questionHTML;
                
                if (!isGraded) {
                    quizForm.querySelectorAll('input[type="radio"]').forEach(input => {
                        input.addEventListener('change', (e) => {
                            localStorage.setItem(`${currentQuizId}_${e.target.name}_answer`, e.target.value); 
                        });
                    });
                }
            }
            
            function renderFeedback(q, userAnswer) {
                if (userAnswer === q.correct_answer) {
                    return '<span class="correct-answer-mark">âœ… ç­”å°äº†ï¼</span>';
                } else if (userAnswer) {
                    return `<span style="color: var(--error-color);">âŒ ç­”éŒ¯äº†ã€‚</span> æ­£ç¢ºç­”æ¡ˆæ˜¯ <span class="correct-answer-mark">${q.correct_answer}</span>`;
                } else {
                    return `<span style="color: var(--error-color);">æœªä½œç­”ã€‚</span> æ­£ç¢ºç­”æ¡ˆæ˜¯ <span class="correct-answer-mark">${q.correct_answer}</span>`;
                }
            }

            function updateScoreDisplay(correctCount, totalCount) {
                scoreDisplay.textContent = `å¾—åˆ†: ${correctCount} / ${totalCount}`;
            }
            
            function clearSavedAnswers() {
                const quizData = allQuizzes[currentQuizId];
                if (quizData && quizData.questions) {
                    quizData.questions.forEach(q => {
                        localStorage.removeItem(`${currentQuizId}_q${q.question_id}_answer`);
                    });
                }
            }

            // æ‰¹æ”¹æŒ‰éˆ•äº‹ä»¶è™•ç†
            submitBtn.addEventListener('click', () => {
                if (!currentQuizId || submitBtn.disabled) return;
                
                if (isGraded) {
                    loadQuiz(currentQuizId); 
                } else {
                    gradeQuiz(true); 
                    isGraded = true;
                    submitBtn.textContent = 'é‡æ–°ä½œç­”';
                }
            });

            // æ‰¹æ”¹é‚è¼¯
            function gradeQuiz(updateUI) {
                const quizData = allQuizzes[currentQuizId];
                if (!quizData) return;
                
                let correctCount = 0;
                const totalCount = quizData.questions.length;

                quizData.questions.forEach(q => {
                    const userAnswer = localStorage.getItem(`${currentQuizId}_q${q.question_id}_answer`);
                    if (userAnswer === q.correct_answer) {
                        correctCount++;
                    }

                    if (updateUI) {
                        const questionElement = document.getElementById(`q${q.question_id}`);
                        const feedbackElement = document.getElementById(`feedback-q${q.question_id}`);
                        
                        document.querySelectorAll(`input[name="q${q.question_id}"]`).forEach(input => input.disabled = true);

                        questionElement.classList.remove('correct', 'incorrect');
                        questionElement.classList.add(userAnswer === q.correct_answer ? 'correct' : 'incorrect');
                        feedbackElement.innerHTML = renderFeedback(q, userAnswer);
                    }
                });

                updateScoreDisplay(correctCount, totalCount);
            }
            
            // è™•ç†æ–‡ç« ä¸­çš„é€£çµé»æ“Š
            passageContent.addEventListener('click', (event) => {
                if (event.target.classList.contains('blank-link')) {
                    event.preventDefault(); 
                    const qid = event.target.dataset.qid;
                    const targetQuestion = document.getElementById(`q${qid}`);
                    
                    if (targetQuestion) {
                        targetQuestion.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        targetQuestion.style.boxShadow = '0 0 10px rgba(0, 123, 255, 0.6)';
                        setTimeout(() => {
                            targetQuestion.style.boxShadow = 'var(--box-shadow)';
                        }, 500);
                    }
                }
            });
            
            // å•Ÿå‹•æ¸¬é©—
            loadQuizData();
        });
    </script>
</body>
</html>
